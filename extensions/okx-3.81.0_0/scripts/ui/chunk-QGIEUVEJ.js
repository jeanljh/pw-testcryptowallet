import{a as W,b as $,c as J,d as Q,e as V,f as X,h as Y,i as Z,j as G,k as K,l as tt,n as et,o as _}from"./chunk-Z62JX42S.js";import{f as P,g as I}from"./chunk-COF7YKSN.js";import{b as z}from"./chunk-73B6GL3S.js";import{f as l,o as d,q as h}from"./chunk-Y5OH3DDZ.js";d();h();d();h();I();var x=!1,y=new Map;async function O(r,t,e){let{uiData:n}=await P.get("uiData"),m=n?.[r];m?.timer&&clearTimeout(m.timer);let i;t&&t>-1&&(i=+setTimeout(async()=>{let{uiData:f}=await P.get("uiData");f?.[r]&&(delete n?.[r],y.delete(r),await P.set({uiData:n}))},t));let s={...e,timer:i};return y.set(r,s),P.set({uiData:{...n??{},[r]:s}})}async function v(r){let t=y.get(r);if(t)return t;let{uiData:e}=await P.get("uiData"),n=e?.[r];return!x&&e&&(Object.entries(e).forEach(([m,i])=>{y.set(m,i)}),x=!0),n}d();h();var H=l(J()),j=l(Y()),M=l(Z()),B=l(G()),E=l(K()),L=l(tt()),N=l(et());d();h();var R=l(z()),S=l(_()),b=l(Q()),w=l(V()),T=l(X());var at=(r,{cacheKey:t,cacheTime:e=5*60*1e3,staleTime:n=0,setCache:m,getCache:i})=>{let s=(0,R.useRef)(),f=(0,R.useRef)(),a=async(o,u)=>{m?await m(u):(0,b.setCache)(o,e,u),(0,T.trigger)(o,u.data)},g=(o,u=[])=>i?i(u):(0,b.getCache)(o);return(0,S.useCreation)(async()=>{if(!t)return;let o=await g(t);o&&Object.hasOwnProperty.call(o,"data")&&(r.state.data=o.data,r.state.params=o.params,(n===-1||new Date().getTime()-o.time<=n)&&(r.state.loading=!1)),s.current=(0,T.subscribe)(t,u=>{r.setState({data:u})})},[]),(0,S.useUnmount)(()=>{s.current?.()}),t?{onBefore:async o=>{let u=await g(t,o);return!u||!Object.hasOwnProperty.call(u,"data")?{}:n===-1||new Date().getTime()-u.time<=n?{loading:!1,data:u?.data,error:void 0,returnNow:!0}:{data:u?.data,error:void 0}},onRequest:(o,u)=>{let p=(0,w.getCachePromise)(t);return p&&p!==f.current?{servicePromise:p}:(p=o(...u),f.current=p,(0,w.setCachePromise)(t,p),{servicePromise:p})},onSuccess:async(o,u)=>{t&&(s.current?.(),await a(t,{data:o,params:u,time:new Date().getTime()}),s.current=(0,T.subscribe)(t,p=>{r.setState({data:p})}))},onMutate:o=>{t&&(s.current?.(),a(t,{data:o,params:r.state.params,time:new Date().getTime()}),s.current=(0,T.subscribe)(t,u=>{r.setState({data:u})}))}}:{}},A=at;d();h();var q=l($()),c=l(_());d();h();var F=l(W());var C=class{constructor(t,e,n,m={}){this.serviceRef=t;this.options=e;this.subscribe=n;this.initState=m;this.count=0;this.state={loading:!1,params:void 0,data:void 0,error:void 0};this.state={...this.state,loading:!e.manual,...m}}setState(t={}){this.state={...this.state,...t},this.subscribe()}async runPluginHandler(t,...e){let m=(await Promise.allSettled(this.pluginImpls.map(i=>i[t]?.(...e)))).filter(i=>i.status==="fulfilled").map(i=>i.value).filter(Boolean);return Object.assign({},...m)}async runAsync(...t){this.count+=1;let e=this.count,{stopNow:n=!1,returnNow:m=!1,...i}=await this.runPluginHandler("onBefore",t);if(n)return new Promise(()=>{});if(this.setState({loading:!0,params:t,...i}),m)return Promise.resolve(i.data);this.options.onBefore?.(t);try{let{servicePromise:s}=await this.runPluginHandler("onRequest",this.serviceRef.current,t);s||(s=this.serviceRef.current(...t));let f=await s;return e!==this.count?await new Promise(()=>{}):(this.setState({data:f,error:void 0,loading:!1}),this.options.onSuccess?.(f,t),this.runPluginHandler("onSuccess",f,t),this.options.onFinally?.(t,f,void 0),e===this.count&&this.runPluginHandler("onFinally",t,f,void 0),f)}catch(s){if(e!==this.count)return new Promise(()=>{});throw this.setState({error:s,loading:!1}),this.options.onError?.(s,t),this.runPluginHandler("onError",s,t),this.options.onFinally?.(t,void 0,s),e===this.count&&this.runPluginHandler("onFinally",t,void 0,s),s}}run(...t){this.runAsync(...t).catch(e=>{this.options.onError||console.error(e)})}cancel(){this.count+=1,this.setState({loading:!1}),this.runPluginHandler("onCancel")}refresh(){this.run(...this.state.params||[])}refreshAsync(){return this.runAsync(...this.state.params||[])}mutate(t){let e=(0,F.isFunction)(t)?t(this.state.data):t;this.runPluginHandler("onMutate",e),this.setState({data:e})}};function rt(r,t={},e=[]){let{manual:n=!1,...m}=t;q.default&&t.defaultParams&&!Array.isArray(t.defaultParams)&&console.warn(`expected defaultParams is array, got ${typeof t.defaultParams}`);let i={manual:n,...m},s=(0,c.useLatest)(r),f=(0,c.useUpdate)(),a=(0,c.useCreation)(()=>{let g=e.map(o=>o?.onInit?.(i)).filter(Boolean);return new C(s,i,f,Object.assign({},...g))},[]);return a.options=i,a.pluginImpls=e.map(g=>g(a,i)),(0,c.useMount)(()=>{if(!n){let g=a.state.params||t.defaultParams||[];a.run(...g)}}),(0,c.useUnmount)(()=>{a.cancel()}),{loading:a.state.loading,data:a.state.data,error:a.state.error,params:a.state.params||[],cancel:(0,c.useMemoizedFn)(a.cancel.bind(a)),refresh:(0,c.useMemoizedFn)(a.refresh.bind(a)),refreshAsync:(0,c.useMemoizedFn)(a.refreshAsync.bind(a)),run:(0,c.useMemoizedFn)(a.run.bind(a)),runAsync:(0,c.useMemoizedFn)(a.runAsync.bind(a)),mutate:(0,c.useMemoizedFn)(a.mutate.bind(a))}}var k=rt;function nt(r,t,e){return k(r,t,[...e||[],j.default,M.default,B.default,E.default,N.default,H.default,A,L.default])}var U=nt;function _t(r,t,e){let n=t?.cacheKey;return U(r,{...t??{},setCache:async m=>n?O(n,t?.cacheTime,m):!1,getCache:async()=>{if(n)return v(n)}},e)}export{_t as a};
//# sourceMappingURL=chunk-QGIEUVEJ.js.map
