import{a as v,c as X,d as Z}from"./chunk-XFPD3Q2E.js";import{R as Ce}from"./chunk-3ZKJXYZ4.js";import{a as oe,b as se}from"./chunk-PA7QUJH7.js";import{b as pe}from"./chunk-JWVIZID6.js";import{a as ge}from"./chunk-33XRMYWN.js";import{b as he,c as Ie}from"./chunk-M2YY6A5T.js";import{b as Q,h as me,ha as k}from"./chunk-2QHGKEME.js";import{k as ae,l as et}from"./chunk-YIFLUVTR.js";import{c as W,e as Ae}from"./chunk-EN2WHAVL.js";import{a as w,c as p,d as z}from"./chunk-EFOY37CC.js";import{b,c as ee}from"./chunk-GR7YC6C3.js";import{A as ne,E as _,J as re}from"./chunk-O33H5V3V.js";import{$b as fe,Ib as ce,Jb as le,M as x,N as te,Sb as ue,Zb as de,_b as nt,a as Y,b as Ze,nc as rt,rb as ie,tb as tt}from"./chunk-COF7YKSN.js";import{M as $,f as J,n as L,o as D,va as P,y as S,z as U}from"./chunk-XFTQD4B2.js";import{o as m,q as d}from"./chunk-Y5OH3DDZ.js";m();d();P();ee();m();d();te();async function j(e){return!Array.isArray(e)||e.length===0?!1:(await x.assets).set(e)}m();d();m();d();te();async function V(e){return!Array.isArray(e)||e.length===0?!1:(await Promise.resolve(x.balance)).set(e,{clear:!0})}async function q(e){try{return await(await Promise.resolve(x.balance)).get(e)}catch{return null}}async function ye(){try{return await(await Promise.resolve(x.balance)).getAll()}catch{return null}}async function St({accountId:e,coinId:t,balanceData:n,symbol:o,addressType:r,subBalanceType:s}){let a=await q(e);if(!a||a.walletId!==e)return!1;let c=a.coins.find(u=>s===1?u.symbol===o&&u.subBalanceType===s:u.coinId===t);if(!c)return null;if(c.childrenCoin){let u=c.childrenCoin.find(l=>s===2?l.addressType===r:l.coinId===t);if(u){if(u.coinAmount===n.coinAmount)return!1;Object.assign(u,n);let l={coinAmount:"0",coinAmountInt:"0",currencyAmountUSD:"0"};c.childrenCoin.forEach(g=>{l.coinAmount=p(l.coinAmount,g.coinAmount,{returnString:!0}),l.coinAmountInt=p(l.coinAmountInt,g.coinAmountInt,{returnString:!0}),l.currencyAmountUSD=p(l.currencyAmountUSD,g.currencyAmountUSD,{returnString:!0})}),Object.assign(c,l)}else return null}else{if(c.coinAmount===n.coinAmount)return!1;Object.assign(c,n)}return await V([a]),a}re();m();d();P();ee();re();m();d();et();Ze();var ot=ae({name:"balanceSlice",initialState:{balanceMap:{}},reducers:{setBalance:(e,t)=>{e.balanceMap=t.payload},setBalanceItem:(e,t)=>{e.balanceMap={...e.balanceMap,[t.payload.walletId]:t.payload}}}}),{actions:Se,reducer:st}=ot;function at(e){Y.captureEvent({message:"STORE_WARN_indexeddb_error",exception:{values:[{type:"STORE_WARN_indexeddb_error",value:e}]},level:"error"})}var kt=()=>async e=>{let t=await ye();if(!t||t.filter?.(o=>!o).length>0){at(`subscribe balance null, ${JSON.stringify(t)}`);return}let n=t.reduce((o,r)=>(o[r.walletId]=r,o),{});e(Se.setBalance(n))},{setBalance:we,setBalanceItem:Dt}=Se,Ut=st;m();d();m();d();P();function xe({balanceCoins:e,coinsMap:t,flatten:n=!1}){let o=[];return e.forEach(r=>{if(r.childrenCoin){let s=r.childrenCoin.map(a=>({...a,...t.get(a.coinId)}));n?o.push(...s):o.push({...r,...t.get(r.coinId),childrenCoin:s})}else o.push({...r,childrenCoin:void 0,...t.get(r.coinId)})}),o}var be=(e,t)=>{let n=e.coinBalanceDetails.map(o=>t.address===o.userAddress&&o.coinId===t.coinId?{...o,coinAmount:String(t.coinAmountOriginalDec),coinAmountOrigin:String(t.coinAmount),currencyAmount:String(t.currencyAmount)}:o);return{...e,coinBalanceDetails:n,coinAmount:n.reduce((o,r)=>p(o,r.coinAmount),"0"),coinAmountOrigin:n.reduce((o,r)=>p(o,r.coinAmountOrigin),"0"),currencyAmount:n.reduce((o,r)=>p(o,r.currencyAmount),"0"),symbol:t.symbol,name:t.name,imageUrl:t.logo}};async function We({pushData:e,store:t,walletId:n,account:o}){let r=D(t),s=S(t.data.assets,i=>i.walletId===n),a=S(t.data.assets[s].tokens,i=>U(i.coinBalanceDetails,u=>u.coinId===e.coinId));if(a===-1){let i=await Ce(e.subBalanceType===1?{aggregationSymbol:e.symbol}:{coinId:e.coinId},e,n,o);if(!i)return!1;r.data.coins.push(...i.coins);let c=t.data.assets[s].tokens.length;r.data.assets[s].tokens[c]=be(i.token,e)}else r.data.assets[s].tokens[a]=be(t.data.assets[s].tokens[a],e);return r}function Be({pushData:e,store:t}){let n=D(t),o=t.data.assets[0].nfts,{receive:r,reduce:s}=e,a=(r||s)?.collectionItem.chainId,i=S(o,c=>U(c.networkValuations,u=>u.chainId===a));return i===-1?r&&n.data.assets[0].nfts.push({networkValuations:[{chainId:a,name:r.collectionItem.name,valuation:w(r.count,r.collectionItem.floorSalePrice?.usdPrice??0)}]}):n.data.assets[0].nfts[i]={...t.data.assets[0].nfts[i],networkValuations:t.data.assets[0].nfts[i].networkValuations.map(c=>({...c,valuation:r?p(c.valuation,w(r.count,r.collectionItem.floorSalePrice?.usdPrice??0)):s&&z(c.valuation,w(s.count,s.collectionItem.floorSalePrice?.usdPrice??0))}))},n}function _e({pushData:e,store:t,walletId:n}){let o=D(t),r=S(t.data.assets,a=>a.walletId===n),s=S(t.data.assets[r].defis,a=>a.chainId===e.chainId&&a.platformId===e.analysisPlatformId);if(s!==-1){let{platform:a,network:i,url:c,web:u,logo:l,balance:g}=e;o.data.assets[r].defis[s]={...t.data.assets[r].defis[s],defiUrl:c,logo:l,platform:a,balance:g,web:u,network:i}}else o.data.assets[r].defis.push({accountId:n,balance:e.balance,chainId:e.chainId,chainName:e?.chainName,defiUrl:e.url,logo:e.logo,network:e.network,platform:e.platform,platformId:e.analysisPlatformId,walletId:n,web:e.web});return o.data.coins=t.data.coins.map(a=>!a.voucherToken&&U(e.lpTokenAddressList,i=>a.address?i.tokenAddress===a.address:i.chainId===a.chainId)?{...a,voucherToken:!0}:a),o}m();d();P();var T={};function M(){return T}function ke(e){T=e}function jt(e){return!T?.data?.assets||!e?!1:S(T.data.assets,n=>n&&n.walletId===e)!==-1}async function De({data:e,channel:t,walletId:n,account:o}){try{return t==="wallet-asset"?await We({pushData:e,store:M(),walletId:n,account:o}):t==="invest-DeFi"?_e({pushData:e?.data||e,store:M(),walletId:n}):Be({pushData:e,store:M(),walletId:n})}catch{return!1}}m();d();function Ue(e){let t=e.reduce((n,o)=>{let{chainId:r,currencyAmountUSD:s}=o;return n.has(r)?n.set(r,p(n.get(r),s)):n.set(r,s),n},new Map);return Array.from(t).map(([n,o])=>({chainId:n,currencyAmountUSD:o}))}function it(e,t,n){let{coinAmount:o,currencyAmount:r,coinAmountOrigin:s,...a}=e,i=t.get(e.coinId),c=n?.[e.coinId]?.coinToUSDRate;return{...a,coinAmount:o,coinAmountInt:s,currencyAmountUSD:c?w(o,c):r,baseCoinId:i.baseCoinId}}function Pe(e,t,n){return e.map(r=>{let{defis:s,nfts:a,tokens:i,accountId:c}=r,u=i?.map(f=>{let{coinAmountOrigin:I,coinBalanceDetails:C,currencyAmount:h,subBalanceType:B,imageUrl:$e,...ze}=f,N=C.map(F=>it(F,t,n)),Qe=N[0],G=B===1,K=B===2;return{...Qe,...ze,image:$e,currencyAmountUSD:N.reduce((F,Xe)=>p(F,Xe.currencyAmountUSD),"0"),coinAmountInt:I,aggregation:G,isAddressAggregation:K,childrenCoin:G||K?N:void 0}})??null,l=s?.map(f=>({currencyAmountUSD:f.balance,chainId:f.chainId}))??null,g=a?.reduce((f,I)=>f.concat(I.networkValuations||[]),[]).map(f=>({chainId:f.chainId,currencyAmountUSD:f.valuation}))??null;return{defi:l?Ue(l):null,nft:g?Ue(g):null,coins:u,walletId:c,v:2}})}function ve(e,t){let{coins:n,balanceData:o,walletId:r}=e,s=o?.coins??[],a=[];return s.forEach(i=>{if(i.childrenCoin){let c=[];i.childrenCoin.forEach(u=>{u.coinId===+t&&c.push(u)}),c.length>0&&(Object.assign(i,{...c[0],childrenCoin:c}),i.coinAmountInt=c.reduce((u,l)=>p(u,l.coinAmountInt),"0"),i.coinAmount=c.reduce((u,l)=>p(u,l.coinAmount),"0"),i.currencyAmountUSD=c.reduce((u,l)=>p(u,l.currencyAmountUSD),"0"),a.push(i))}else i.coinId===+t&&a.push(i)}),{walletId:r,balanceCoins:a,coins:n.filter(i=>i.coinId===+t)}}m();d();Ae();function y(e){return e?.keyring?.selectedWallet}function Te(e,t){let{createdMap:n}=e.metamask;return Boolean(n[t])}function Me(e){let{createdMap:t}=e.metamask;return Object.keys(t??{})}function O(e){return e.metamask.userUniqueId}function Oe(e,t){let{createdMap:n}=e.metamask;return n[t]||[]}function Ee(e,t){let{addedCoins:n}=e.metamask;return n[t]||[]}function Re(e,t){let{reducedCoins:n}=e.metamask;return n[t]||[]}async function Ne(){return W().getCustomCoins()}async function Fe(e,t){return W().setAllCoins(e,t)}async function Le(){try{let{data:e={}}=await ne(b.getCoinApyUrl);return e}catch{return{}}}function je(e,t){if(!t||Object.keys(t).length===0)return e;let n=new Map;return e.forEach((o,r)=>{let s=String(r),a=t[s];a?n.set(r,{...o,minApy:a.minApy,maxApy:a.maxApy,investmentId:a.investmentId,showOnHomepage:a.showOnHomepage}):n.set(r,o)}),n}async function Sn({accountIds:e,coinId:t,userUniqueId:n,currentAccountId:o,addressType:r}){let s={userUniqueId:n,accountIds:e,coinId:t};r&&(s.addressTypes=[r]);let{data:a={}}=await _(b.getCoinBalanceUrl,s,{walletSignParams:{needWalletSign:!0,walletId:o}}),i=a.coinBalanceDetails?.find(c=>$(r)?c.coinId===t:c.coinId===t&&c.addressType===parseInt(r,10));return i?{symbol:i.symbol,subBalanceType:a.subBalanceType,logo:i.imageUrl,name:i.name,addressType:i.addressType,voucherToken:!!i.isVoucher,coinId:i.coinId,tokenAddress:i.tokenAddress,address:i.userAddress,coinAmountOriginalDec:i.coinAmount,coinAmount:i.coinAmountOrigin,currencyAmount:i.currencyAmount}:null}function Ve(e,t,n=null){return async(o,r)=>{let s=r(),a=y(s),i=O(s);try{let c;n?.channel&&(c=await De({...n,walletId:a,account:k(s,a)}));let{data:u={}}=c||await _(b.newGetAllAssetsUrl,{userUniqueId:i,accountIds:e,combinationCoins:!0,chainIndexes:t?[t]:void 0},{walletSignParams:{needWalletSign:!0,walletId:a}}),l=u.coins??[],g=u.assets??[],f=new Map(l.map(h=>[h.coinId,me(h)]));ke({data:{coins:l,assets:g.filter(h=>h.walletId===a)}});let I=await pe(ge.coinTickers);return{assets:Pe(g,f,I),coinsMap:f}}catch(c){return se(c)}}}function E(e){return async t=>{let n={};e.forEach(o=>{n[o.walletId]=o});try{t(we(n)),await V(e)}catch{J()}}}m();d();rt();ue();m();d();Ae();ue();tt();m();d();nt();function qe(e,t){let n=[];return e.reduce((o,r)=>r.childrenCoin?o.concat(...r.childrenCoin):o.concat(r),[]).forEach(o=>{t&&de.includes(o.coinId)&&n.push(o)}),n}async function He(e,t,n={}){let{needSetDefault:o}=n,r=qe(e,o);r.length?W().updateWalletAddress(t,r.reduce((s,{coinId:a,userAddress:i})=>{let c=le({coinId:+a})?.localType,u=ie(c);return Object.entries(n.accountsMap[u]).forEach(([l,g])=>{g.address===i&&(s[u]=l)}),s},{}),{needUpdateBalance:!1,needUpdateSegwitAddressType:!0,needSync:!0,needEmitChangeAddress:!1}):o&&W().updateWalletAddress(t,{},{needUpdateBalance:!1,needUpdateSegwitAddressType:!0,needSync:!0,needEmitChangeAddress:!1})}function Ge({walletData:e,coinsMap:t}){return(n,o)=>{let r=o(),s=e.walletId,a=Oe(r,s),c=k(r,s)?.initialType===fe.SIMPLE_KEYRING,u=Ee(r,s),l=Re(r,s),{open:g,amount:f}=v(r);return X({isReady:!0,defaultBaseCoinsCoinIds:c?a||[]:[],addedCoins:u,reducedCoins:l,balanceCoins:xe({balanceCoins:e.coins,coinsMap:t,flatten:!1}),defi:e.defi,nft:e.nft,hiddenSmallAssets:g,smallAssetsAmount:f,networks:ce()})}}function H({coinsMap:e,walletData:t}){return async(n,o)=>{let r=o(),s=k(r,t.walletId);He(t.coins,t.walletId,s);let a=await Ne();y(r)===t.walletId&&(Fe(Array.from(e.values()),a),n(E([t])))}}var Ke=50,R=!1;function ct({apyPromise:e,walletsBalance:t,selectedWalletId:n,dispatch:o}){!e||e.then(async r=>{if(!r||Object.keys(r).length===0)return;let s=t.find(c=>c.walletId===n);if(!s)return;let a=new Map(s.coins.map(c=>[c.coinId,c])),i=je(a,r);o(H({coinsMap:i,walletData:s.balanceData}))}).catch(()=>{})}function Ye({walletIds:e,chainId:t,pushData:n}){return async(o,r)=>{let s=r(),a=[],i=!t,c=y(s),u=i?Le():null;return await Promise.all(L(e,Ke).map(async l=>{let{assets:g,coinsMap:f}=await o(Ve(l,t,n)),I=[];g.forEach(C=>{let{walletId:h}=C;if(i){let B=o(Ge({walletData:C,coinsMap:f}));B&&I.push({walletId:h,...B}),h===c&&o(H({coinsMap:f,walletData:C}))}a.push({walletId:h,coins:Array.from(f.values()),balanceData:C})}),i&&j(I)})),ct({apyPromise:u,walletsBalance:a,selectedWalletId:c,dispatch:o}),a}}function Je(e,t){return async(n,o)=>{let r=o(),s=t??y(r);if(!(!s||!Te(r,s))){try{await n(Ye({walletIds:[s],pushData:e}))}catch(i){let c=await q(s);throw await n(E([{...c??{},walletId:s,error:!0,v:2}])),i}if(Ie()){he();let i=setTimeout(()=>{n(Je()),clearTimeout(i)},2e3)}}}}function cr(e){return async(t,n)=>{let o=n();y(o)===e&&await t(Je())}}function lr({walletIds:e,chainId:t,coinId:n}){return async o=>{let r=await o(Ye({walletIds:e,chainId:t}));return r?.length?r.map(s=>ve(s,n)):null}}function ur(){return async(e,t)=>{if(R)return;let n=t();R=!0;let o=Me(n),r=y(n),s=Q(n),{open:a,amount:i}=v(n),c=a?Number(i):null,u=O(n);try{await Promise.all(L(o,Ke).map(async l=>{let{data:g=[]}=await _(b.getWalletManageAsset,{userUniqueId:u,accountIds:l,tinyThreshold:c,accountDetailList:l.map(C=>({accountId:C,filterCoinList:(s?.[C]??[]).map(h=>h.coinId)}))},{walletSignParams:{needWalletSign:!0,walletId:r}}),f=n.metamask.preferences.showNftAmount,I=g.map(C=>Z(C,f));j(I)})),R=!1}catch(l){throw R=!1,oe[l?.message]?new Error(l?.message):new Error(l)}}}export{St as a,kt as b,Dt as c,Ut as d,jt as e,Sn as f,Ye as g,Je as h,cr as i,lr as j,ur as k};
//# sourceMappingURL=chunk-QKBWJPY2.js.map
