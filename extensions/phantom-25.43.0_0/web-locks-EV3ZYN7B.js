import{a as M}from"./chunk-NUMCZRU4.js";import{a as i,b as T,d as A,i as p,n as k}from"./chunk-NSVULBS3.js";var O=A((C,P)=>{p();k();var{EventEmitter:D}=M(),K=T("worker_threads"),{isMainThread:L,parentPort:b}=K,q=!L,E=0,x=1,l=null,h=class{static{i(this,"Lock")}constructor(e,t="exclusive",s=null){this.name=e,this.mode=t,this.queue=[],this.owner=!1,this.trying=!1,this.buffer=s||new SharedArrayBuffer(4),this.flag=new Int32Array(this.buffer,0,1),s||Atomics.store(this.flag,0,x)}enter(e){return new Promise(t=>{this.queue.push({handler:e,resolve:t}),this.trying=!0,setTimeout(()=>{this.tryEnter()},0)})}tryEnter(){if(this.queue.length===0||Atomics.exchange(this.flag,0,E)===E)return;this.owner=!0,this.trying=!1;let{handler:t,resolve:s}=this.queue.shift();t(this).finally(()=>{this.leave(),s()})}leave(){if(!this.owner)return;Atomics.store(this.flag,0,x),this.owner=!1;let e={webLocks:!0,kind:"leave",name:this.name};l.send(e),this.tryEnter()}},a=class{static{i(this,"LockManagerSnapshot")}constructor(e){let t=[],s=[];this.held=t,this.pending=s;for(let n of e)n.queue.length>0&&s.push(...n.queue),n.owner&&t.push(n)}},f=class{static{i(this,"LockManager")}constructor(){this.collection=new Map,this.workers=new Set,q&&b.on("message",e=>{this.receive(e)})}async request(e,t,s){typeof t=="function"&&(s=t,t={});let{mode:n="exclusive",signal:c=null}=t,r=this.collection.get(e);if(!r){r=new h(e,n),this.collection.set(e,r);let{buffer:y}=r,u={webLocks:!0,kind:"create",name:e,mode:n,buffer:y};l.send(u)}let m=r.enter(s),v=null;c?(v=new Promise((y,u)=>{c.on("abort",u)}),await Promise.race([m,v])):await m,setTimeout(()=>{r.tryEnter()},0)}query(){let e=new a;return Promise.resolve(e)}attach(e){this.workers.add(e),e.on("message",t=>{for(let s of this.workers)s!==e&&s.postMessage(t);this.receive(t)})}send(e){if(q){b.postMessage(e);return}for(let t of this.workers)t.postMessage(e)}receive(e){if(!e.webLocks)return;let{kind:t,name:s,mode:n,buffer:c}=e;if(t==="create"){let r=new h(s,n,c);this.collection.set(s,r);return}if(t==="leave")for(let r of this.collection.values())r.name===s&&r.trying&&r.tryEnter()}},d=class extends Error{static{i(this,"AbortError")}constructor(e){super(e),this.name="AbortError"}},w=class extends D{static{i(this,"AbortSignal")}constructor(){super(),this.aborted=!1,this.on("abort",()=>{this.aborted=!0})}},g=class{static{i(this,"AbortController")}constructor(){this.signal=new w}abort(){let e=new d("The request was aborted");this.signal.emit("abort",e)}};l=new f;P.exports={locks:l,AbortController:g}});export default O();
//# sourceMappingURL=web-locks-EV3ZYN7B.js.map
