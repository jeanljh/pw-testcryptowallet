import{Ba as Qt,Ea as Yt,I as O,J as z,K as we,M as se,P as Ce,Y as Xt,za as Jt}from"./chunk-44NW6BSR.js";import{gc as Vt,ma as $t,n as Wt,rb as Gt}from"./chunk-COS4XKZ5.js";import{h as Ie,hb as Pe,sb as be,wc as Ee,zc as xe}from"./chunk-IJLITZAC.js";import{$c as zt,Ac as m,Pb as ne,Rb as L,Sb as At,Tc as Ht,Ub as _t,Vb as qt,Wb as P,X as re,aa as pe,ae as jt,h as Mt,i as vt,l as Lt,la as ye,m as Ot,n as Bt,pa as Nt,v as Ut,w as G,wc as w,x as de,xc as y}from"./chunk-GSVPXWLR.js";import{h as fe}from"./chunk-P42QO3R7.js";import{S as Kt,a as Tt,d as f,m as Z}from"./chunk-LYTSCHVN.js";import{h as C,k as v}from"./chunk-P5BPG5MC.js";import{g as o}from"./chunk-PPQ6BNOX.js";import{a,g as te,i as d,m as Buffer,n as p}from"./chunk-NSVULBS3.js";d();p();var Q=te(Tt());d();p();d();p();var U=o.string().regex(/^\d*\.?\d+$/,"Invalid numeric string"),ke=o.string().regex(/^-?\d*\.?\d+$/,"Invalid signed numeric string"),Zt=o.object({accountValue:ke,totalMarginUsed:U,totalNtlPos:U,totalRawUsd:ke}),$i=o.object({marginSummary:Zt,withdrawable:U,assetPositions:o.array(o.any()).optional(),crossMaintenanceMarginUsed:U.optional(),crossMarginSummary:Zt.optional(),guaranteedUntil:o.number().optional(),isAccountSolvent:o.boolean().optional(),pendingCashAdjusts:o.array(o.any()).optional(),totalCrossCollateral:U.optional(),totalIsolatedCollateral:U.optional(),totalMaintenanceMarginUsed:U.optional()}),es=o.object({coin:o.string(),side:o.enum(["B","A"]),limitPx:U,sz:U,oid:o.number(),timestamp:o.number(),origSz:U,cloid:o.string().optional()}),ji=o.array(es),Gs=o.object({position:es,status:o.string(),statusTimestamp:o.number()}),Gi=o.array(Gs),Vs=o.object({status:o.literal("ok"),response:o.object({type:o.string()}).optional()}),ts=o.object({error:o.string()}),Vi=o.union([Vs,ts]),Ks=o.enum(["withdraw","deposit"]),Xs=o.object({id:o.string(),type:Ks,timestamp:o.string(),delta:o.object({usdAmount:ke,token:o.object({caip19:o.string(),symbol:o.string(),image:o.string(),amount:ke})})}),Ki=o.array(Xs),Js=o.object({resting:o.object({oid:o.number()})}),Qs=o.object({filled:o.object({totalSz:U,avgPx:U,oid:o.number()})}),Ys=o.object({error:o.string()}),Zs=o.union([Js,Qs,Ys]),ei=o.object({status:o.literal("ok"),response:o.object({type:o.literal("order"),data:o.object({statuses:o.array(Zs)})})}),Xi=o.union([ei,ts]),ss=o.array(o.object({t:o.number(),T:o.number(),s:o.string(),i:o.string(),o:U,h:U,l:U,c:U,v:U,n:o.number()}));d();p();var ti=o.object({accountValue:O,availableBalance:O,availableToTrade:O}),is=o.object({accountValue:O,availableBalance:O,availableToTrade:O,dexAbstraction:o.boolean(),dexs:o.record(o.string(),ti).optional()});d();p();var si=o.enum(["withdrawal","deposit","reward"]),ii=o.object({id:o.string(),type:si,timestamp:o.number(),usdcAmount:z}),rs=o.object({depositAndWithdrawals:o.array(o.any()).transform(i=>i.reduce((e,t)=>{let s=ii.safeParse(t);return s.success&&e.push(s.data),e},[]))});d();p();var lr=o.enum(["success","failed"]),ur=o.enum(["close","liquidation","take_profit","stop_loss"]),gr=o.literal("open"),ns=o.object({id:o.string(),market:o.object({token:we,logoUri:o.string(),szDecimals:o.number().optional()}),type:o.string(),timestamp:o.number(),price:O,size:z,tradeValue:O,fee:z,closedPnl:o.optional(z)}),os=o.object({tradeHistory:o.array(ns).transform(i=>i.reduce((e,t)=>{let s=ns.safeParse(t);return s.success&&e.push(s.data),e},[]))});d();p();var cs=o.enum(["long","short"]),Fe=o.object({direction:cs,leverage:O,size:z,margin:O,entryPrice:O,fundingPayments:z,market:o.object({token:we,logoUri:o.string()}),value:O,unrealizedPnl:o.object({amount:z,percentage:z}),liquidationPrice:z}),ds=o.object({positions:o.array(Fe).transform(i=>i.reduce((e,t)=>{let s=Fe.safeParse(t);return s.success&&e.push(s.data),e},[]))}),as=o.object({id:o.string(),market:o.object({token:we,logoUri:o.string()}),isTrigger:o.boolean(),direction:cs,type:o.enum(["take_profit_market","stop_market","limit"]),reduceOnly:o.boolean(),triggerPrice:O,limitPrice:O,timestamp:O,size:z}),ps=o.object({positions:o.array(Fe).transform(i=>i.reduce((e,t)=>{let s=Fe.safeParse(t);return s.success&&e.push(s.data),e},[])),openOrders:o.array(as).transform(i=>i.reduce((e,t)=>{let s=as.safeParse(t);return s.success&&e.push(s.data),e},[]))});d();p();function F(i,e){return i+Math.random()*e}a(F,"getRetryDelayWithJitter");d();p();var ri=o.object({address:o.string(),registered:o.boolean()}),ni=o.object({code:o.string(),registered:o.boolean()}).optional(),hs=o.object({providerFee:o.string(),phantomFee:o.string(),referral:ni.optional(),builder:ri.optional()});d();p();var ls=o.object({depositAddress:o.object({address:o.string()}),requestId:o.string()}),oi=o.object({destinationAmount:o.string().optional(),sourceTxHash:o.string().optional(),state:o.enum(["done","sourceTxDiscovered","waitForSrcTxFinalization","buildingDstTx","signTx","broadcastTx","waitForDstTxFinalization","readyForWithdrawQueue","queuedForWithdraw","failure","additionalChecks"]),opCreatedAt:o.string().optional(),operationId:o.string().optional(),protocolAddress:o.string().optional(),sourceAddress:o.string().optional(),destinationAddress:o.string().optional(),sourceChain:o.string().optional(),destinationChain:o.string().optional(),sourceAmount:o.string().optional(),destinationFeeAmount:o.string().optional(),sweepFeeAmount:o.string().optional(),stateStartedAt:o.string().optional(),stateUpdatedAt:o.string().optional(),stateNextAttemptAt:o.string().optional(),destinationTxHash:o.string().optional(),asset:o.string().optional()}),us=o.object({usdcPrice:o.string(),orderAssetId:o.number(),operations:o.array(oi)}),gs=o.discriminatedUnion("status",[o.object({status:o.literal("ok"),response:o.object({type:o.string()})}),o.object({status:o.literal("err"),response:o.string()})]),ms=o.discriminatedUnion("status",[o.object({status:o.literal("ok"),response:o.object({type:o.string()})}),o.object({status:o.literal("err"),response:o.string()})]),fs=o.object({status:o.enum(["ok","err"])}),ys=o.object({name:o.string(),midPx:o.string()}),ai=o.object({unixTime:o.number(),value:o.string(),open:o.string(),high:o.string(),low:o.string(),close:o.string(),volume:o.string()}),Lr=o.object({history:o.array(ai)}),ws=o.object({role:o.enum(["missing","user"])}),Ss=o.object({fundingCaip19Address:At,spotAssetId:o.number(),spotTokenId:o.string(),spotTokenName:o.string(),spotSzDecimals:o.number(),eta:o.string(),fee:o.string(),minimumAmount:o.string()}),Ts=o.object({tokens:o.array(_t)}),X;(function(i){i.Hyperunit="hyperunit",i.Relay="relay"})(X||(X={}));var As=o.object({providers:o.array(o.object({name:o.nativeEnum(X),max:o.number(),initializingCaip19Address:o.optional(At)}))});var De=class{static{a(this,"PerpsClient")}async getSpotBridgeInitialize(e){let t=await C.api().retry(1,F(1e3,1e3)).get("/swap/v2/spot/bridge-initialize",{params:{...e,bridgeProvider:Kt(e.bridgeProvider.toString())}}),s=ls.safeParse(t.data);if(!s.success)throw new Error(`Failed to parse spot bridge initialize response: ${s.error}`);return s.data}async getOperations(e){let t=await C.api().retry(1,F(1e3,1e3)).get("/swap/v2/spot/bridge-operations",{params:e}),s=us.safeParse(t.data);if(!s.success)throw new Error(`Failed to parse operations response: ${s.error}`);return s.data}async getAccountBalance(e){let t=await C.api().retry(1,F(1e3,1e3)).get("/swap/v2/perp/balance",{params:{user:P(e)}});if(!v(t))throw new Error("Failed to get account balance: response is not okay");let s=t.data,r=is.safeParse(s);if(!r.success)throw new Error("Failed to get account balance: schema validation failed");return r.data}async getUserFundingHistory(e){let t=await C.api().retry(1,F(1e3,1e3)).get("/swap/v2/perp/deposits-and-withdrawals",{params:{user:P(e)}});if(!v(t))throw new Error("Failed to get deposits and withdrawals: response is not okay");let s=t.data,r=rs.safeParse(s);if(!r.success)throw new Error("Failed to get deposits and withdrawals: schema validation failed");return r.data.depositAndWithdrawals}async getPositions(e){let t=await C.api().retry(1,F(1e3,1e3)).get("/swap/v2/perp/positions",{params:{user:P(e)}});if(!v(t))throw new Error("Failed to get positions: response is not okay");let s=t.data,r=ds.safeParse(s);if(!r.success)throw new Error("Failed to get positions: schema validation failed");return r.data.positions}async getPositionsAndOpenOrders(e){let t=await C.api().retry(1,F(1e3,1e3)).get("/swap/v2/perp/positions-and-open-orders",{params:{user:P(e)}});if(!v(t))throw new Error("Failed to get positions: response is not okay");let s=t.data,r=ps.safeParse(s);if(!r.success)throw new Error("Failed to get positions: schema validation failed");return r.data}async getHistoricalOrders(e,t){let s={user:P(e)};t&&t.length>0&&(s.markets=t.join(","));let r=await C.api().retry(1,F(1e3,1e3)).get("/swap/v2/perp/trade-history",{params:s});if(!v(r))throw new Error("Failed to get historical orders: response is not okay");let n=r.data,c=os.safeParse(n);if(!c.success)throw new Error("Failed to get historical orders: schema validation failed");return c.data.tradeHistory}async postSpotSend(e){let t=await C.api().retry(1,F(1e3,1e3)).post("/swap/v2/spot/send",e);if(!v(t))throw new Error("Failed to post spot send: response is not okay");let s=t.data,r=gs.safeParse(s);if(!r.success)throw new Error("Failed to post spot send: schema validation failed");return r.data}async postPerpsSend(e){let t=await C.api().retry(1,F(1e3,1e3)).post("/swap/v2/perps/send",e);if(!v(t))throw new Error("Failed to post perps send: response is not okay");let s=t.data,r=ms.safeParse(s);if(!r.success)throw new Error("Failed to post perps send: schema validation failed");return r.data}async postTransferUsdcSpotPerp(e){let t=await C.api().retry(1,F(1e3,1e3)).post("/swap/v2/transfer-usdc-spot-perp",e);if(!v(t))throw new Error("Failed to post spot send: response is not okay");let s=t.data,r=fs.safeParse(s);if(!r.success)throw new Error("Failed to post spot send: schema validation failed");return r.data}async getTokenDetails(e){let t=await C.api().retry(1,F(1e3,1e3)).get("/swap/v2/spot/token-details",{params:{tokenId:e.tokenId,type:"tokenDetails"}});if(!v(t))throw new Error("Failed to get token info: response is not okay");let s=t.data,r=ys.safeParse(s);if(!r.success)throw new Error("Failed to get token info: schema validation failed");return r.data}async getUserRole(e){let t=await fetch("https://api.hyperliquid.xyz/info",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({type:"userRole",user:e})});if(!t.ok)throw new Error("Failed to get token info");let s=await t.json(),r=ws.safeParse(s);if(!r.success)throw new Error("Failed to get user role: schema validation failed");return r.data}async postFunding(e){let t=await C.api().retry(1,F(1e3,1e3)).post("/swap/v2/spot/funding",e);if(!v(t))throw new Error("Failed to get funding");let s=t.data,r=Ss.safeParse(s);if(!r.success)throw new Error("Failed to post funding: schema validation failed");return r.data}async getPriceHistory(e){let t={coin:e.coin,interval:e.interval,startTime:e.startTime.toString(),endTime:e.endTime.toString()};e.isTestnet&&(t.isTestnet="true");let s=await C.api().retry(1,F(1e3,1e3)).get("/swap/v2/candles",{params:t});if(!v(s))throw new Error("Failed to get price history: response is not okay");let r=s.data,n=ss.safeParse(r);if(!n.success)throw new Error("Failed to get price history: schema validation failed");return n.data}async getSpotBalances(e){let t=await C.api().retry(1,F(1e3,1e3)).get("/swap/v2/spot/balances",{params:e});if(!v(t))throw new Error("Failed to get spot balances: response is not okay");return t.data}async getPositionFees(e){let t=await C.api().retry(1,F(1e3,1e3)).get("/swap/v2/perp/fees",{params:{user:P(e)}});if(!v(t))throw new Error("Failed to get position fees: response is not okay");let s=t.data,r=hs.safeParse(s);if(!r.success)throw new Error("Failed to get position fees: schema validation failed");return r.data}async getBridgeableTokens(e){if(!e)throw new Error("No addresses provided to get bridgeable tokens");let t=await C.api().retry(1,F(1e3,1e3)).get("/swap/v2/spot/bridgeable-tokens",{params:{addresses:e.join(",")}});if(!v(t))throw new Error("Failed to get bridgeable tokens: response is not okay");let s=t.data,r=Ts.safeParse(s);if(!r.success)throw new Error("Failed to get bridgeable tokens: schema validation failed");return r.data}async getPreferredBridges(){let e=await C.api().retry(1,F(1e3,1e3)).get("/swap/v2/spot/preferred-bridges");if(!v(e))throw new Error("Failed to get preferred bridge: response is not okay");let t=e.data,s=As.safeParse(t);if(!s.success)throw new Error("Failed to get preferred bridge: schema validation failed");return s.data}};d();p();d();p();var R=[{name:"name",type:"string"},{name:"version",type:"string"},{name:"chainId",type:"uint256"},{name:"verifyingContract",type:"address"}];var Re=[{name:"hyperliquidChain",type:"string"},{name:"maxFeeRate",type:"string"},{name:"builder",type:"address"},{name:"nonce",type:"uint64"}],W=[{name:"source",type:"string"},{name:"connectionId",type:"bytes32"}];d();p();var ci=o.object({totalSz:o.string(),avgPx:o.string(),oid:o.number()}),di=o.object({oid:o.number()}),pi=o.union([o.object({error:o.string()}),o.object({filled:ci}),o.literal("success"),o.object({resting:di})]),hi=o.object({status:o.literal("ok"),response:o.object({type:o.string(),data:o.object({statuses:o.array(pi)}).optional()})}),li=o.union([o.object({status:o.literal("err"),response:o.string()}),hi]),on=o.object({action:o.any(),nonce:o.number(),signature:o.object({r:o.string(),s:o.string(),v:o.number()}),isTestnet:o.boolean().optional()});var oe=class{static{a(this,"HyperliquidExchange")}async postExchange(e){return await m.startSpan("hyperliquid.exchange.post",async()=>{let s=(await C.api().post("/swap/v2/exchange",e)).data,r=li.safeParse(s);if(!r.success)throw new Error(`Invalid exchange response: ${r.error.message}`);return r.data})}};d();p();function It(i){return i.map(e=>({time:e.t/1e3,open:Number(e.o),high:Number(e.h),low:Number(e.l),close:Number(e.c),volume:Number(e.v)}))}a(It,"mapRawCandleSnapshotToCandleSnapshot");d();p();var Me=class{static{a(this,"AccountBalanceStateMachine")}listeners=[];state={type:"indeterminate"};send(e){let t=this.detectNextState(e);this.state=t,this.notifyListeners()}detectNextState(e){switch(e.type){case"fetchingAccountBalanceStart":switch(this.state.type){case"accountBalance":return{type:"refreshing",accountBalance:this.state.accountBalance};case"refreshing":return{type:"refreshing",accountBalance:this.state.accountBalance};case"indeterminate":return{type:"loading",consecutiveErrors:0};case"error":return{type:"loading",consecutiveErrors:this.state.consecutiveErrors};case"loading":return{type:"loading",consecutiveErrors:this.state.consecutiveErrors};default:{let t=this.state;throw new Error(`Invalid state ${t.type} for fetchingAccountBalanceStart`)}}case"fetchingAccountBalanceSuccess":switch(this.state.type){case"loading":case"refreshing":return{type:"accountBalance",accountBalance:e.accountBalance};default:throw new Error(`Invalid state ${this.state.type} for fetchingAccountBalanceSuccess`)}case"fetchingAccountBalanceError":return{type:"error",error:e.error,consecutiveErrors:("consecutiveErrors"in this.state?this.state.consecutiveErrors:0)+1}}}getState(){return this.state}addListener(e){this.listeners.push(e)}removeListener(e){this.listeners=this.listeners.filter(t=>t!==e)}notifyListeners(){this.listeners.forEach(e=>{e.onAccountBalanceStateChange(this.state)})}};d();p();var ve=class{static{a(this,"FundingHistoryStateMachine")}listeners=[];state={type:"indeterminate"};send(e){let t=this.detectNextState(e);this.state=t,this.notifyListeners()}detectNextState(e){switch(e.type){case"fetchingFundingHistoryStart":switch(this.state.type){case"history":return{type:"refreshing",history:this.state.history};case"refreshing":return{type:"refreshing",history:this.state.history};case"indeterminate":case"error":return{type:"loading"};default:throw new Error(`Invalid state ${this.state.type} for fetchingFundingHistoryStart`)}case"fetchingFundingHistorySuccess":switch(this.state.type){case"loading":case"refreshing":return{type:"history",history:e.history};default:throw new Error(`Invalid state ${this.state.type} for fetchingFundingHistorySuccess`)}case"fetchingFundingHistoryError":switch(this.state.type){case"history":case"refreshing":return{type:"history",history:this.state.history};default:return{type:"error",error:e.error}}}}getState(){return this.state}addListener(e){this.listeners.push(e)}removeListener(e){this.listeners=this.listeners.filter(t=>t!==e)}notifyListeners(){this.listeners.forEach(e=>{e.onFundingHistoryStateChange(this.state)})}};d();p();var Le=class{static{a(this,"HistoricalOrdersStateMachine")}listeners=[];state={type:"indeterminate"};send(e){let t=this.detectNextState(e);this.state=t,this.notifyListeners()}detectNextState(e){switch(e.type){case"fetchingHistoricalOrdersStart":switch(this.state.type){case"historicalOrders":return{type:"refreshing",historicalOrders:this.state.historicalOrders};case"refreshing":return{type:"refreshing",historicalOrders:this.state.historicalOrders};case"indeterminate":case"error":return{type:"loading"};default:throw new Error(`Invalid state ${this.state.type} for fetchingHistoricalOrdersStart`)}case"fetchingHistoricalOrdersSuccess":switch(this.state.type){case"loading":case"refreshing":return{type:"historicalOrders",historicalOrders:e.historicalOrders};default:throw new Error(`Invalid state ${this.state.type} for fetchingHistoricalOrdersSuccess`)}case"fetchingHistoricalOrdersError":return{type:"error",error:e.error}}}getState(){return this.state}addListener(e){this.listeners.push(e)}removeListener(e){this.listeners=this.listeners.filter(t=>t!==e)}notifyListeners(){this.listeners.forEach(e=>{e.onHistoricalOrdersStateChange(this.state)})}};d();p();var Oe=class{static{a(this,"PositionsStateMachine")}listeners=[];state={type:"indeterminate"};send(e){let t=this.detectNextState(e);this.state=t,this.notifyListeners()}detectNextState(e){switch(e.type){case"fetchingPositionsStart":switch(this.state.type){case"positions":return{type:"refreshing",positions:this.state.positions,openOrders:this.state.openOrders};case"refreshing":return{type:"refreshing",positions:this.state.positions,openOrders:this.state.openOrders};case"indeterminate":return{type:"loading",consecutiveErrors:0};case"error":return{type:"loading",consecutiveErrors:this.state.consecutiveErrors};case"loading":return{type:"loading",consecutiveErrors:this.state.consecutiveErrors};default:{let t=this.state;throw new Error(`Invalid state ${t.type} for fetchingPositionsStart`)}}case"fetchingPositionsSuccess":switch(this.state.type){case"loading":case"refreshing":return{type:"positions",positions:e.positions,openOrders:e.openOrders};default:throw new Error(`Invalid state ${this.state.type} for fetchingPositionsSuccess`)}case"fetchingPositionsError":return{type:"error",error:e.error,consecutiveErrors:("consecutiveErrors"in this.state?this.state.consecutiveErrors:0)+1}}}getState(){return this.state}addListener(e){this.listeners.push(e)}removeListener(e){this.listeners=this.listeners.filter(t=>t!==e)}notifyListeners(){this.listeners.forEach(e=>{e.onPositionStateChange(this.state)})}};d();p();d();p();d();p();d();p();d();p();d();p();function Is(i){let e=i.length,t=0,s=0;for(;s<e;){let r=i.charCodeAt(s++);if(r&4294967168)if(!(r&4294965248))t+=2;else{if(r>=55296&&r<=56319&&s<e){let n=i.charCodeAt(s);(n&64512)===56320&&(++s,r=((r&1023)<<10)+(n&1023)+65536)}r&4294901760?t+=4:t+=3}else{t++;continue}}return t}a(Is,"utf8Count");function ui(i,e,t){let s=i.length,r=t,n=0;for(;n<s;){let c=i.charCodeAt(n++);if(c&4294967168)if(!(c&4294965248))e[r++]=c>>6&31|192;else{if(c>=55296&&c<=56319&&n<s){let l=i.charCodeAt(n);(l&64512)===56320&&(++n,c=((c&1023)<<10)+(l&1023)+65536)}c&4294901760?(e[r++]=c>>18&7|240,e[r++]=c>>12&63|128,e[r++]=c>>6&63|128):(e[r++]=c>>12&15|224,e[r++]=c>>6&63|128)}else{e[r++]=c;continue}e[r++]=c&63|128}}a(ui,"utf8EncodeJs");var gi=new TextEncoder,mi=50;function fi(i,e,t){gi.encodeInto(i,e.subarray(t))}a(fi,"utf8EncodeTE");function Ps(i,e,t){i.length>mi?fi(i,e,t):ui(i,e,t)}a(Ps,"utf8Encode");var Rn=new TextDecoder;d();p();d();p();var ae=class{static{a(this,"ExtData")}constructor(e,t){this.type=e,this.data=t}};d();p();d();p();var Be=class i extends Error{static{a(this,"DecodeError")}constructor(e){super(e);let t=Object.create(i.prototype);Object.setPrototypeOf(this,t),Object.defineProperty(this,"name",{configurable:!0,enumerable:!1,value:i.name})}};d();p();function bs(i,e,t){let s=t/4294967296,r=t;i.setUint32(e,s),i.setUint32(e+4,r)}a(bs,"setUint64");function Ue(i,e,t){let s=Math.floor(t/4294967296),r=t;i.setUint32(e,s),i.setUint32(e+4,r)}a(Ue,"setInt64");function Es(i,e){let t=i.getInt32(e),s=i.getUint32(e+4);return t*4294967296+s}a(Es,"getInt64");var yi=-1,wi=4294967296-1,Si=17179869184-1;function Ti({sec:i,nsec:e}){if(i>=0&&e>=0&&i<=Si)if(e===0&&i<=wi){let t=new Uint8Array(4);return new DataView(t.buffer).setUint32(0,i),t}else{let t=i/4294967296,s=i&4294967295,r=new Uint8Array(8),n=new DataView(r.buffer);return n.setUint32(0,e<<2|t&3),n.setUint32(4,s),r}else{let t=new Uint8Array(12),s=new DataView(t.buffer);return s.setUint32(0,e),Ue(s,4,i),t}}a(Ti,"encodeTimeSpecToTimestamp");function Ai(i){let e=i.getTime(),t=Math.floor(e/1e3),s=(e-t*1e3)*1e6,r=Math.floor(s/1e9);return{sec:t+r,nsec:s-r*1e9}}a(Ai,"encodeDateToTimeSpec");function Ii(i){if(i instanceof Date){let e=Ai(i);return Ti(e)}else return null}a(Ii,"encodeTimestampExtension");function Pi(i){let e=new DataView(i.buffer,i.byteOffset,i.byteLength);switch(i.byteLength){case 4:return{sec:e.getUint32(0),nsec:0};case 8:{let t=e.getUint32(0),s=e.getUint32(4),r=(t&3)*4294967296+s,n=t>>>2;return{sec:r,nsec:n}}case 12:{let t=Es(e,4),s=e.getUint32(0);return{sec:t,nsec:s}}default:throw new Be(`Unrecognized data size for timestamp (expected 4, 8, or 12): ${i.length}`)}}a(Pi,"decodeTimestampToTimeSpec");function bi(i){let e=Pi(i);return new Date(e.sec*1e3+e.nsec/1e6)}a(bi,"decodeTimestampExtension");var xs={type:yi,encode:Ii,decode:bi};var he=class{static{a(this,"ExtensionCodec")}constructor(){this.builtInEncoders=[],this.builtInDecoders=[],this.encoders=[],this.decoders=[],this.register(xs)}register({type:e,encode:t,decode:s}){if(e>=0)this.encoders[e]=t,this.decoders[e]=s;else{let r=-1-e;this.builtInEncoders[r]=t,this.builtInDecoders[r]=s}}tryToEncode(e,t){for(let s=0;s<this.builtInEncoders.length;s++){let r=this.builtInEncoders[s];if(r!=null){let n=r(e,t);if(n!=null){let c=-1-s;return new ae(c,n)}}}for(let s=0;s<this.encoders.length;s++){let r=this.encoders[s];if(r!=null){let n=r(e,t);if(n!=null){let c=s;return new ae(c,n)}}}return e instanceof ae?e:null}decode(e,t,s){let r=t<0?this.builtInDecoders[-1-t]:this.decoders[t];return r?r(e,t,s):new ae(t,e)}};he.defaultCodec=new he;d();p();function Ei(i){return i instanceof ArrayBuffer||typeof SharedArrayBuffer<"u"&&i instanceof SharedArrayBuffer}a(Ei,"isArrayBufferLike");function Cs(i){return i instanceof Uint8Array?i:ArrayBuffer.isView(i)?new Uint8Array(i.buffer,i.byteOffset,i.byteLength):Ei(i)?new Uint8Array(i):Uint8Array.from(i)}a(Cs,"ensureUint8Array");var xi=100,Ci=2048,Ne=class i{static{a(this,"Encoder")}constructor(e){this.entered=!1,this.extensionCodec=e?.extensionCodec??he.defaultCodec,this.context=e?.context,this.useBigInt64=e?.useBigInt64??!1,this.maxDepth=e?.maxDepth??xi,this.initialBufferSize=e?.initialBufferSize??Ci,this.sortKeys=e?.sortKeys??!1,this.forceFloat32=e?.forceFloat32??!1,this.ignoreUndefined=e?.ignoreUndefined??!1,this.forceIntegerToFloat=e?.forceIntegerToFloat??!1,this.pos=0,this.view=new DataView(new ArrayBuffer(this.initialBufferSize)),this.bytes=new Uint8Array(this.view.buffer)}clone(){return new i({extensionCodec:this.extensionCodec,context:this.context,useBigInt64:this.useBigInt64,maxDepth:this.maxDepth,initialBufferSize:this.initialBufferSize,sortKeys:this.sortKeys,forceFloat32:this.forceFloat32,ignoreUndefined:this.ignoreUndefined,forceIntegerToFloat:this.forceIntegerToFloat})}reinitializeState(){this.pos=0}encodeSharedRef(e){if(this.entered)return this.clone().encodeSharedRef(e);try{return this.entered=!0,this.reinitializeState(),this.doEncode(e,1),this.bytes.subarray(0,this.pos)}finally{this.entered=!1}}encode(e){if(this.entered)return this.clone().encode(e);try{return this.entered=!0,this.reinitializeState(),this.doEncode(e,1),this.bytes.slice(0,this.pos)}finally{this.entered=!1}}doEncode(e,t){if(t>this.maxDepth)throw new Error(`Too deep objects in depth ${t}`);e==null?this.encodeNil():typeof e=="boolean"?this.encodeBoolean(e):typeof e=="number"?this.forceIntegerToFloat?this.encodeNumberAsFloat(e):this.encodeNumber(e):typeof e=="string"?this.encodeString(e):this.useBigInt64&&typeof e=="bigint"?this.encodeBigInt64(e):this.encodeObject(e,t)}ensureBufferSizeToWrite(e){let t=this.pos+e;this.view.byteLength<t&&this.resizeBuffer(t*2)}resizeBuffer(e){let t=new ArrayBuffer(e),s=new Uint8Array(t),r=new DataView(t);s.set(this.bytes),this.view=r,this.bytes=s}encodeNil(){this.writeU8(192)}encodeBoolean(e){e===!1?this.writeU8(194):this.writeU8(195)}encodeNumber(e){!this.forceIntegerToFloat&&Number.isSafeInteger(e)?e>=0?e<128?this.writeU8(e):e<256?(this.writeU8(204),this.writeU8(e)):e<65536?(this.writeU8(205),this.writeU16(e)):e<4294967296?(this.writeU8(206),this.writeU32(e)):this.useBigInt64?this.encodeNumberAsFloat(e):(this.writeU8(207),this.writeU64(e)):e>=-32?this.writeU8(224|e+32):e>=-128?(this.writeU8(208),this.writeI8(e)):e>=-32768?(this.writeU8(209),this.writeI16(e)):e>=-2147483648?(this.writeU8(210),this.writeI32(e)):this.useBigInt64?this.encodeNumberAsFloat(e):(this.writeU8(211),this.writeI64(e)):this.encodeNumberAsFloat(e)}encodeNumberAsFloat(e){this.forceFloat32?(this.writeU8(202),this.writeF32(e)):(this.writeU8(203),this.writeF64(e))}encodeBigInt64(e){e>=BigInt(0)?(this.writeU8(207),this.writeBigUint64(e)):(this.writeU8(211),this.writeBigInt64(e))}writeStringHeader(e){if(e<32)this.writeU8(160+e);else if(e<256)this.writeU8(217),this.writeU8(e);else if(e<65536)this.writeU8(218),this.writeU16(e);else if(e<4294967296)this.writeU8(219),this.writeU32(e);else throw new Error(`Too long string: ${e} bytes in UTF-8`)}encodeString(e){let s=Is(e);this.ensureBufferSizeToWrite(5+s),this.writeStringHeader(s),Ps(e,this.bytes,this.pos),this.pos+=s}encodeObject(e,t){let s=this.extensionCodec.tryToEncode(e,this.context);if(s!=null)this.encodeExtension(s);else if(Array.isArray(e))this.encodeArray(e,t);else if(ArrayBuffer.isView(e))this.encodeBinary(e);else if(typeof e=="object")this.encodeMap(e,t);else throw new Error(`Unrecognized object: ${Object.prototype.toString.apply(e)}`)}encodeBinary(e){let t=e.byteLength;if(t<256)this.writeU8(196),this.writeU8(t);else if(t<65536)this.writeU8(197),this.writeU16(t);else if(t<4294967296)this.writeU8(198),this.writeU32(t);else throw new Error(`Too large binary: ${t}`);let s=Cs(e);this.writeU8a(s)}encodeArray(e,t){let s=e.length;if(s<16)this.writeU8(144+s);else if(s<65536)this.writeU8(220),this.writeU16(s);else if(s<4294967296)this.writeU8(221),this.writeU32(s);else throw new Error(`Too large array: ${s}`);for(let r of e)this.doEncode(r,t+1)}countWithoutUndefined(e,t){let s=0;for(let r of t)e[r]!==void 0&&s++;return s}encodeMap(e,t){let s=Object.keys(e);this.sortKeys&&s.sort();let r=this.ignoreUndefined?this.countWithoutUndefined(e,s):s.length;if(r<16)this.writeU8(128+r);else if(r<65536)this.writeU8(222),this.writeU16(r);else if(r<4294967296)this.writeU8(223),this.writeU32(r);else throw new Error(`Too large map object: ${r}`);for(let n of s){let c=e[n];this.ignoreUndefined&&c===void 0||(this.encodeString(n),this.doEncode(c,t+1))}}encodeExtension(e){if(typeof e.data=="function"){let s=e.data(this.pos+6),r=s.length;if(r>=4294967296)throw new Error(`Too large extension object: ${r}`);this.writeU8(201),this.writeU32(r),this.writeI8(e.type),this.writeU8a(s);return}let t=e.data.length;if(t===1)this.writeU8(212);else if(t===2)this.writeU8(213);else if(t===4)this.writeU8(214);else if(t===8)this.writeU8(215);else if(t===16)this.writeU8(216);else if(t<256)this.writeU8(199),this.writeU8(t);else if(t<65536)this.writeU8(200),this.writeU16(t);else if(t<4294967296)this.writeU8(201),this.writeU32(t);else throw new Error(`Too large extension object: ${t}`);this.writeI8(e.type),this.writeU8a(e.data)}writeU8(e){this.ensureBufferSizeToWrite(1),this.view.setUint8(this.pos,e),this.pos++}writeU8a(e){let t=e.length;this.ensureBufferSizeToWrite(t),this.bytes.set(e,this.pos),this.pos+=t}writeI8(e){this.ensureBufferSizeToWrite(1),this.view.setInt8(this.pos,e),this.pos++}writeU16(e){this.ensureBufferSizeToWrite(2),this.view.setUint16(this.pos,e),this.pos+=2}writeI16(e){this.ensureBufferSizeToWrite(2),this.view.setInt16(this.pos,e),this.pos+=2}writeU32(e){this.ensureBufferSizeToWrite(4),this.view.setUint32(this.pos,e),this.pos+=4}writeI32(e){this.ensureBufferSizeToWrite(4),this.view.setInt32(this.pos,e),this.pos+=4}writeF32(e){this.ensureBufferSizeToWrite(4),this.view.setFloat32(this.pos,e),this.pos+=4}writeF64(e){this.ensureBufferSizeToWrite(8),this.view.setFloat64(this.pos,e),this.pos+=8}writeU64(e){this.ensureBufferSizeToWrite(8),bs(this.view,this.pos,e),this.pos+=8}writeI64(e){this.ensureBufferSizeToWrite(8),Ue(this.view,this.pos,e),this.pos+=8}writeBigUint64(e){this.ensureBufferSizeToWrite(8),this.view.setBigUint64(this.pos,e),this.pos+=8}writeBigInt64(e){this.ensureBufferSizeToWrite(8),this.view.setBigInt64(this.pos,e),this.pos+=8}};function J(i,e){return new Ne(e).encodeSharedRef(i)}a(J,"encode");var ks=te(fe());var _e=class{static{a(this,"UpdateIsolatedMarginAction")}type="updateIsolatedMargin";asset;isBuy;ntli;constructor(e){this.asset=e.asset,this.isBuy=e.isBuy,this.ntli=e.ntli}hash(e,t){let s=J(this),r=e===null?9:29,n=new Uint8Array(s.length+r);n.set(s);let c=new DataView(n.buffer,n.byteOffset,n.byteLength);return c.setBigUint64(s.length,BigInt(t)),e===null?c.setUint8(s.length+8,0):(c.setUint8(s.length+8,1),n.set(ki(e),s.length+9)),`0x${(0,ks.keccak256)(n)}`}};function ki(i){let e=i.startsWith("0x")?i.substring(2):i;return Uint8Array.from(Buffer.from(e,"hex"))}a(ki,"addressToBytes");d();p();function Pt(i){switch(i.type){case"preparingTransaction":case"managingMargin":case"manageMarginSucceeded":return Fs(i);case"manageMarginFailed":return{...Fs(i),error:i.error instanceof Error?i.error.message:"Unknown error"};case"indeterminate":default:return{state:i.type}}}a(Pt,"getManageMarginStateLogsDetails");var Fs=a(i=>i.type==="indeterminate"?{state:i.type}:{marketSymbol:i.market.symbol,assetId:i.market.assetId.toString(),positionDirection:i.position.direction,positionSize:i.position.size.toString(),currentMargin:i.position.margin.toString(),marginDelta:i.marginDelta.toString(),marginAction:i.marginDelta.isPositive()?"increase":"decrease",newMargin:new f(i.position.margin).plus(i.marginDelta).toString(),fee:i.fee?.toString()||"N/A"},"getBaseLogsDetails");d();p();var qe=class{static{a(this,"ManageMarginStateMachine")}listeners=[];state={type:"indeterminate"};getState(){return this.state}send(e){try{let t=this.determineNextState(this.state,e);this.state=t,this.notifyListeners(e)}catch(t){console.error("Error processing event in ManageMarginStateMachine:",e,t)}}addListener(e){this.listeners.push(e)}removeListener(e){this.listeners=this.listeners.filter(t=>t!==e)}determineNextState(e,t){switch(t.type){case"InitiateManageMargin":{let{position:s,market:r,marginDelta:n,fee:c}=t.payload;return{type:"preparingTransaction",...{position:s,market:r,marginDelta:n,fee:c}}}case"ManageMarginInitiated":{if(e.type==="preparingTransaction")return{type:"managingMargin",position:e.position,market:e.market,marginDelta:e.marginDelta,fee:e.fee};break}case"ManageMarginSuccess":{if(e.type==="managingMargin")return{type:"manageMarginSucceeded",position:e.position,market:e.market,marginDelta:e.marginDelta,fee:e.fee};break}case"ManageMarginFailure":{if(e.type==="managingMargin")return{type:"manageMarginFailed",position:e.position,market:e.market,marginDelta:e.marginDelta,fee:e.fee,error:t.error};break}case"Reset":return{type:"indeterminate"}}return e}notifyListeners(e){this.listeners.forEach(t=>{t.onManageMarginStateChange(e,this.state)})}};var Fi=6,He=class{static{a(this,"ManageMarginOrchestrator")}stateMachine=new qe;perps;constructor(e){this.perps=e,this.stateMachine.addListener(this.stateListener),this.stateMachine.addListener(this.stateLogsListener)}stateListener={onManageMarginStateChange:a((e,t)=>{this.handleStateChange(e,t)},"onManageMarginStateChange")};stateLogsListener={onManageMarginStateChange:a((e,t)=>{switch(t.type){case"manageMarginSucceeded":m.addBreadcrumb(y.Perps,`Manage margin succeeded: ${t.type}`,w.Info,Pt(t));break;case"manageMarginFailed":m.addBreadcrumb(y.Perps,`Manage margin failed: ${t.type}`,w.Error,Pt(t));break;default:m.addBreadcrumb(y.Perps,`Manage margin state change: ${e.type} -> ${t.type}`,w.Info);break}(t.type==="manageMarginSucceeded"||t.type==="manageMarginFailed")&&this.stateMachine.removeListener(this.stateLogsListener)},"onManageMarginStateChange")};async handleStateChange(e,t){switch(e.type){case"InitiateManageMargin":this.stateMachine.send({type:"ManageMarginInitiated"});break;case"ManageMarginInitiated":t.type==="managingMargin"&&await this.manageMargin(t);break}}async manageMargin(e){try{let{position:t,market:s,marginDelta:r}=e,n=r.multipliedBy(new f(10).pow(Fi)).toNumber(),c=new _e({asset:s.assetId,isBuy:t.direction==="long",ntli:n}),l=Date.now(),h={domain:{name:"Exchange",version:"1",chainId:1337,verifyingContract:"0x0000000000000000000000000000000000000000"},primaryType:"Agent",types:{EIP712Domain:R,Agent:W},message:{source:this.perps.isTestnet?"b":"a",connectionId:c.hash(null,l)}},u=await this.perps.exchangeAction(c,h,l),S=u.response.data?.statuses?.find(T=>typeof T=="object"&&"error"in T);if(S&&typeof S=="object"&&"error"in S)throw new Error(S.error);let A=JSON.stringify(u.response.data?.statuses||"unknown");this.stateMachine.send({type:"ManageMarginSuccess",payload:A})}catch(t){this.stateMachine.send({type:"ManageMarginFailure",error:t})}}getState(){return this.stateMachine.getState()}send(e){this.stateMachine.send(e)}addListener(e){return this.stateMachine.addListener(e),()=>this.stateMachine.removeListener(e)}removeListener(e){this.stateMachine.removeListener(e)}};d();p();d();p();var Ds=te(fe());var ee=class{static{a(this,"OrderAction")}type="order";orders;grouping;builder;constructor(e,t){this.orders=e,this.grouping="na",t&&(this.builder=t)}hash(e,t){let s=J(this),r=e===null?9:29,n=new Uint8Array(s.length+r);n.set(s);let c=new DataView(n.buffer,n.byteOffset,n.byteLength);return c.setBigUint64(s.length,BigInt(t)),e===null?c.setUint8(s.length+8,0):(c.setUint8(s.length+8,1),n.set(Di(e),s.length+9)),`0x${(0,Ds.keccak256)(n)}`}};function Di(i){let e=i.startsWith("0x")?i.substring(2):i;return Uint8Array.from(Buffer.from(e,"hex"))}a(Di,"addressToBytes");var ze=class{static{a(this,"SpotSendAction")}hyperliquidChain;signatureChainId;amount;destination;time;token;type="spotSend";constructor(e){this.hyperliquidChain=e.hyperliquidChain,this.signatureChainId=e.signatureChainId,this.token=e.token,this.amount=e.amount,this.destination=e.destination,this.time=e.time}},We=class{static{a(this,"PerpsSendAction")}hyperliquidChain;signatureChainId;amount;destination;time;type="usdSend";constructor(e){this.hyperliquidChain=e.hyperliquidChain,this.signatureChainId=e.signatureChainId,this.amount=e.amount,this.destination=e.destination,this.time=e.time}};d();p();var Rs=te(fe());var le=class{static{a(this,"ApproveReferralAction")}type="setReferrer";code;constructor(e){this.code=e.code}hash(e,t){let s=J(this),r=e===null?9:29,n=new Uint8Array(s.length+r);n.set(s);let c=new DataView(n.buffer,n.byteOffset,n.byteLength);return c.setBigUint64(s.length,BigInt(t)),e===null?c.setUint8(s.length+8,0):(c.setUint8(s.length+8,1),n.set(Ri(e),s.length+9)),`0x${(0,Rs.keccak256)(n)}`}};function Ri(i){let e=i.startsWith("0x")?i.substring(2):i;return Uint8Array.from(Buffer.from(e,"hex"))}a(Ri,"addressToBytes");d();p();var $=class{static{a(this,"OrderBuilder")}_order={};asset(e){return this._order.a=e,this}isBuy(e){return this._order.b=e,this}buy(){return this.isBuy(!0)}sell(){return this.isBuy(!1)}price(e){return this._order.p=e.toString(),this}size(e){return this._order.s=e.toString(),this}reduceOnly(e){return this._order.r=e,this}clientOrderId(e){return this._order.c=e,this}limitOrder(e="Gtc"){return this._order.t={limit:{tif:e}},this}postOnly(){return this.limitOrder("Alo")}immediateOrCancel(){return this.limitOrder("Ioc")}triggerOrder(e,t=!0,s="sl"){return this._order.t={trigger:{isMarket:t,triggerPx:e.toString(),tpsl:s}},this}stopLoss(e,t=!0){return this.triggerOrder(e,t,"sl")}takeProfit(e,t=!0){return this.triggerOrder(e,t,"tp")}build(){if(this._order.a===void 0)throw new Error("Asset is required");if(this._order.b===void 0)throw new Error("Buy/sell direction is required");if(this._order.p===void 0)throw new Error("Price is required");if(this._order.s===void 0)throw new Error("Size is required");if(this._order.t===void 0)throw new Error("Order type is required");return this._order.r===void 0&&(this._order.r=!1),this._order}};d();p();function j(i,e,t=!0,s=f.ROUND_HALF_UP){let r=new f(i);if(r.isInteger())return r.toString();let n=Mi(e,t);return r.precision(5,s).toFixed(n,s).replace(/\.?0+$/,"")}a(j,"formatPrice");function Mi(i,e=!0){return Math.max((e?6:8)-i,0)}a(Mi,"maxAllowedDecimalsInPrice");d();p();function $e(i,e,t=f.ROUND_HALF_UP){return new f(i).toFixed(e,t).replace(/(\.\d*?)0+$/,"$1").replace(/\.$/,"")}a($e,"formatSize");d();p();var je=class{static{a(this,"CancelOrderBuilder")}_order={};asset(e){return this._order.a=e,this}orderId(e){return this._order.o=e,this}build(){if(this._order.a===void 0)throw new Error("Asset is required");if(this._order.o===void 0)throw new Error("Order ID is required");return this._order}};d();p();var Ms=te(fe());var Ge=class{static{a(this,"CancelOrderAction")}type="cancel";cancels;constructor(e){this.cancels=e}hash(e,t){let s=J(this),r=e===null?9:29,n=new Uint8Array(s.length+r);n.set(s);let c=new DataView(n.buffer,n.byteOffset,n.byteLength);return c.setBigUint64(s.length,BigInt(t)),e===null?c.setUint8(s.length+8,0):(c.setUint8(s.length+8,1),n.set(vi(e),s.length+9)),`0x${(0,Ms.keccak256)(n)}`}};function vi(i){let e=i.startsWith("0x")?i.substring(2):i;return Uint8Array.from(Buffer.from(e,"hex"))}a(vi,"addressToBytes");d();p();function bt(i){switch(i.type){case"preparingTransaction":case"registeringBuilder":case"builderRegistered":case"registeringReferral":case"referralRegistered":case"managingPosition":case"managePositionSucceeded":return vs(i);case"builderRegistrationFailed":case"referralRegistrationFailed":case"managePositionFailed":return{...vs(i),error:i.error instanceof Error?i.error.message:"Unknown error"};case"indeterminate":default:return{state:i.type}}}a(bt,"getManagePositionStateLogsDetails");var vs=a(i=>i.type==="indeterminate"?{state:i.type}:{marketSymbols:i.markets.map(e=>e.symbol).join(", "),assetIds:i.markets.map(e=>e.assetId.toString()).join(", "),positionDirections:i.positions.map(e=>e.direction).join(", "),positionSizes:i.positions.map(e=>e.size.toString()).join(", "),updateType:i.update.type,fees:i.fees.map(e=>e.toString()).join(", "),...i.update.type==="close"&&{closeSize:i.update.size.toString()},...i.update.type==="addAutoClose"&&{tpTriggerPrice:i.update.autoClose.tp?.triggerPrice.toString()||"N/A",slTriggerPrice:i.update.autoClose.sl?.triggerPrice.toString()||"N/A"},...i.update.type==="removeAutoClose"&&{tpOrderId:i.update.autoClose.tp?.orderId?.toString()||"N/A",slOrderId:i.update.autoClose.sl?.orderId?.toString()||"N/A"}},"getBaseLogsDetails");d();p();var Ve=class{static{a(this,"ManagePositionStateMachine")}listeners=[];state={type:"indeterminate"};getState(){return this.state}send(e){try{let t=this.determineNextState(this.state,e);this.state=t,this.notifyListeners(e)}catch(t){console.error("Error processing event in ManagePositionStateMachine:",e,t)}}addListener(e){this.listeners.push(e)}removeListener(e){this.listeners=this.listeners.filter(t=>t!==e)}determineNextState(e,t){switch(t.type){case"InitiateManagePosition":{let{positions:s,update:r,markets:n,fees:c,autoClose:l}=t.payload;return{type:"preparingTransaction",...{positions:s,update:r,markets:n,fees:c,autoClose:l}}}case"RegisterBuilderCodeInitiated":{if(e.type==="preparingTransaction")return{type:"registeringBuilder",positions:e.positions,update:e.update,markets:e.markets,fees:e.fees,autoClose:e.autoClose};break}case"RegisterBuilderCodeNotRequired":case"RegisterBuilderCodeSuccess":{if(e.type==="registeringBuilder")return{type:"builderRegistered",positions:e.positions,update:e.update,markets:e.markets,fees:e.fees,autoClose:e.autoClose};break}case"RegisterBuilderCodeFailure":{if(e.type==="registeringBuilder")return{type:"builderRegistrationFailed",positions:e.positions,update:e.update,error:t.error,markets:e.markets,fees:e.fees,autoClose:e.autoClose};break}case"RegisterReferralInitiated":{if(e.type==="builderRegistered")return{type:"registeringReferral",positions:e.positions,update:e.update,markets:e.markets,fees:e.fees,autoClose:e.autoClose};break}case"RegisterReferralNotRequired":case"RegisterReferralSuccess":{if(e.type==="registeringReferral")return{type:"referralRegistered",positions:e.positions,update:e.update,markets:e.markets,fees:e.fees,autoClose:e.autoClose};break}case"RegisterReferralFailure":{if(e.type==="registeringReferral")return{type:"referralRegistrationFailed",positions:e.positions,update:e.update,error:t.error,markets:e.markets,fees:e.fees,autoClose:e.autoClose};break}case"ManagePositionInitiated":{if(e.type==="preparingTransaction"||e.type==="referralRegistered")return{type:"managingPosition",positions:e.positions,update:e.update,markets:e.markets,fees:e.fees,autoClose:e.autoClose};break}case"ManagePositionSuccess":{if(e.type==="managingPosition")return{type:"managePositionSucceeded",positions:e.positions,update:e.update,markets:e.markets,fees:e.fees,autoClose:e.autoClose};break}case"ManagePositionFailure":{if(e.type==="managingPosition")return{type:"managePositionFailed",positions:e.positions,update:e.update,error:t.error,markets:e.markets,fees:e.fees,autoClose:e.autoClose};break}case"Reset":return{type:"indeterminate"}}return e}notifyListeners(e){this.listeners.forEach(t=>{t.onManagePositionStateChange(e,this.state)})}};var ue=.1,Ke=class{static{a(this,"ManagePositionOrchestrator")}stateMachine=new Ve;perps;constructor(e){this.perps=e,this.stateMachine.addListener(this.stateListener),this.stateMachine.addListener(this.stateLogsListener)}stateListener={onManagePositionStateChange:a((e,t)=>{this.handleStateChange(e,t)},"onManagePositionStateChange")};stateLogsListener={onManagePositionStateChange:a((e,t)=>{switch(t.type){case"managePositionSucceeded":m.addBreadcrumb(y.Perps,`Manage position succeeded: ${t.type}`,w.Info,bt(t));break;case"builderRegistrationFailed":case"referralRegistrationFailed":case"managePositionFailed":m.addBreadcrumb(y.Perps,`Manage position failed: ${t.type}`,w.Error,bt(t));break;default:m.addBreadcrumb(y.Perps,`Manage position state change: ${e.type} -> ${t.type}`,w.Info);break}(t.type==="managePositionSucceeded"||t.type==="managePositionFailed")&&this.stateMachine.removeListener(this.stateLogsListener)},"onManagePositionStateChange")};async handleStateChange(e,t){switch(e.type){case"InitiateManagePosition":e.payload.update.type==="close"?this.stateMachine.send({type:"RegisterBuilderCodeInitiated"}):this.stateMachine.send({type:"ManagePositionInitiated"});break;case"RegisterBuilderCodeInitiated":t.type==="registeringBuilder"&&await this.registerBuilder();break;case"RegisterBuilderCodeNotRequired":case"RegisterBuilderCodeSuccess":t.type==="builderRegistered"&&this.stateMachine.send({type:"RegisterReferralInitiated"});break;case"RegisterReferralInitiated":t.type==="registeringReferral"&&await this.registerReferral();break;case"RegisterReferralNotRequired":case"RegisterReferralSuccess":t.type==="referralRegistered"&&this.stateMachine.send({type:"ManagePositionInitiated"});break;case"ManagePositionInitiated":t.type==="managingPosition"&&await this.managePosition(t);break}}getState(){return this.stateMachine.getState()}send(e){this.stateMachine.send(e)}addListener(e){this.stateMachine.addListener(e)}removeListener(e){this.stateMachine.removeListener(e)}async registerBuilder(){try{let e=this.perps.getPositionFeesState();if(e.type!=="positionFees"&&e.type!=="refreshing"||!e.positionFees.builder)throw new Error("position fees not found");if(e.positionFees.builder.registered){this.stateMachine.send({type:"RegisterBuilderCodeNotRequired"});return}let t=e.positionFees.builder.address,s=`${Number(e.positionFees.phantomFee.toString())*100}%`,r=Date.now(),n={type:"approveBuilderFee",hyperliquidChain:this.perps.isTestnet?"Testnet":"Mainnet",signatureChainId:this.perps.isTestnet?"0x66eee":"0xa4b1",maxFeeRate:s,builder:t,nonce:r},c={domain:{name:"HyperliquidSignTransaction",version:"1",chainId:this.perps.isTestnet?421614:42161,verifyingContract:"0x0000000000000000000000000000000000000000"},primaryType:"HyperliquidTransaction:ApproveBuilderFee",types:{EIP712Domain:R,"HyperliquidTransaction:ApproveBuilderFee":Re},message:n},h=(await this.perps.exchangeAction(n,c,r)).response.data?.statuses?.find(u=>typeof u=="object"&&"error"in u);if(h&&typeof h=="object"&&"error"in h)throw new Error(h.error);this.stateMachine.send({type:"RegisterBuilderCodeSuccess"})}catch(e){this.stateMachine.send({type:"RegisterBuilderCodeFailure",error:e})}}async registerReferral(){try{if(this.perps.isTestnet){this.stateMachine.send({type:"RegisterReferralSuccess"});return}let e=this.perps.getPositionFeesState();if(e.type!=="positionFees"&&e.type!=="refreshing")throw new Error("position fees not found");if(!e.positionFees.referral||e.positionFees.referral.registered){this.stateMachine.send({type:"RegisterReferralNotRequired"});return}let t=e.positionFees.referral.code,s=new le({code:t}),r=Date.now(),n={domain:{name:"Exchange",version:"1",chainId:1337,verifyingContract:"0x0000000000000000000000000000000000000000"},primaryType:"Agent",types:{EIP712Domain:R,Agent:W},message:{source:this.perps.isTestnet?"b":"a",connectionId:s.hash(null,r)}},l=(await this.perps.exchangeAction(s,n,r)).response.data?.statuses?.find(h=>typeof h=="object"&&"error"in h);if(l&&typeof l=="object"&&"error"in l)throw new Error(l.error);this.stateMachine.send({type:"RegisterReferralSuccess"})}catch(e){this.stateMachine.send({type:"RegisterReferralFailure",error:e})}}async managePosition(e){try{let{positions:t,update:s,markets:r}=e,n="",l=t.map(h=>h.direction==="long").map(h=>h);if(s.type==="removeAutoClose"){let h=await this.removeOrders(r[0].assetId,[s.autoClose.tp?.orderId,s.autoClose.sl?.orderId].filter(Boolean));if(!h)throw new Error("Failed to cancel auto close orders");n=h}else if(s.type==="removeLimitOrder"){let h=await this.removeOrders(r[0].assetId,[s.limitOrder.orderId].filter(Boolean));if(!h)throw new Error("Failed to cancel auto close orders");n=h}else if(s.type==="removeAllOrders"){let h=await this.removeOrders(r[0].assetId,[...s.limitOrders.map(u=>u.orderId).filter(Boolean),...[s.autoClose.tp?.orderId,s.autoClose.sl?.orderId].filter(Boolean)]);if(!h)throw new Error("Failed to cancel auto close orders");n=h}else if(s.type==="close"||s.type==="closeAll")n=await this.closePositions(r.map(u=>u.assetId),s.size instanceof f?[s.size.abs().toString()]:s.size.map(u=>u.abs().toString()),l,r.map(u=>u.currentPrice.toString()),r.map(u=>u.szDecimals));else if(s.type==="addAutoClose"){let h={tp:s.autoClose.tp?.orderId,sl:s.autoClose.sl?.orderId},u=await this.createAutoClose(h,r[0].assetId,l[0],r[0].szDecimals,s.autoClose);if(!u)throw new Error("Failed to cancel auto close orders");n=u}this.stateMachine.send({type:"ManagePositionSuccess",payload:n})}catch(t){this.stateMachine.send({type:"ManagePositionFailure",error:t})}}async closePositions(e,t,s,r,n){let c=this.perps.getPositionFeesState();if(c.type!=="positionFees"&&c.type!=="refreshing"||!c.positionFees.builder)throw new Error("position fees not found");let l={b:c.positionFees.builder.address.toLowerCase(),f:Number(c.positionFees.phantomFee)*100*100*10},h=[];for(let b=0;b<e.length;b++){let H=j(new f(r[b]).multipliedBy(s[b]?1-ue:1+ue),n[b]),_=$e(new f(t[b]),n[b]),K=new $().asset(e[b]).isBuy(!s[b]).price(H).size(_).reduceOnly(!0).immediateOrCancel().build();h.push(K)}let u=new ee(h,l),S=Date.now(),A={domain:{name:"Exchange",version:"1",chainId:1337,verifyingContract:"0x0000000000000000000000000000000000000000"},primaryType:"Agent",types:{EIP712Domain:R,Agent:W},message:{source:this.perps.isTestnet?"b":"a",connectionId:u.hash(null,S)}},T=await this.perps.exchangeAction(u,A,S),I=T.response.data?.statuses.find(b=>b==="error"||b?.error);if(I){let b=typeof I=="string"?"Operation failed":I.error;throw new Error(b)}let D=T.response.data?.statuses.find(b=>b==="filled"||b?.filled);if(D&&typeof D=="object"&&D.filled)return JSON.stringify(T.response.data?.statuses);throw new Error("No filled status found")}async createAutoClose(e,t,s,r,n){let c=[e.tp,e.sl].filter(Boolean).filter(M=>M!==-1);if(c.length>0&&!await this.removeOrders(t,c))throw new Error("Failed to cancel auto close orders");let l=this.perps.getPositionFeesState();if(l.type!=="positionFees"&&l.type!=="refreshing"||!l.positionFees.builder)throw new Error("position fees not found");let h={b:l.positionFees.builder.address.toLowerCase(),f:Number(l.positionFees.phantomFee)*100*100*10},u="0",S;if(n?.tp){let M=j(new f(n.tp.triggerPrice).multipliedBy(s?1-ue:1+ue),r),Y=j(new f(n.tp.triggerPrice),r).toString();S=new $().asset(t).isBuy(!s).price(M).size(u).reduceOnly(!0).triggerOrder(Y,!0,"tp").build()}let A;if(n?.sl){let M=j(new f(n.sl.triggerPrice).multipliedBy(s?1-ue:1+ue),r),Y=j(new f(n.sl.triggerPrice),r).toString();A=new $().asset(t).isBuy(!s).price(M).size(u).reduceOnly(!0).triggerOrder(Y,!0,"sl").build()}let T=[S,A].filter(Boolean),I=new ee(T,h),D=Date.now(),b={domain:{name:"Exchange",version:"1",chainId:1337,verifyingContract:"0x0000000000000000000000000000000000000000"},primaryType:"Agent",types:{EIP712Domain:R,Agent:W},message:{source:this.perps.isTestnet?"b":"a",connectionId:I.hash(null,D)}},H=await this.perps.exchangeAction(I,b,D),_=H.response.data?.statuses.find(M=>M==="error"||M?.error);if(_){let M=typeof _=="string"?"Operation failed":_.error;throw new Error(M)}let K=H.response.data?.statuses.find(M=>M==="resting"||M?.resting);if(K&&typeof K=="object"&&K.resting&&K.resting.oid)return JSON.stringify(H.response.data?.statuses);throw new Error("No order status found")}async removeOrders(e,t){let s=t.map(u=>new je().asset(e).orderId(Number(u)).build()),r=new Ge(s),n=Date.now(),c={domain:{name:"Exchange",version:"1",chainId:1337,verifyingContract:"0x0000000000000000000000000000000000000000"},primaryType:"Agent",types:{EIP712Domain:R,Agent:W},message:{source:this.perps.isTestnet?"b":"a",connectionId:r.hash(null,n)}},l=await this.perps.exchangeAction(r,c,n),h=l.response.data?.statuses.find(u=>u==="error"||u?.error);if(h){let u=typeof h=="string"?"Operation failed":h.error;throw new Error(u)}if(l.response.data?.statuses&&l.response.data?.statuses.length>0&&l.response.data?.statuses.every(u=>u==="success"||u?.success))return JSON.stringify({orderIds:s});throw new Error("Cancel operation failed")}};d();p();d();p();var Ls=te(fe());var Xe=class{static{a(this,"UpdateLeverageAction")}type="updateLeverage";asset;isCross;leverage;constructor(e){this.asset=e.asset,this.isCross=e.isCross,this.leverage=e.leverage}hash(e,t){let s=J(this),r=e===null?9:29,n=new Uint8Array(s.length+r);n.set(s);let c=new DataView(n.buffer,n.byteOffset,n.byteLength);return c.setBigUint64(s.length,BigInt(t)),e===null?c.setUint8(s.length+8,0):(c.setUint8(s.length+8,1),n.set(Li(e),s.length+9)),`0x${(0,Ls.keccak256)(n)}`}};function Li(i){let e=i.startsWith("0x")?i.substring(2):i;return Uint8Array.from(Buffer.from(e,"hex"))}a(Li,"addressToBytes");d();p();function Et(i){switch(i.type){case"preparingTransaction":case"updatingLeverage":case"leverageUpdated":case"registeringBuilder":case"builderRegistered":case"registeringReferral":case"referralRegistered":case"creatingPosition":case"orderSucceeded":return Os(i);case"leverageUpdateFailed":case"builderRegistrationFailed":case"referralRegistrationFailed":case"orderFailed":return{...Os(i),error:i.error instanceof Error?i.error.message:"Unknown error"};case"indeterminate":default:return{state:i.type}}}a(Et,"getOpenPositionStateLogsDetails");var Os=a(i=>i.type==="indeterminate"?{state:i.type}:{marketSymbol:i.market.symbol,assetId:i.market.assetId.toString(),direction:i.direction,margin:i.margin.toString(),leverage:i.leverage.toString(),size:i.size.toString(),sizeInCoin:i.sizeInCoin.toString(),estimatedLiquidationPrice:i.estimatedLiquidationPrice?.toString()||"N/A",fee:i.fee?.toString()||"N/A",action:i.action},"getBaseLogsDetails");d();p();var Je=class{static{a(this,"OpenPositionStateMachine")}listeners=[];state={type:"indeterminate"};getState(){return this.state}send(e){try{let t=this.determineNextState(this.state,e);this.state=t,this.notifyListeners(e)}catch(t){console.error("Error processing event in OpenPositionStateMachine:",e,t)}}addListener(e){this.listeners.push(e)}removeListener(e){this.listeners=this.listeners.filter(t=>t!==e)}determineNextState(e,t){switch(t.type){case"InitiateOpenPosition":{let{market:s,direction:r,margin:n,leverage:c,autoClose:l,estimatedLiquidationPrice:h,fee:u,action:S,limitPrice:A}=t.payload,T=new f(n).multipliedBy(c),I=new f(s.currentPrice),D=I.isGreaterThan(0)?T.dividedBy(I):new f(0);return{type:"preparingTransaction",...{market:s,direction:r,margin:n,leverage:c,autoClose:l,size:T,sizeInCoin:D,estimatedLiquidationPrice:h,fee:u,action:S,limitPrice:A}}}case"InitiateUpdateLeverage":{if(e.type==="preparingTransaction")return e;break}case"UpdateLeverageInitiated":{if(e.type==="preparingTransaction")return{type:"updatingLeverage",market:e.market,direction:e.direction,margin:e.margin,leverage:e.leverage,autoClose:e.autoClose,size:e.size,sizeInCoin:e.sizeInCoin,estimatedLiquidationPrice:e.estimatedLiquidationPrice,fee:e.fee,action:e.action,limitPrice:e.limitPrice};break}case"UpdateLeverageSuccess":{if(e.type==="updatingLeverage")return{type:"leverageUpdated",market:e.market,direction:e.direction,margin:e.margin,leverage:e.leverage,autoClose:e.autoClose,size:e.size,sizeInCoin:e.sizeInCoin,estimatedLiquidationPrice:e.estimatedLiquidationPrice,fee:e.fee,action:e.action,limitPrice:e.limitPrice};break}case"UpdateLeverageFailure":{if(e.type==="updatingLeverage")return{type:"leverageUpdateFailed",market:e.market,direction:e.direction,margin:e.margin,leverage:e.leverage,autoClose:e.autoClose,size:e.size,sizeInCoin:e.sizeInCoin,estimatedLiquidationPrice:e.estimatedLiquidationPrice,fee:e.fee,error:t.error,action:e.action,limitPrice:e.limitPrice};break}case"RegisterBuilderCodeInitiated":{if(e.type==="leverageUpdated")return{type:"registeringBuilder",market:e.market,direction:e.direction,margin:e.margin,leverage:e.leverage,autoClose:e.autoClose,size:e.size,sizeInCoin:e.sizeInCoin,estimatedLiquidationPrice:e.estimatedLiquidationPrice,fee:e.fee,action:e.action,limitPrice:e.limitPrice};break}case"RegisterBuilderCodeNotRequired":case"RegisterBuilderCodeSuccess":{if(e.type==="registeringBuilder")return{type:"builderRegistered",market:e.market,direction:e.direction,margin:e.margin,leverage:e.leverage,autoClose:e.autoClose,size:e.size,sizeInCoin:e.sizeInCoin,estimatedLiquidationPrice:e.estimatedLiquidationPrice,fee:e.fee,action:e.action,limitPrice:e.limitPrice};break}case"RegisterBuilderCodeFailure":{if(e.type==="registeringBuilder")return{type:"builderRegistrationFailed",market:e.market,direction:e.direction,margin:e.margin,leverage:e.leverage,autoClose:e.autoClose,size:e.size,sizeInCoin:e.sizeInCoin,estimatedLiquidationPrice:e.estimatedLiquidationPrice,fee:e.fee,error:t.error,action:e.action,limitPrice:e.limitPrice};break}case"RegisterReferralInitiated":{if(e.type==="builderRegistered")return{type:"registeringReferral",market:e.market,direction:e.direction,margin:e.margin,leverage:e.leverage,autoClose:e.autoClose,size:e.size,sizeInCoin:e.sizeInCoin,estimatedLiquidationPrice:e.estimatedLiquidationPrice,fee:e.fee,action:e.action,limitPrice:e.limitPrice};break}case"RegisterReferralNotRequired":case"RegisterReferralSuccess":{if(e.type==="registeringReferral")return{type:"referralRegistered",market:e.market,direction:e.direction,margin:e.margin,leverage:e.leverage,autoClose:e.autoClose,size:e.size,sizeInCoin:e.sizeInCoin,estimatedLiquidationPrice:e.estimatedLiquidationPrice,fee:e.fee,action:e.action,limitPrice:e.limitPrice};break}case"RegisterReferralFailure":{if(e.type==="registeringReferral")return{type:"referralRegistrationFailed",market:e.market,direction:e.direction,margin:e.margin,leverage:e.leverage,autoClose:e.autoClose,size:e.size,sizeInCoin:e.sizeInCoin,estimatedLiquidationPrice:e.estimatedLiquidationPrice,fee:e.fee,error:t.error,action:e.action,limitPrice:e.limitPrice};break}case"PositionCreationInitiated":{if(e.type==="referralRegistered")return{type:"creatingPosition",market:e.market,direction:e.direction,margin:e.margin,leverage:e.leverage,autoClose:e.autoClose,size:e.size,sizeInCoin:e.sizeInCoin,estimatedLiquidationPrice:e.estimatedLiquidationPrice,fee:e.fee,action:e.action,limitPrice:e.limitPrice};break}case"PositionCreationSuccess":{if(e.type==="creatingPosition")return{type:"orderSucceeded",market:e.market,direction:e.direction,margin:e.margin,leverage:e.leverage,autoClose:e.autoClose,size:e.size,sizeInCoin:e.sizeInCoin,estimatedLiquidationPrice:e.estimatedLiquidationPrice,fee:e.fee,action:e.action,limitPrice:e.limitPrice};break}case"PositionCreationFailure":{if(e.type==="creatingPosition")return{type:"orderFailed",market:e.market,direction:e.direction,margin:e.margin,leverage:e.leverage,autoClose:e.autoClose,size:e.size,sizeInCoin:e.sizeInCoin,error:t.error,estimatedLiquidationPrice:e.estimatedLiquidationPrice,fee:e.fee,action:e.action,limitPrice:e.limitPrice};break}case"Reset":return{type:"indeterminate"}}return e}notifyListeners(e){this.listeners.forEach(t=>{t.onOpenPositionStateChange(e,this.state)})}};var ge=.1,Qe=class{static{a(this,"OpenPositionOrchestrator")}stateMachine=new Je;perps;constructor(e){this.perps=e,this.stateMachine.addListener(this.stateListener),this.stateMachine.addListener(this.stateLogsListener)}stateListener={onOpenPositionStateChange:a((e,t)=>{this.handleStateChange(e,t)},"onOpenPositionStateChange")};stateLogsListener={onOpenPositionStateChange:a((e,t)=>{switch(t.type){case"orderSucceeded":m.addBreadcrumb(y.Perps,`Open position succeeded: ${t.type}`,w.Info,Et(t));break;case"leverageUpdateFailed":case"builderRegistrationFailed":case"referralRegistrationFailed":case"orderFailed":m.addBreadcrumb(y.Perps,`Open position failed: ${t.type}`,w.Error,Et(t));break;default:m.addBreadcrumb(y.Perps,`Open position state change: ${e.type} -> ${t.type}`,w.Info);break}(t.type==="orderSucceeded"||t.type==="orderFailed")&&this.stateMachine.removeListener(this.stateLogsListener)},"onOpenPositionStateChange")};async handleStateChange(e,t){switch(e.type){case"InitiateOpenPosition":this.stateMachine.send({type:"InitiateUpdateLeverage",payload:{isCross:!1,leverage:e.payload.leverage}});break;case"InitiateUpdateLeverage":this.stateMachine.send({type:"UpdateLeverageInitiated"});break;case"UpdateLeverageInitiated":t.type==="updatingLeverage"&&await this.updateLeverage(t);break;case"UpdateLeverageSuccess":t.type==="leverageUpdated"&&this.stateMachine.send({type:"RegisterBuilderCodeInitiated"});break;case"InitiateRegisterBuilder":this.stateMachine.send({type:"RegisterBuilderCodeInitiated"});break;case"RegisterBuilderCodeInitiated":t.type==="registeringBuilder"&&await this.registerBuilder();break;case"RegisterBuilderCodeNotRequired":case"RegisterBuilderCodeSuccess":t.type==="builderRegistered"&&this.stateMachine.send({type:"RegisterReferralInitiated"});break;case"InitiateRegisterReferral":this.stateMachine.send({type:"RegisterReferralInitiated"});break;case"RegisterReferralInitiated":t.type==="registeringReferral"&&await this.registerReferral();break;case"RegisterReferralNotRequired":case"RegisterReferralSuccess":t.type==="referralRegistered"&&this.stateMachine.send({type:"PositionCreationInitiated"});break;case"PositionCreationInitiated":t.type==="creatingPosition"&&await this.createPosition(t);break}}getState(){return this.stateMachine.getState()}send(e){this.stateMachine.send(e)}addListener(e){this.stateMachine.addListener(e)}removeListener(e){this.stateMachine.removeListener(e)}async updateLeverage(e){try{let t=e.market.assetId,s=new Xe({asset:t,isCross:!1,leverage:e.leverage.toNumber()}),r=Date.now(),n={domain:{name:"Exchange",version:"1",chainId:1337,verifyingContract:"0x0000000000000000000000000000000000000000"},primaryType:"Agent",types:{EIP712Domain:R,Agent:W},message:{source:this.perps.isTestnet?"b":"a",connectionId:s.hash(null,r)}},l=(await this.perps.exchangeAction(s,n,r)).response.data?.statuses?.find(h=>typeof h=="object"&&"error"in h);if(l&&typeof l=="object"&&"error"in l)throw new Error(l.error);this.stateMachine.send({type:"UpdateLeverageSuccess"})}catch(t){this.stateMachine.send({type:"UpdateLeverageFailure",error:t})}}async registerBuilder(){try{let e=this.perps.getPositionFeesState();if(e.type!=="positionFees"&&e.type!=="refreshing"||!e.positionFees.builder)throw new Error("position fees not found");if(e.positionFees.builder.registered){this.stateMachine.send({type:"RegisterBuilderCodeNotRequired"});return}let t=e.positionFees.builder.address,s=`${Number(e.positionFees.phantomFee.toString())*100}%`,r=Date.now(),n={type:"approveBuilderFee",hyperliquidChain:this.perps.isTestnet?"Testnet":"Mainnet",signatureChainId:this.perps.isTestnet?"0x66eee":"0xa4b1",maxFeeRate:s,builder:t,nonce:r},c={domain:{name:"HyperliquidSignTransaction",version:"1",chainId:this.perps.isTestnet?421614:42161,verifyingContract:"0x0000000000000000000000000000000000000000"},primaryType:"HyperliquidTransaction:ApproveBuilderFee",types:{EIP712Domain:R,"HyperliquidTransaction:ApproveBuilderFee":Re},message:n},h=(await this.perps.exchangeAction(n,c,r)).response.data?.statuses?.find(u=>typeof u=="object"&&"error"in u);if(h&&typeof h=="object"&&"error"in h)throw new Error(h.error);this.stateMachine.send({type:"RegisterBuilderCodeSuccess"})}catch(e){this.stateMachine.send({type:"RegisterBuilderCodeFailure",error:e})}}async registerReferral(){try{if(this.perps.isTestnet){this.stateMachine.send({type:"RegisterReferralSuccess"});return}let e=this.perps.getPositionFeesState();if(e.type!=="positionFees"&&e.type!=="refreshing")throw new Error("position fees not found");if(!e.positionFees.referral||e.positionFees.referral.registered){this.stateMachine.send({type:"RegisterReferralNotRequired"});return}let t=e.positionFees.referral.code,s=new le({code:t}),r=Date.now(),n={domain:{name:"Exchange",version:"1",chainId:1337,verifyingContract:"0x0000000000000000000000000000000000000000"},primaryType:"Agent",types:{EIP712Domain:R,Agent:W},message:{source:this.perps.isTestnet?"b":"a",connectionId:s.hash(null,r)}},l=(await this.perps.exchangeAction(s,n,r)).response.data?.statuses?.find(h=>typeof h=="object"&&"error"in h);if(l&&typeof l=="object"&&"error"in l)throw new Error(l.error);this.stateMachine.send({type:"RegisterReferralSuccess"})}catch(e){this.stateMachine.send({type:"RegisterReferralFailure",error:e})}}async createPosition(e){try{let t=await this.createOrder(e.market.assetId,e.size.toString(),e.direction==="long",e.limitPrice?e.limitPrice.toString():e.market.currentPrice.toString(),e.market.szDecimals,e.autoClose,e.action==="reduce",e.limitPrice?"limit":"market");this.stateMachine.send({type:"PositionCreationSuccess",payload:t})}catch(t){this.stateMachine.send({type:"PositionCreationFailure",error:t})}}async createOrder(e,t,s,r,n,c,l,h="market"){let u=h==="limit"?j(new f(r),n):j(new f(r).multipliedBy(s?1+ge:1-ge),n),S=this.perps.getPositionFeesState();if(S.type!=="positionFees"&&S.type!=="refreshing"||!S.positionFees.builder)throw new Error("position fees not found");let A={b:S.positionFees.builder.address.toLowerCase(),f:Number(S.positionFees.phantomFee)*100*100*10},T=$e(new f(t).dividedBy(new f(r)),n),I;h==="limit"?I=new $().asset(e).isBuy(s).price(u).size(T).reduceOnly(l??!1).limitOrder().build():I=new $().asset(e).isBuy(s).price(u).size(T).reduceOnly(l??!1).immediateOrCancel().build();let D;if(c?.tp?.dollar){let q=j(new f(c.tp.dollar),n).toString(),St=j(new f(c.tp.dollar).multipliedBy(s?1+ge:1-ge),n);D=new $().asset(e).isBuy(!s).price(St).size(T).reduceOnly(!0).triggerOrder(q,!0,"tp").build()}let b;if(c?.sl?.dollar){let q=j(new f(c.sl.dollar),n).toString(),St=j(new f(c.sl.dollar).multipliedBy(s?1+ge:1-ge),n);b=new $().asset(e).isBuy(!s).price(St).size(T).reduceOnly(!0).triggerOrder(q,!0,"sl").build()}let H=[I,D,b].filter(Boolean),_=new ee(H,A),K=Date.now(),M={domain:{name:"Exchange",version:"1",chainId:1337,verifyingContract:"0x0000000000000000000000000000000000000000"},primaryType:"Agent",types:{EIP712Domain:R,Agent:W},message:{source:this.perps.isTestnet?"b":"a",connectionId:_.hash(null,K)}},Y=await this.perps.exchangeAction(_,M,K),N=Y.response.data?.statuses?.find(q=>typeof q=="object"&&"error"in q);if(N&&typeof N=="object"&&"error"in N)throw new Error(N.error);let B=Y.response.data?.statuses.find(q=>typeof q=="object"&&"filled"in q),wt=Y.response.data?.statuses.find(q=>typeof q=="object"&&"resting"in q);if(B&&typeof B=="object"&&"filled"in B||wt)return JSON.stringify(Y.response.data?.statuses);throw new Error("No filled status found")}};d();p();var Ye=class{static{a(this,"PositionFeesStateMachine")}listeners=[];state={type:"indeterminate"};send(e){let t=this.detectNextState(e);this.state=t,this.notifyListeners()}detectNextState(e){switch(e.type){case"fetchingPositionFeesStart":switch(this.state.type){case"positionFees":return{type:"refreshing",positionFees:this.state.positionFees};case"refreshing":return{type:"refreshing",positionFees:this.state.positionFees};case"indeterminate":case"error":return{type:"loading"};default:throw new Error(`Invalid state ${this.state.type} for fetchingPositionFeesStart`)}case"fetchingPositionFeesSuccess":switch(this.state.type){case"loading":case"refreshing":return{type:"positionFees",positionFees:e.fees};default:throw new Error(`Invalid state ${this.state.type} for fetchingPositionFeesSuccess`)}case"fetchingPositionFeesError":return{type:"error",error:e.error}}}getState(){return this.state}addListener(e){this.listeners.push(e)}removeListener(e){this.listeners=this.listeners.filter(t=>t!==e)}notifyListeners(){this.listeners.forEach(e=>{e.onPositionFeesStateChange(this.state)})}};d();p();var xt=["1H","1D","1W","1M","YTD","ALL"],Ze=class{static{a(this,"PricingStateMachine")}listeners=[];state={type:"indeterminate"};nextRequestId=1;send(e){let t=this.detectNextState(e);this.state=t,this.notifyListeners()}detectNextState(e){switch(e.type){case"initiateSequentialFetch":{let t={"1H":{type:"idle"},"1D":{type:"idle"},"1W":{type:"idle"},"1M":{type:"idle"},YTD:{type:"idle"},ALL:{type:"idle"}};return{type:"multiInterval",activeCoin:e.coin,requestId:this.nextRequestId++,intervals:t,currentlyFetchingInterval:null,sequenceComplete:!1}}case"fetchingIntervalStart":return this.state.type!=="multiInterval"?this.state:e.requestId!==this.state.requestId||e.coin!==this.state.activeCoin?this.state:{...this.state,intervals:{...this.state.intervals,[e.interval]:{type:"loading"}},currentlyFetchingInterval:e.interval};case"fetchingIntervalSuccess":{if(this.state.type!=="multiInterval")return this.state;if(e.requestId!==this.state.requestId||e.coin!==this.state.activeCoin)return this.state;let t={...this.state.intervals,[e.interval]:{type:"loaded",candleSnapshots:e.candleSnapshots}},s=xt.every(r=>{let n=t[r];return n.type==="loaded"||n.type==="error"});return{type:"multiInterval",activeCoin:this.state.activeCoin,requestId:this.state.requestId,intervals:t,currentlyFetchingInterval:null,sequenceComplete:s}}case"fetchingIntervalError":{if(this.state.type!=="multiInterval")return this.state;if(e.requestId!==this.state.requestId||e.coin!==this.state.activeCoin)return this.state;let t={...this.state.intervals,[e.interval]:{type:"error",error:e.error}},s=xt.every(r=>{let n=t[r];return n.type==="loaded"||n.type==="error"});return{type:"multiInterval",activeCoin:this.state.activeCoin,requestId:this.state.requestId,intervals:t,currentlyFetchingInterval:null,sequenceComplete:s}}case"sequentialFetchComplete":return this.state.type!=="multiInterval"?this.state:{...this.state,sequenceComplete:!0};default:return this.state}}getState(){return this.state}getNextIntervalToFetch(){if(this.state.type!=="multiInterval")return null;for(let e of xt)if(this.state.intervals[e].type==="idle")return e;return null}addListener(e){this.listeners.push(e)}removeListener(e){this.listeners=this.listeners.filter(t=>t!==e)}notifyListeners(){this.listeners.forEach(e=>{e.onPricingStateChange(this.state)})}};d();p();var et=.98,tt=class{static{a(this,"Spot")}perps;perpsClient;constructor(e,t){this.perps=e,this.perpsClient=t}async getSpotBalances(e){let t=P({address:e,chainId:ye.Mainnet,resourceType:L.address});return(await this.perpsClient.getSpotBalances({user:t})).balances}async buy(e,t,s){let r=new f(s).dividedBy(et).decimalPlaces(2);return this.placeBuySellOrder(e,t,!0,r.toString())}async sell(e,t,s){let r=new f(s).multipliedBy(et).decimalPlaces(2);return this.placeBuySellOrder(e,t,!1,r.toString())}async placeBuySellOrder(e,t,s,r){if(!this.perps.user?.address)throw new Error("User not found");let c=new $().asset(e).isBuy(s).price(r).size(t).reduceOnly(!1).immediateOrCancel().build(),l=new ee([c]),h=Date.now(),u={domain:{name:"Exchange",version:"1",chainId:1337,verifyingContract:"0x0000000000000000000000000000000000000000"},primaryType:"Agent",types:{EIP712Domain:R,Agent:W},message:{source:this.perps.isTestnet?"b":"a",connectionId:l.hash(null,h)}},S=await this.perps.exchangeAction(l,u,h),A=S.response.data?.statuses.find(I=>typeof I=="object"&&"error"in I);if(A&&typeof A=="object"&&"error"in A)throw new Error(A.error);let T=S.response.data?.statuses.find(I=>typeof I=="object"&&"filled"in I);if(T&&typeof T=="object"&&"filled"in T)return{totalSz:T.filled.totalSz,avgPx:T.filled.avgPx};throw new Error("No filled status found")}async send(e,t,s,r){let n=`${e}:${t}`,c=Date.now(),l=new ze({hyperliquidChain:this.perps.isTestnet?"Testnet":"Mainnet",signatureChainId:this.perps.isTestnet?"0x66eee":"0xa4b1",token:n,amount:s.toString(),destination:r.toLowerCase(),time:c}),h={domain:{name:"HyperliquidSignTransaction",version:"1",chainId:this.perps.isTestnet?421614:42161,verifyingContract:"0x0000000000000000000000000000000000000000"},primaryType:"HyperliquidTransaction:SpotSend",types:{EIP712Domain:R,"HyperliquidTransaction:SpotSend":[{name:"hyperliquidChain",type:"string"},{name:"destination",type:"string"},{name:"token",type:"string"},{name:"amount",type:"string"},{name:"time",type:"uint64"}]},message:l},{splitSignature:u}=await this.perps.sign(h),S=await this.perpsClient.postSpotSend({action:l,nonce:c,signature:u});if(S.status==="err")throw new Error(S.response);return S.response}async getTokenMidPrice(e){let t=await this.perpsClient.getTokenDetails({tokenId:e});return new f(t.midPx)}};var st=class{static{a(this,"Perps")}client;accountBalanceStateMachine=new Me;positionsStateMachine=new Oe;pricingStateMachine=new Ze;positionFeesStateMachine=new Ye;signer=void 0;fundingHistoryStateMachine=new ve;historicalOrdersStateMachine=new Le;openPositionOrchestrator;managePositionOrchestrator;manageMarginOrchestrator;accountChangeListeners=[];account;user;isTestnet;spot;fundingPool;relayFundingTaskFactory;hyperunitFundingTaskFactory;sequentialPricingCoin=null;pricingRequestId=null;authRepository;constructor({client:e,isTestnet:t,fundingPool:s,relayFundingTaskFactory:r,hyperunitFundingTaskFactory:n,authRepository:c}){this.client=e,this.isTestnet=t,this.spot=new tt(this,this.client),this.fundingPool=s,this.fundingPool.addListener(this.fundingPoolListener),this.relayFundingTaskFactory=r,this.hyperunitFundingTaskFactory=n,this.openPositionOrchestrator=new Qe(this),this.managePositionOrchestrator=new Ke(this),this.manageMarginOrchestrator=new He(this),this.authRepository=c,this.pricingStateMachine.addListener({onPricingStateChange:this.handlePricingStateChange.bind(this)}),this.accountBalanceStateMachine.addListener({onAccountBalanceStateChange:a(l=>{this.enableDexAbstraction(l)},"onAccountBalanceStateChange")})}setSigner(e){this.signer=e}createRelayFundingTask(e,t,s,r){return this.relayFundingTaskFactory.createTask(this,e,this.authRepository,t,s,ie(this.signer),ie(this.user),r)}createHyperunitFundingTask(e,t,s,r){return this.hyperunitFundingTaskFactory.createTask(this,e,this.authRepository,t,s,ie(this.signer),ie(this.user),r)}executeFundingTask(e,t,s,r,n){this.fundingPool.submit(e,t,s,r,n)}fundingPoolListener={onFundingPoolStateChange:a((e,t)=>{(e.type==="fundingCompleted"||e.type==="fundingStarted")&&(this.syncAccountBalance(),this.syncFundingHistory())},"onFundingPoolStateChange")};setAccount(e){this.account=e;let{address:t}=e.addresses?.find(s=>ne.isEVMNetworkID(s.networkID))??{addressType:re.EVM,networkID:Nt.Ethereum.Mainnet};t&&(this.user={resourceType:L.address,chainId:this.isTestnet?"hypercore:testnet":ne.hypercore.mainnetID,address:t},this.fundingPool.setAccountId(t)),this.accountChangeListeners.forEach(s=>s.onAccountChange(e))}getAccount(){return this.account}getUser(){return this.user}subscribeAccountChange(e){return this.accountChangeListeners.push(e),()=>this.unsubscribeAccountChange(e)}unsubscribeAccountChange(e){this.accountChangeListeners=this.accountChangeListeners.filter(t=>t!==e)}getAccountBalanceState(){return this.accountBalanceStateMachine.getState()}syncAccountBalance(){if(!this.user)return;let e=this.accountBalanceStateMachine.getState();e.type==="loading"||e.type==="refreshing"||(this.accountBalanceStateMachine.send({type:"fetchingAccountBalanceStart"}),this.client.getAccountBalance(this.user).then(t=>{this.accountBalanceStateMachine.send({type:"fetchingAccountBalanceSuccess",accountBalance:t})}).catch(t=>{this.accountBalanceStateMachine.send({type:"fetchingAccountBalanceError",error:t}),m.addBreadcrumb(y.Perps,"Error fetching account balance",w.Error,{error:t instanceof Error?t.message:"Unknown error"})}))}subscribeAccountBalanceState(e){return this.accountBalanceStateMachine.addListener(e),()=>{this.unsubscribeAccountBalanceState(e)}}unsubscribeAccountBalanceState(e){this.accountBalanceStateMachine.removeListener(e)}getPositionFeesState(){return this.positionFeesStateMachine.getState()}syncPositionFees(){if(!this.user)return;let e=this.positionFeesStateMachine.getState();e.type==="loading"||e.type==="refreshing"||(this.positionFeesStateMachine.send({type:"fetchingPositionFeesStart"}),this.client.getPositionFees(this.user).then(t=>{this.positionFeesStateMachine.send({type:"fetchingPositionFeesSuccess",fees:t})}).catch(t=>{this.positionFeesStateMachine.send({type:"fetchingPositionFeesError",error:t}),m.addBreadcrumb(y.Perps,"Error fetching position fees",w.Error,{error:t instanceof Error?t.message:"Unknown error"})}))}subscribePositionFees(e){return this.positionFeesStateMachine.addListener(e),()=>{this.unsubscribePositionFees(e)}}unsubscribePositionFees(e){this.positionFeesStateMachine.removeListener(e)}getPositionsState(){return this.positionsStateMachine.getState()}syncPositions(){if(!this.user)return;let e=this.positionsStateMachine.getState();e.type==="loading"||e.type==="refreshing"||(this.positionsStateMachine.send({type:"fetchingPositionsStart"}),this.client.getPositionsAndOpenOrders(this.user).then(t=>{this.positionsStateMachine.send({type:"fetchingPositionsSuccess",positions:t.positions,openOrders:t.openOrders})}).catch(t=>{this.positionsStateMachine.send({type:"fetchingPositionsError",error:t}),m.addBreadcrumb(y.Perps,"Error fetching positions",w.Error,{error:t instanceof Error?t.message:"Unknown error"})}))}subscribePositions(e){return this.positionsStateMachine.addListener(e),()=>{this.unsubscribePositions(e)}}unsubscribePositions(e){this.positionsStateMachine.removeListener(e)}getFundingHistoryState(){return this.fundingHistoryStateMachine.getState()}syncFundingHistory(){if(!this.user)return;let e=this.fundingHistoryStateMachine.getState();e.type==="loading"||e.type==="refreshing"||(this.fundingHistoryStateMachine.send({type:"fetchingFundingHistoryStart"}),this.client.getUserFundingHistory(this.user).then(t=>{this.fundingHistoryStateMachine.send({type:"fetchingFundingHistorySuccess",history:t})}).catch(t=>{this.fundingHistoryStateMachine.send({type:"fetchingFundingHistoryError",error:t}),m.addBreadcrumb(y.Perps,"Error fetching funding history",w.Error,{error:t instanceof Error?t.message:"Unknown error"})}))}subscribeFundingHistory(e){return this.fundingHistoryStateMachine.addListener(e),()=>{this.unsubscribeFundingHistory(e)}}unsubscribeFundingHistory(e){this.fundingHistoryStateMachine.removeListener(e)}getHistoricalOrdersState(){return this.historicalOrdersStateMachine.getState()}syncHistoricalOrders(e){if(!this.user)return;let t=this.historicalOrdersStateMachine.getState();t.type==="loading"||t.type==="refreshing"||(this.historicalOrdersStateMachine.send({type:"fetchingHistoricalOrdersStart"}),this.client.getHistoricalOrders(this.user,e).then(s=>{this.historicalOrdersStateMachine.send({type:"fetchingHistoricalOrdersSuccess",historicalOrders:s})}).catch(s=>{this.historicalOrdersStateMachine.send({type:"fetchingHistoricalOrdersError",error:s}),m.addBreadcrumb(y.Perps,"Error fetching historical orders",w.Error,{error:s instanceof Error?s.message:"Unknown error",markets:e?.join(",")??"No markets"})}))}subscribeHistoricalOrders(e){return this.historicalOrdersStateMachine.addListener(e),()=>{this.unsubscribeHistoricalOrders(e)}}unsubscribeHistoricalOrders(e){this.historicalOrdersStateMachine.removeListener(e)}getPricingState(){return this.pricingStateMachine.getState()}syncPricing(e,t,s,r){if(!this.user)return;let n;switch(t){case"1m":n="1H";break;case"15m":n="1D";break;case"1h":n="1W";break;case"4h":n="1M";break;case"1d":n="ALL";break;default:n="1D"}let c=this.pricingStateMachine.getState();(c.type!=="multiInterval"||c.activeCoin!==e)&&this.pricingStateMachine.send({type:"initiateSequentialFetch",coin:e});let l=this.pricingStateMachine.getState(),h=l.type==="multiInterval"?l.requestId:null;h!=null&&(this.pricingStateMachine.send({type:"fetchingIntervalStart",interval:n,coin:e,requestId:h,apiInterval:t,startTime:s,endTime:r}),this.client.getPriceHistory({coin:e,interval:n,startTime:s,endTime:r,isTestnet:this.isTestnet}).then(u=>{let S=It(u);this.pricingStateMachine.send({type:"fetchingIntervalSuccess",interval:n,coin:e,requestId:h,candleSnapshots:S})}).catch(u=>{this.pricingStateMachine.send({type:"fetchingIntervalError",interval:n,coin:e,requestId:h,error:u}),m.addBreadcrumb(y.Perps,"Error fetching pricing",w.Error,{error:u instanceof Error?u.message:"Unknown error",coin:e,interval:t,startTime:s,endTime:r})}))}getTimeFrameDetails(e,t){let s=t,r,n;switch(e){case"1H":r=t-1e3*60*60*1,n="1m";break;case"1D":r=t-1e3*60*60*24,n="30m";break;case"1W":r=t-1e3*60*60*24*7,n="4h";break;case"1M":r=t-1e3*60*60*24*30,n="12h";break;case"YTD":r=new Date(new Date().getFullYear(),0,1).getTime(),n="1d";break;case"ALL":r=t-1e3*60*60*24*365*10,n="1d";break}return{startTime:r,endTime:s,apiInterval:n}}startSequentialPricingSync(e){this.sequentialPricingCoin=e,this.pricingStateMachine.send({type:"initiateSequentialFetch",coin:e});let t=this.pricingStateMachine.getState();this.pricingRequestId=t.type==="multiInterval"?t.requestId:null,this.fetchNextInterval()}fetchNextInterval(){let e=this.pricingStateMachine.getNextIntervalToFetch();if(!e||!this.sequentialPricingCoin)return;let t=this.pricingRequestId;if(t==null)return;let s=new Date().getTime(),{startTime:r,endTime:n,apiInterval:c}=this.getTimeFrameDetails(e,s);this.pricingStateMachine.send({type:"fetchingIntervalStart",interval:e,coin:this.sequentialPricingCoin,requestId:t,apiInterval:c,startTime:r,endTime:n}),this.client.getPriceHistory({coin:this.sequentialPricingCoin,interval:c,startTime:r,endTime:n,isTestnet:this.isTestnet}).then(l=>{let h=It(l);this.pricingStateMachine.send({type:"fetchingIntervalSuccess",interval:e,coin:this.sequentialPricingCoin,requestId:t,candleSnapshots:h})}).catch(l=>{this.pricingStateMachine.send({type:"fetchingIntervalError",interval:e,coin:this.sequentialPricingCoin,requestId:t,error:l}),m.addBreadcrumb(y.Perps,"Error fetching next pricing interval",w.Error,{error:l instanceof Error?l.message:"Unknown error",coin:this.sequentialPricingCoin,interval:e,apiInterval:c,startTime:r,endTime:new Date(n).toISOString()})})}handlePricingStateChange(e){e.type==="multiInterval"&&!e.currentlyFetchingInterval&&!e.sequenceComplete&&setTimeout(()=>{this.fetchNextInterval()},100)}isEnablingDexAbstraction=!1;dexAbstractionRetryCount=0;async enableDexAbstraction(e){if(e.type==="accountBalance"){if(e.accountBalance.dexAbstraction){this.dexAbstractionRetryCount=0;return}if(!(this.dexAbstractionRetryCount>=5)&&this.user&&!this.isEnablingDexAbstraction){this.isEnablingDexAbstraction=!0,this.dexAbstractionRetryCount++;try{await this.setUserDexAbstraction({enabled:!0}),m.addBreadcrumb(y.Perps,"DEX abstraction enabled",w.Info),this.dexAbstractionRetryCount=0}catch(t){m.addBreadcrumb(y.Perps,"Failed to enable DEX abstraction",w.Error,{error:t instanceof Error?t.message:"Unknown error",retryAttempt:this.dexAbstractionRetryCount})}finally{this.isEnablingDexAbstraction=!1}}}}subscribePricing(e){return this.pricingStateMachine.addListener(e),()=>{this.unsubscribePricing(e)}}unsubscribePricing(e){this.pricingStateMachine.removeListener(e)}async sign(e){let t=ie(this.signer),s=ie(this.account),{signature:r}=await t.sign(s.identifier,{chainType:re.EVM,signingType:"typedData",version:4,data:e});return{splitSignature:Bs(r)}}async exchangeAction(e,t,s){let r=new oe,n=ie(this.signer),c=ie(this.account),{signature:l}=await n.sign(c.identifier,{chainType:re.EVM,signingType:"typedData",version:4,data:t}),h=Bs(l),u=await r.postExchange({action:e,nonce:s,signature:{r:h.r,s:h.s,v:h.v},isTestnet:this.isTestnet});if(u.status==="err")throw new Error(u.response);if(u.status==="ok")return u;throw new Error("Unknown response status")}async transfer(e){let{toPerp:t,amount:s}=e,r=Date.now(),n={type:"usdClassTransfer",hyperliquidChain:this.isTestnet?"Testnet":"Mainnet",signatureChainId:this.isTestnet?"0x66eee":"0xa4b1",amount:s.toString(),toPerp:t,nonce:r},c={domain:{name:"HyperliquidSignTransaction",version:"1",chainId:this.isTestnet?421614:42161,verifyingContract:"0x0000000000000000000000000000000000000000"},primaryType:"HyperliquidTransaction:UsdClassTransfer",types:{EIP712Domain:R,"HyperliquidTransaction:UsdClassTransfer":[{name:"hyperliquidChain",type:"string"},{name:"amount",type:"string"},{name:"toPerp",type:"bool"},{name:"nonce",type:"uint64"}]},message:n},{splitSignature:l}=await this.sign(c),u=await new oe().postExchange({action:n,nonce:r,signature:l,isTestnet:this.isTestnet});if(u.status==="err")throw new Error(u.response);return u}async sendAsset(e){let{destination:t,sourceDex:s,destinationDex:r,token:n,amount:c,vaultAddress:l}=e,h=Date.now(),u={type:"sendAsset",hyperliquidChain:this.isTestnet?"Testnet":"Mainnet",signatureChainId:this.isTestnet?"0x66eee":"0xa4b1",destination:t.toLowerCase(),sourceDex:s,destinationDex:r,token:n,amount:c.toString(),fromSubAccount:l?l.toLowerCase():"",nonce:h},S={domain:{name:"HyperliquidSignTransaction",version:"1",chainId:this.isTestnet?421614:42161,verifyingContract:"0x0000000000000000000000000000000000000000"},primaryType:"HyperliquidTransaction:SendAsset",types:{EIP712Domain:R,"HyperliquidTransaction:SendAsset":[{name:"hyperliquidChain",type:"string"},{name:"destination",type:"string"},{name:"sourceDex",type:"string"},{name:"destinationDex",type:"string"},{name:"token",type:"string"},{name:"amount",type:"string"},{name:"fromSubAccount",type:"string"},{name:"nonce",type:"uint64"}]},message:u},{splitSignature:A}=await this.sign(S),I=await new oe().postExchange({action:u,nonce:h,signature:A,isTestnet:this.isTestnet});if(I.status==="err")throw new Error(I.response);return I}async setUserDexAbstraction(e){let{enabled:t}=e;if(!this.user)throw new Error("User not set");let s=Date.now(),r={type:"userDexAbstraction",hyperliquidChain:this.isTestnet?"Testnet":"Mainnet",signatureChainId:this.isTestnet?"0x66eee":"0xa4b1",user:this.user.address,enabled:t,nonce:s},n={domain:{name:"HyperliquidSignTransaction",version:"1",chainId:this.isTestnet?421614:42161,verifyingContract:"0x0000000000000000000000000000000000000000"},primaryType:"HyperliquidTransaction:UserDexAbstraction",types:{EIP712Domain:R,"HyperliquidTransaction:UserDexAbstraction":[{name:"hyperliquidChain",type:"string"},{name:"user",type:"address"},{name:"enabled",type:"bool"},{name:"nonce",type:"uint64"}]},message:r},{splitSignature:c}=await this.sign(n),h=await new oe().postExchange({action:r,nonce:s,signature:c});if(h.status==="err")throw new Error(h.response);return h}async usdSendPerps(e){let{destination:t,amount:s}=e,r=Date.now(),n=new We({hyperliquidChain:this.isTestnet?"Testnet":"Mainnet",signatureChainId:this.isTestnet?"0x66eee":"0xa4b1",amount:s.toString(),destination:t.toLowerCase(),time:r}),c={domain:{name:"HyperliquidSignTransaction",version:"1",chainId:this.isTestnet?421614:42161,verifyingContract:"0x0000000000000000000000000000000000000000"},primaryType:"HyperliquidTransaction:UsdSend",types:{EIP712Domain:R,"HyperliquidTransaction:UsdSend":[{name:"hyperliquidChain",type:"string"},{name:"destination",type:"string"},{name:"amount",type:"string"},{name:"time",type:"uint64"}]},message:n},{splitSignature:l}=await this.sign(c),h=await this.client.postPerpsSend({action:n,nonce:r,signature:l});if(h.status==="err")throw new Error(h.response);return h.response}openPosition(e){this.openPositionOrchestrator.send({type:"InitiateOpenPosition",payload:e})}resetOpenPosition(){this.openPositionOrchestrator.send({type:"Reset"})}getOpenPositionState(){return this.openPositionOrchestrator.getState()}subscribeOpenPosition(e){return this.openPositionOrchestrator.addListener(e),()=>{this.unsubscribeOpenPosition(e)}}unsubscribeOpenPosition(e){this.openPositionOrchestrator.removeListener(e)}managePosition(e){this.managePositionOrchestrator.send({type:"InitiateManagePosition",payload:e})}resetManagePosition(){this.managePositionOrchestrator.send({type:"Reset"})}getManagePositionState(){return this.managePositionOrchestrator.getState()}subscribeManagePosition(e){return this.managePositionOrchestrator.addListener(e),()=>{this.unsubscribeManagePosition(e)}}unsubscribeManagePosition(e){this.managePositionOrchestrator.removeListener(e)}manageMargin(e){this.manageMarginOrchestrator.send({type:"InitiateManageMargin",payload:e})}resetManageMargin(){this.manageMarginOrchestrator.send({type:"Reset"})}getManageMarginState(){return this.manageMarginOrchestrator.getState()}subscribeManageMargin(e){return this.manageMarginOrchestrator.addListener(e)}};function ie(i,e){if(i==null)throw new Error(e||"Required value is undefined or null");return i}a(ie,"check");function Bs(i){let e=`0x${i.slice(2,66)}`,t=`0x${i.slice(66,130)}`,s=parseInt(i.slice(130,132),16);return{r:e,s:t,v:s}}a(Bs,"splitSignature");d();p();var Se=te(Tt());var E;(function(i){i.FUNDING_INITIALIZED="perpsDepositInitialized",i.FUNDING_INITIATED="perpsDepositInitiated",i.FUNDING_COMPLETED="perpsDepositCompleted",i.FUNDING_FAILED="perpsDepositFailed",i.FUNDING_PAUSED="perpsDepositPaused",i.FUNDING_RESUMED="perpsDepositResumed",i.DEPOSIT_TRANSFER_STARTED="perpsHyperunitDepositTransferStarted",i.DEPOSIT_TRANSFER_COMPLETED="perpsHyperunitDepositTransferCompleted",i.DEPOSIT_STREAM_OPERATIONS_STARTED="perpsHyperunitDepositStreamOperationsStarted",i.DEPOSIT_STREAM_OPERATIONS_COMPLETED="perpsHyperunitDepositStreamOperationsCompleted",i.DEPOSIT_SELL_SPOT_STARTED="perpsHyperunitDepositSellSpotStarted",i.DEPOSIT_SELL_SPOT_COMPLETED="perpsHyperunitDepositSellSpotCompleted",i.DEPOSIT_TRANSFER_TO_PERP_STARTED="perpsHyperunitDepositTransferToPerpStarted",i.DEPOSIT_TRANSFER_TO_PERP_COMPLETED="perpsHyperunitDepositTransferToPerpCompleted"})(E||(E={}));var x;(function(i){i.FUNDING_INITIALIZED="perpsWithdrawInitialized",i.FUNDING_COMPLETED="perpsWithdrawCompleted",i.FUNDING_FAILED="perpsWithdrawFailed",i.FUNDING_PAUSED="perpsWithdrawPaused",i.FUNDING_RESUMED="perpsWithdrawResumed",i.PERPS_TO_SPOT_STARTED="perpsHyperunitWithdrawPerpsToSpotStarted",i.PERPS_TO_SPOT_COMPLETED="perpsHyperunitWithdrawPerpsToSpotCompleted",i.BUY_ASSET_STARTED="perpsHyperunitWithdrawBuyAssetStarted",i.BUY_ASSET_COMPLETED="perpsHyperunitWithdrawBuyAssetCompleted",i.SEND_TO_WITHDRAW_ADDRESS_STARTED="perpsHyperunitWithdrawSendToWithdrawAddressStarted",i.SEND_TO_WITHDRAW_ADDRESS_COMPLETED="perpsHyperunitWithdrawSendToWithdrawAddressCompleted",i.WITHDRAW_STREAM_OPERATIONS_STARTED="perpsHyperunitWithdrawStreamOperationsStarted",i.WITHDRAW_STREAM_OPERATIONS_COMPLETED="perpsHyperunitWithdrawStreamOperationsCompleted"})(x||(x={}));var Us;(function(i){i.INITIALIZED="perpsFundingInitialized",i.INITIALIZATION_ERROR="perpsFundingInitializationError",i.BELOW_MINIMUM_INPUT_AMOUNT="perpsFundingBelowMinimumInputAmount",i.INSUFFICIENT_BALANCE="perpsFundingInsufficientBalance",i.EXCEEDS_MAXIMUM_LIMIT="perpsFundingExceedsMaximumLimit",i.FUNDABLE="perpsFundingFundable"})(Us||(Us={}));var Ns=a(()=>{let i=jt(),e=(0,Se.useCallback)((n,c)=>{i.capture(n,{data:{...c}}),n===E.FUNDING_FAILED&&m.captureError(new Error(`depositFailed: ${c.error}`),y.Perps),n===x.FUNDING_FAILED&&m.captureError(new Error(`withdrawalFailed: ${c.error}`),y.Perps)},[i]),t=(0,Se.useCallback)((n,c)=>{e(n,c)},[e]),s=(0,Se.useCallback)((n,c)=>{e(n,c)},[e]),r=(0,Se.useCallback)((n,c)=>{e(n,c)},[e]);return{reportDeposit:t,reportWithdraw:s,reportFundingUIState:r}},"useFundingAnalytics");d();p();var it=class{static{a(this,"FundingStateLogsListener")}onFundingPoolStateChange(e,t,s){switch(e.type){case"fundingFailed":m.addBreadcrumb(y.Perps,`FundingPool: ${t.type} funding failed`,w.Error,{error:e.error.message,fundingTaskState:t.getState().type});break;case"fundingStarted":case"fundingBridgingStarted":case"fundingCompleted":m.addBreadcrumb(y.Perps,`FundingPool: ${t.type} ${e.type}`,w.Info);break}}};d();p();var rt=class{static{a(this,"FundingToastListener")}onFundingPoolStateChange(e,t,s){switch(t.type){case"deposit":this.onDepositEvent(e,t);break;case"withdraw":this.onWithdrawEvent(e,t);break}}onDepositEvent(e,t){if(!t.silentToasts)switch(e.type){case"fundingStarted":this.progress(Z.t("perpsToastInitiatingFunding"));break;case"fundingBridgingStarted":break;case"fundingCompleted":this.success(Z.t("perpsToastFundsAdded"));break;case"fundingFailed":this.failed(Z.t("perpsToastFundingFailed"),e.error.message,Z.t("commandOK"),()=>{se.getState().hideToast()});break}}onWithdrawEvent(e,t){switch(e.type){case"fundingStarted":this.progress(Z.t("perpsToastInitiatingWithdrawal"));break;case"fundingBridgingStarted":break;case"fundingCompleted":this.success(Z.t("perpsToastWithdrawalComplete"));break;case"fundingFailed":this.failed(Z.t("perpsToastWithdrawalFailed"),e.error.message,Z.t("commandOK"),()=>{se.getState().hideToast()});break}}success(e){setTimeout(()=>{se.getState().success({message:e,onPress:a(()=>{se.getState().hideToast()},"onPress")})},100)}failed(e,t,s,r){setTimeout(()=>{se.getState().failed({title:e,message:t,buttonText:s,onPress:r})},100)}progress(e){setTimeout(()=>{se.getState().progress({message:e,onPress:a(()=>{se.getState().hideToast()},"onPress")})},100)}};d();p();var _s="failedFundingEvents";var nt=class{static{a(this,"FailedFundingEventsCache")}storage;listeners=[];storageKey;accountId;constructor(e,t){this.storage=e,this.accountId=t,this.storageKey=this.generateStorageKey()}async setAccountId(e){if(this.accountId===e)return;this.accountId=e,this.storageKey=this.generateStorageKey();let t=await this.getEvents();this.notifyListeners(t)}generateStorageKey(){return this.accountId?`${_s}_${this.accountId}`:_s}async addEvent(e){let t=await this.getEvents(),s={id:`${e.type}_${e.startedAt}_${e.amountUsd}`,type:e.type,amountUsd:e.amountUsd||"0",timestamp:Date.now(),startedAt:e.startedAt,errorMessage:e.getState().type==="failed"?e.getState().error?.message:void 0};t.some(n=>n.id===s.id)||(t.unshift(s),t.length>25&&t.splice(25),await this.storage.set(this.storageKey,t),this.notifyListeners(t))}async getEvents(){let e=await this.storage.get(this.storageKey);return Array.isArray(e)?e:[]}async clear(){await this.storage.remove(this.storageKey),this.notifyListeners([])}addListener(e){this.listeners.push(e)}removeListener(e){this.listeners=this.listeners.filter(t=>t!==e)}notifyListeners(e){for(let t of this.listeners)t.onFailedEventsChange(e)}};d();p();var ot=class{static{a(this,"FundingPool")}activeTasks=new Set;listeners=new Set;failedEventsCache;constructor(e){this.failedEventsCache=e}setFailedEventsCache(e){this.failedEventsCache=e}async setAccountId(e){await this.failedEventsCache?.setAccountId(e)}submit(e,t,s,r,n){e.addListener(this.taskListener),this.activeTasks.add(e),e.execute(t,s,r,n)}getActiveTasks(){return Array.from(this.activeTasks)}getFailedEventsCache(){return this.failedEventsCache}addListener(e){this.listeners.add(e)}removeListener(e){this.listeners.delete(e)}pauseTasks(){this.activeTasks.forEach(e=>e.pause())}resumeTasks(){this.activeTasks.forEach(e=>e.resume())}taskListener={onFundingTaskStateChange:a((e,t,s)=>{switch(t.type){case"fundingStarted":break;case"fundingCompleted":this.activeTasks.delete(e),e.removeListener(this.taskListener);break;case"fundingFailed":e.removeListener(this.taskListener),this.failedEventsCache?.addEvent(e);break}this.listeners.forEach(r=>r.onFundingPoolStateChange(t,e,this.getActiveTasks()))},"onFundingTaskStateChange")}};d();p();d();p();d();p();d();p();var Oi="perps_deposit_step";var at=class{static{a(this,"DepositStepCache")}storage;listeners=[];userAddress=null;constructor(e){this.storage=e}setUserAddress(e){this.userAddress=e}getKey(){if(!this.userAddress)throw new Error("User address not set");return`${Oi}_${this.userAddress}`}set(e,t){(async()=>{let s={step:e,startedAt:t||Date.now()};await this.storage.set(this.getKey(),s),this.notifyListeners(s)})()}clear(){(async()=>(await this.storage.remove(this.getKey()),this.notifyListeners(null)))()}async get(){if(!this.userAddress)return null;let e=await this.storage.get(this.getKey());if(!e)return null;let t=e;return Date.now()-t.startedAt>12e5?(this.clear(),null):t}addListener(e){this.listeners.push(e)}removeListener(e){this.listeners=this.listeners.filter(t=>t!==e)}notifyListeners(e){for(let t of this.listeners)t.onDepositStepChange(e)}};d();p();function qs(i){return i.type==="idle"?"idle":i.type==="streamOperations"?`${i.sourceTxHash}:${i.depositAddress}`:`${i.type}:${i.depositAddress}`}a(qs,"getDepositId");var Ct=null;function Bi(i){return Ct||(Ct=new at(i)),Ct}a(Bi,"getDepositStepCache");var ct=class{static{a(this,"DepositRecoverer")}perps;cache;analytics;constructor(e,t,s){this.perps=e,this.cache=Bi(t),this.perps.user&&this.cache.setUserAddress(P(this.perps.user)),this.analytics=s}async getStuckDeposit(){this.perps.user&&this.cache.setUserAddress(P(this.perps.user));let e=await this.cache.get();return e?.step.type==="transfer"?(this.cache.clear(),null):e}async retry(e){if(e.type!=="streamOperations"){this.cache.clear();return}let t=qs(e);try{let s=await this.pollForOperationCompletion(e);if(!s.destinationAmount)throw this.cache.clear(),new Error("Operation has no destination amount");let{destinationAmount:r}=s,n=await this.perps.spot.getTokenMidPrice(e.spotTokenId),{totalSz:c,avgPx:l}=await this.sellSpotAsset(new f(r),e.assetId,n,e.tokenDecimals,t);await this.transferToPerps(c,l,t),this.perps.syncAccountBalance(),this.perps.syncFundingHistory(),this.cache.clear()}catch{this.cache.clear();return}}async pollForOperationCompletion(e){let r=!1;for(let n=0;n<15;n++){let c=await this.perps.client.getOperations({taker:P(this.perps.user)}),l=`${e.sourceTxHash}:${e.depositAddress}`,h=c.operations.find(u=>u.sourceTxHash===l);if(h){if(r=!0,h.state==="failure")throw new Error("Operation failed");if(h.state==="done")return h}n<14&&await new Promise(u=>setTimeout(u,5e3))}throw r?new Error("Operation not done after maximum attempts"):new Error("Operation not found")}async sellSpotAsset(e,t,s,r,n){let c=e.shiftedBy(-r).decimalPlaces(3,f.ROUND_DOWN),l=await this.perps.spot.sell(t,c.toString(),s);return this.analytics.reportDeposit(E.DEPOSIT_SELL_SPOT_COMPLETED,{depositId:n,assetId:t,assetLimitPriceUsd:s,tokenDecimals:r,adjustedDepositedAmount:c}),{totalSz:new f(l.totalSz),avgPx:new f(l.avgPx)}}async transferToPerps(e,t,s){let r=e.multipliedBy(t).decimalPlaces(2,f.ROUND_DOWN).multipliedBy(.999);return await this.perps.transfer({toPerp:!0,amount:r}),this.analytics.reportDeposit(E.DEPOSIT_TRANSFER_TO_PERP_COMPLETED,{depositId:s,totalSz:e,avgPx:t,transferUsdcAmount:r}),r}};d();p();var V=class{static{a(this,"FundingTask")}startedAt;type;minimumUiAmount;amount;amountUsd;estimatedTime;fee;withdrawAddress;withdrawAddressRole;state={type:"indeterminate"};listeners=new Set;constructor(e,t,s,r,n,c){this.startedAt=Date.now(),this.type=e,this.minimumUiAmount=t,this.estimatedTime=s,this.fee=r,this.withdrawAddress=n,this.withdrawAddressRole=c}getState(){return this.state}addListener(e){this.listeners.add(e)}removeListener(e){this.listeners.delete(e)}notify(e,t){this.listeners.forEach(s=>s.onFundingTaskStateChange(this,e,t))}getWithdrawAddressAndRole(){return{withdrawAddress:this.withdrawAddress,withdrawAddressRole:this.withdrawAddressRole}}};d();p();var dt=class{static{a(this,"HyperunitDepositStateMachine")}step={type:"idle"};listeners=[];setStep(e){this.step=e}completeStep(e){let t=this.step,s=this.detectNextStep(e);if(!s){this.listeners.forEach(r=>r.onStepCompleted(this.step,void 0)),this.listeners.forEach(r=>r.onDepositCompleted());return}this.step=s,this.listeners.forEach(r=>r.onStepCompleted(t,s))}detectNextStep(e){switch(e.stepType){case"idle":return{type:"transfer",depositAddress:e.depositAddress,depositAmount:e.amount};case"transfer":if(this.step.type!=="transfer")throw new Error("Invalid step: expected transfer, got "+this.step.type);return{...this.step,type:"streamOperations",senderAddress:e.senderAddress,networkId:e.networkId,tokenDecimals:e.tokenDecimals,sourceTxHash:e.txHash,assetId:e.assetId,spotTokenId:e.spotTokenId,assetLimitPriceUsd:e.assetLimitPriceUsd};case"streamOperations":if(this.step.type!=="streamOperations")throw new Error("Invalid step: expected streamOperations, got "+this.step.type);return{...this.step,type:"sellSpotAsset",destinationAmount:e.destinationAmount};case"sellSpotAsset":if(this.step.type!=="sellSpotAsset")throw new Error("Invalid step: expected sellSpotAsset, got "+this.step.type);return{...this.step,type:"transferToPerps",totalSz:e.totalSz,avgPx:e.avgPx};case"transferToPerps":if(this.step.type!=="transferToPerps")throw new Error("Invalid step: expected transferToPerps, got "+this.step.type);return}}failStep(e){this.listeners.forEach(t=>t.onDepositFailed(this.step,e))}addListener(e){this.listeners.push(e)}removeListener(e){this.listeners=this.listeners.filter(t=>t!==e)}getStep(){return this.step}};d();p();var kt=class{static{a(this,"SolanaDepositTransfer")}sourceAddress;networkId;account;constructor(e,t,s){this.sourceAddress=e,this.networkId=t,this.account=s}async execute(e,t,s,r){let n=Pe(this.networkId),c=new Ut.Transaction().add(G.SystemProgram.transfer({fromPubkey:new G.PublicKey(this.sourceAddress),toPubkey:new G.PublicKey(t),lamports:e.toNumber()}));c=await be(c,{connection:n}),c.feePayer=new G.PublicKey(this.sourceAddress),await Lt(c,n);let l=await xe({accountIdentifier:this.account.identifier,feePayer:new G.PublicKey(this.sourceAddress),connection:n,accountSigner:r,transaction:c,pendingTransactionInput:{ownerAddress:this.sourceAddress,networkID:this.networkId,data:{signature:""},type:Ie.DappInteraction,display:{summary:{topLeft:{text:"Deposit"}}}},storage:s});return await Ee({connection:n,signature:l}),{senderAddress:this.sourceAddress,networkId:this.networkId,tokenDecimals:9,txHash:l}}},pt=class{static{a(this,"DepositTransferFactory")}create(e,t){let s=e.chainId,r=t.addresses.find(n=>n.networkID===s)?.address;if(!r)throw new Error(`No source address found for networkID: ${s}`);if(ne.isSolanaNetworkID(s))return new kt(r,s,t);throw new Error(`Unsupported chain for deposit transfer: ${s}`)}};d();p();function Ft(i){switch(i.type){case"transfer":return{depositAddress:i.depositAddress,amount:i.depositAmount.toString()};case"streamOperations":return{depositAddress:i.depositAddress,amount:i.depositAmount.toString(),networkId:i.networkId,sourceTxHash:i.sourceTxHash};case"sellSpotAsset":return{depositAddress:i.depositAddress,amount:i.depositAmount.toString(),networkId:i.networkId,sourceTxHash:i.sourceTxHash,destinationAmount:i.destinationAmount.toString()};case"transferToPerps":return{depositAddress:i.depositAddress,amount:i.depositAmount.toString(),networkId:i.networkId,sourceTxHash:i.sourceTxHash,destinationAmount:i.destinationAmount.toString(),totalSz:i.totalSz.toString(),avgPx:i.avgPx.toString()};default:return{step:i.type}}}a(Ft,"getDepositStepLogsDetails");var Dt=a(i=>{switch(i.type){case"perpsToSpot":case"buyAsset":return{assetId:i.assetId.toString(),withdrawAddress:i.withdrawAddress,withdrawAmountUsd:i.withdrawAmountUsd.toString()};case"sendToWithdrawAddress":return{assetId:i.assetId.toString(),withdrawAddress:i.withdrawAddress,withdrawAmountUsd:i.withdrawAmountUsd.toString(),assetMidPrice:i.assetMidPrice.toString(),filledAmount:i.filledAmount.toString()};case"streamOperations":return{assetId:i.assetId.toString(),withdrawAddress:i.withdrawAddress,withdrawAmountUsd:i.withdrawAmountUsd.toString(),sendToWithdrawAmount:i.sendToWithdrawAmount.toString(),operationStartTime:i.operationStartTime.toISOString()};default:return{step:i.type}}},"getWithdrawStepLogsDetails");d();p();var me=class{static{a(this,"OperationsStreamer")}perpsClient;streamOpen=!1;listeners=[];interval=2e3;constructor(e){this.perpsClient=e}startStream(e,t,s){this.streamOpen=!0,this.stream(P(e),t,s)}startWithdrawStream(e,t,s){this.streamOpen=!0,this.streamWithdraw(P(e),t,s)}stream(e,t,s){this.streamOpen&&(async()=>{try{let r=await this.perpsClient.getOperations({taker:e}),n=`${t}:${s}`,c=r.operations.find(l=>l.sourceTxHash===n);this.listeners.forEach(l=>{l.onOperation(r,c)}),this.streamOpen&&setTimeout(()=>this.stream(e,t,s),this.interval)}catch(r){this.listeners.forEach(n=>{n.onError(r)}),this.stopStream()}})()}streamWithdraw(e,t,s){this.streamOpen&&(async()=>{try{let r=await this.perpsClient.getOperations({taker:e}),n=this.findMatchingWithdrawOperation(r.operations,t,s);this.listeners.forEach(c=>{c.onOperation(r,n)}),this.streamOpen&&setTimeout(()=>this.streamWithdraw(e,t,s),this.interval)}catch(r){this.listeners.forEach(n=>{n.onError(r)}),this.stopStream()}})()}findMatchingWithdrawOperation(e,t,s){let r=e.filter(n=>{if(n.sourceChain!=="hyperliquid"||n.destinationChain!=="solana"||!n.opCreatedAt)return!1;let c=new Date(n.opCreatedAt).getTime(),l=Math.abs(c-t.getTime()),h=4*60*1e3;if(l>h)return!1;if(n.sourceAmount){let u=new f(n.sourceAmount).dividedBy(10**Ce.data.decimals),S=s,A=u.minus(S).abs(),T=S.multipliedBy(.1);if(A.isGreaterThan(T))return!1}return!0});if(r.length!==0)return r.sort((n,c)=>new Date(c.opCreatedAt).getTime()-new Date(n.opCreatedAt).getTime())[0]}stopStream(){this.streamOpen=!1}subscribe(e){return this.listeners.push(e),()=>this.unsubscribe(e)}unsubscribe(e){this.listeners=this.listeners.filter(t=>t!==e)}};var ht=class i extends V{static{a(this,"HyperunitDepositTask")}perps;assetId;spotTokenId;depositTokenCaip19;account;depositAddress;storage;signer;stateMachine=new dt;depositTransferFactory=new pt;operationsStreamer;depositRecoverer;fundingState="active";analytics;depositId;constructor(e,t,s,r,n,c,l,h,u,S,A,T,I){super("deposit",e,t,s),this.perps=r,this.assetId=n,this.spotTokenId=c,this.depositTokenCaip19=l,this.account=h,this.depositAddress=u,this.storage=S,this.signer=A,this.analytics=T,this.stateMachine.addListener(this.stateMachineListener),this.stateMachine.addListener(this.stateLogsListener),this.operationsStreamer=new me(this.perps.client),this.depositRecoverer=new ct(this.perps,this.storage,this.analytics),this.perps.user&&this.depositRecoverer.cache.setUserAddress(P(this.perps.user)),this.depositId=I||de(),this.reportAnalytics(E.FUNDING_INITIALIZED,{})}reportAnalytics(e,t){let s={fundingType:"deposit",fundingRoute:X.Hyperunit,amount:this.amount,amountUsd:this.amountUsd,fee:this.fee.toString(),estimatedTime:this.estimatedTime,assetId:this.assetId,spotTokenId:this.spotTokenId,depositTokenCaip19:P(this.depositTokenCaip19),depositAddress:this.depositAddress,depositId:this.depositId};this.analytics.reportDeposit(e,{...s,...t})}stateMachineListener={onStepCompleted:a((e,t)=>{this.fundingState!=="paused"&&(e.type==="transfer"&&this.notify({type:"fundingBridgingStarted",estimateTime:this.estimatedTime},this.state),t&&(this.depositRecoverer.cache.set(t,this.startedAt),this.executeStep(t)))},"onStepCompleted"),onDepositCompleted:a(()=>{this.depositRecoverer.cache.clear(),this.stateMachine.removeListener(this.stateMachineListener),this.state={type:"completed"},this.notify({type:"fundingCompleted"},this.state),this.reportAnalytics(E.FUNDING_COMPLETED,{})},"onDepositCompleted"),onDepositFailed:a((e,t)=>{console.error(`Deposit failed at step: ${e.type}`,t),this.operationsStreamer.stopStream(),this.operationsStreamer.unsubscribe(this.operationsStreamListener),this.stateMachine.removeListener(this.stateMachineListener),this.state={type:"failed",error:t},this.notify({type:"fundingFailed",error:t},this.state),this.reportAnalytics(E.FUNDING_FAILED,{error:JSON.stringify(t)})},"onDepositFailed")};stateLogsListener={onStepCompleted:a((e,t)=>{m.addBreadcrumb(y.Perps,`Deposit step completed: ${e.type}`,w.Info,{...Ft(e),amountUsd:this.amountUsd??""})},"onStepCompleted"),onDepositCompleted:a(()=>{this.stateMachine.removeListener(this.stateLogsListener)},"onDepositCompleted"),onDepositFailed:a((e,t)=>{m.addBreadcrumb(y.Perps,`Deposit failed at step: ${e.type}`,w.Error,{error:t instanceof Error?t.message:"Unknown error",...Ft(e),amountUsd:this.amountUsd??""}),this.stateMachine.removeListener(this.stateLogsListener)},"onDepositFailed")};execute(e,t,s,r){if(this.amount=s,this.amountUsd=t,this.state={type:"executing",task:this},this.notify({type:"fundingStarted"},this.state),r){this.stateMachine.setStep(r.state),this.stateMachine.completeStep(r.completedStep);return}this.stateMachine.completeStep({stepType:"idle",depositAddress:this.depositAddress,amount:e})}pause(){this.fundingState="paused",this.operationsStreamer.stopStream(),this.operationsStreamer.unsubscribe(this.operationsStreamListener),this.reportAnalytics(E.FUNDING_PAUSED,{})}resume(){this.fundingState="active";let e=this.stateMachine.getStep();e.type==="streamOperations"&&((async()=>{try{if(!this.perps.user)return;let t=await this.perps.client.getOperations({taker:P(this.perps.user)}),s=`${e.sourceTxHash}:${e.depositAddress}`,r=t.operations.find(n=>n.sourceTxHash===s);r&&r.state==="done"?this.processOperation(r):this.executeStep(e)}catch{this.executeStep(e)}})(),this.reportAnalytics(E.FUNDING_RESUMED,{}))}executeStep(e){(async()=>{try{switch(e.type){case"transfer":this.reportAnalytics(E.DEPOSIT_TRANSFER_STARTED,{...e});let{senderAddress:t,networkId:s,tokenDecimals:r,txHash:n}=await this.transfer(e.depositAmount),c=await this.perps.spot.getTokenMidPrice(this.spotTokenId);this.stateMachine.completeStep({stepType:"transfer",senderAddress:t,networkId:s,tokenDecimals:r,txHash:n,assetId:this.assetId,spotTokenId:this.spotTokenId,assetLimitPriceUsd:c}),this.reportAnalytics(E.DEPOSIT_TRANSFER_COMPLETED,{...e,senderAddress:t,networkId:s,tokenDecimals:r,txHash:n,assetLimitPriceUsd:c});break;case"streamOperations":this.reportAnalytics(E.DEPOSIT_STREAM_OPERATIONS_STARTED,{...e}),this.startOperationsStream(e.sourceTxHash,e.depositAddress),this.reportAnalytics(E.DEPOSIT_STREAM_OPERATIONS_COMPLETED,{...e});break;case"sellSpotAsset":this.reportAnalytics(E.DEPOSIT_SELL_SPOT_STARTED,{...e});let l=await this.sellSpotAsset(e.depositAmount,e.tokenDecimals);this.stateMachine.completeStep({stepType:"sellSpotAsset",...l}),this.reportAnalytics(E.DEPOSIT_SELL_SPOT_COMPLETED,{...e,...l});break;case"transferToPerps":this.reportAnalytics(E.DEPOSIT_TRANSFER_TO_PERP_STARTED,{...e});let h=await this.transferToPerps(e.totalSz,e.avgPx);this.stateMachine.completeStep({stepType:"transferToPerps",transferUsdcAmount:h}),this.reportAnalytics(E.DEPOSIT_TRANSFER_TO_PERP_COMPLETED,{...e,transferUsdcAmount:h});break}}catch(t){this.stateMachine.failStep(t)}})()}async transfer(e){return await this.depositTransferFactory.create(this.depositTokenCaip19,this.account).execute(e,this.depositAddress,this.storage,this.signer)}startOperationsStream(e,t){if(this.operationsStreamer.subscribe(this.operationsStreamListener),!this.perps.user)throw new Error("No perps user");this.operationsStreamer.startStream(this.perps.user,e,t)}operationsStreamListener={onOperation:a((e,t)=>{t&&this.processOperation(t)},"onOperation"),onError:a(e=>{this.operationsStreamer.unsubscribe(this.operationsStreamListener),this.stateMachine.failStep(e)},"onError")};processOperation(e){if(e.state==="failure"){this.stateMachine.failStep(new Error("Operation failed"));return}if(e.state==="done"){if(this.operationsStreamer.unsubscribe(this.operationsStreamListener),this.operationsStreamer.stopStream(),!e.destinationAmount)throw new Error("Destination amount is required");this.stateMachine.completeStep({stepType:"streamOperations",destinationAmount:new f(e.destinationAmount)})}}async sellSpotAsset(e,t){let s=e.shiftedBy(-t).decimalPlaces(3,f.ROUND_DOWN),r=await this.perps.spot.getTokenMidPrice(this.spotTokenId),n=await this.perps.spot.sell(this.assetId,s.toString(),r);return{totalSz:new f(n.totalSz),avgPx:new f(n.avgPx)}}async transferToPerps(e,t){let s=e.multipliedBy(t).decimalPlaces(2,f.ROUND_DOWN).multipliedBy(.999);return await this.perps.transfer({toPerp:!0,amount:s}),s}static create({minimumUiAmount:e,estimatedTime:t,fee:s,perps:r,assetId:n,spotTokenId:c,depositTokenCaip19:l,account:h,depositAddress:u,storage:S,signer:A,analytics:T,depositId:I}){return new i(e,t,s,r,n,c,l,h,u,S,A,T,I)}};d();p();d();p();var Hs={1:7e-4,2:6e-4,3:5e-4,4:4e-4,5:35e-5,6:3e-4,7:.0025,8:.002};d();p();var lt=class{static{a(this,"HyperunitWithdrawStateMachine")}step;constructor(e){e?this.step=e:this.step={type:"idle"}}setStep(e){this.step=e}listeners=[];completeStep(e){let t=this.step,s=this.detectNextStep(e);if(!s){this.listeners.forEach(r=>r.onStepCompleted(this.step,void 0)),this.listeners.forEach(r=>r.onWithdrawCompleted());return}this.step=s,this.listeners.forEach(r=>r.onStepCompleted(t,s))}failStep(e){this.listeners.forEach(t=>t.onWithdrawFailed(this.step,e))}detectNextStep(e){switch(e.stepType){case"idle":return{type:"perpsToSpot",withdrawAddress:e.withdrawAddress,assetId:e.assetId,estimatedTime:e.estimatedTime,withdrawAmountUsd:e.withdrawAmountUsd};case"perpsToSpot":if(this.step.type!=="perpsToSpot")throw new Error("Invalid step: expected perpsToSpot, got "+this.step.type);return{...this.step,type:"buyAsset"};case"buyAsset":if(this.step.type!=="buyAsset")throw new Error("Invalid step: expected buyAsset, got "+this.step.type);return{...this.step,type:"sendToWithdrawAddress",assetMidPrice:e.assetMidPrice,filledAmount:e.filledAmount};case"sendToWithdrawAddress":if(this.step.type!=="sendToWithdrawAddress")throw new Error("Invalid step: expected sendToWithdrawAddress, got "+this.step.type);return{...this.step,type:"streamOperations",sendToWithdrawAmount:e.sendToWithdrawAmount,operationStartTime:new Date};case"streamOperations":if(this.step.type!=="streamOperations")throw new Error("Invalid step: expected streamOperations, got "+this.step.type);return}}addListener(e){this.listeners.push(e)}removeListener(e){this.listeners=this.listeners.filter(t=>t!==e)}getStep(){return this.step}};var ut=class extends V{static{a(this,"HyperunitWithdrawTask")}withdrawAddress;withdrawAddressRole;assetId;spotTokenName;spotTokenId;perps;stateMachine=new lt;analytics;operationsStreamer;fundingState="active";constructor(e,t,s,r,n,c,l,h,u,S){super("withdraw",l,h,u),this.withdrawAddress=e,this.withdrawAddressRole=t,this.assetId=s,this.spotTokenName=r,this.spotTokenId=n,this.perps=c,this.analytics=S,this.stateMachine.addListener(this.withdrawStateMachineListener),this.stateMachine.addListener(this.stateLogsListener),this.operationsStreamer=new me(this.perps.client),this.reportAnalytics(x.FUNDING_INITIALIZED,{})}reportAnalytics(e,t){let s={fundingType:"withdraw",amount:this.amount,amountUsd:this.amountUsd,withdrawAddress:this.withdrawAddress,withdrawAddressRole:this.withdrawAddressRole,assetId:this.assetId,spotTokenName:this.spotTokenName,spotTokenId:this.spotTokenId,minimumUiAmount:this.minimumUiAmount.toString(),estimatedTime:this.estimatedTime,fee:this.fee.toString()};this.analytics.reportWithdraw(e,{...s,...t})}withdrawStateMachineListener={onStepCompleted:a((e,t)=>{this.fundingState!=="paused"&&(e.type==="sendToWithdrawAddress"&&this.notify({type:"fundingBridgingStarted",estimateTime:"4"},this.state),t&&this.executeStep(t))},"onStepCompleted"),onWithdrawCompleted:a(()=>{this.operationsStreamer.stopStream(),this.operationsStreamer.unsubscribe(this.operationsStreamListener),this.stateMachine.removeListener(this.withdrawStateMachineListener),this.state={type:"completed"},this.notify({type:"fundingCompleted"},this.state),this.reportAnalytics(x.FUNDING_COMPLETED,{})},"onWithdrawCompleted"),onWithdrawFailed:a((e,t)=>{console.error(`Withdraw failed at step: ${e.type}`,t),this.operationsStreamer.stopStream(),this.operationsStreamer.unsubscribe(this.operationsStreamListener),this.stateMachine.removeListener(this.withdrawStateMachineListener),this.state={type:"failed",error:t},this.notify({type:"fundingFailed",error:t},this.state),this.reportAnalytics(x.FUNDING_FAILED,{error:JSON.stringify(t)})},"onWithdrawFailed")};stateLogsListener={onStepCompleted:a((e,t)=>{m.addBreadcrumb(y.Perps,`Withdraw step completed: ${e.type}`,w.Info,{...Dt(e),amountUsd:this.amountUsd??""})},"onStepCompleted"),onWithdrawCompleted:a(()=>{this.stateMachine.removeListener(this.stateLogsListener)},"onWithdrawCompleted"),onWithdrawFailed:a((e,t)=>{m.addBreadcrumb(y.Perps,`Withdraw failed at step: ${e.type}`,w.Error,{error:t instanceof Error?t.message:"Unknown error",...Dt(e),amountUsd:this.amountUsd??""}),this.stateMachine.removeListener(this.stateLogsListener)},"onWithdrawFailed")};pause(){this.fundingState="paused",this.operationsStreamer.stopStream(),this.operationsStreamer.unsubscribe(this.operationsStreamListener),this.reportAnalytics(x.FUNDING_PAUSED,{})}resume(){this.fundingState="active";let e=this.stateMachine.getStep();e.type==="streamOperations"&&(this.perps.user&&this.executeStep(e),this.reportAnalytics(x.FUNDING_RESUMED,{}))}execute(e,t,s,r){if(this.amount=s,this.amountUsd=t,this.state={type:"executing",task:this},this.notify({type:"fundingStarted"},this.state),r){this.stateMachine.setStep(r.state),this.stateMachine.completeStep(r.completedStep);return}this.stateMachine.completeStep({stepType:"idle",withdrawAddress:this.withdrawAddress,assetId:this.assetId,estimatedTime:this.estimatedTime??"",withdrawAmountUsd:e})}executeStep(e){(async()=>{try{switch(e.type){case"perpsToSpot":this.reportAnalytics(x.PERPS_TO_SPOT_STARTED,e),await this.transferToSpot(e.withdrawAmountUsd),this.reportAnalytics(x.PERPS_TO_SPOT_COMPLETED,e);break;case"buyAsset":this.reportAnalytics(x.BUY_ASSET_STARTED,e),await this.buyAsset(e.assetId,e.withdrawAmountUsd),this.reportAnalytics(x.BUY_ASSET_COMPLETED,e);break;case"sendToWithdrawAddress":this.reportAnalytics(x.SEND_TO_WITHDRAW_ADDRESS_STARTED,e),await this.sendToWithdrawAddress(this.spotTokenName,this.spotTokenId,e.filledAmount),this.reportAnalytics(x.SEND_TO_WITHDRAW_ADDRESS_COMPLETED,e);break;case"streamOperations":this.reportAnalytics(x.WITHDRAW_STREAM_OPERATIONS_STARTED,e),this.startOperationsStream(e),this.reportAnalytics(x.WITHDRAW_STREAM_OPERATIONS_COMPLETED,e);break}}catch(t){this.stateMachine.failStep(t)}})()}async transferToSpot(e){let t=this.withdrawAddressRole==="missing"?new f(1):new f(0);await this.perps.transfer({toPerp:!1,amount:e.minus(t)}),this.perps.syncAccountBalance(),this.perps.syncFundingHistory(),this.stateMachine.completeStep({stepType:"perpsToSpot"})}async buyAsset(e,t){let s=await this.perps.spot.getTokenMidPrice(this.spotTokenId),r=t.dividedBy(s.multipliedBy(et)).decimalPlaces(3),n=await this.perps.spot.buy(e,r.toString(),s),c=Hs[1];this.stateMachine.completeStep({stepType:"buyAsset",assetMidPrice:s,filledAmount:new f(n.totalSz).multipliedBy(1-c)})}async sendToWithdrawAddress(e,t,s){let r=this.fee.dividedBy(10**Ce.data.decimals),n=s.minus(r).decimalPlaces(3,f.ROUND_DOWN);await this.perps.spot.send(e,t,n,this.withdrawAddress),this.stateMachine.completeStep({stepType:"sendToWithdrawAddress",sendToWithdrawAmount:n})}startOperationsStream(e){if(e.type!=="streamOperations")throw new Error("Invalid step type for operations stream");if(this.operationsStreamer.subscribe(this.operationsStreamListener),!this.perps.user)throw new Error("No perps user");this.operationsStreamer.startWithdrawStream(this.perps.user,e.operationStartTime,e.sendToWithdrawAmount)}operationsStreamListener={onOperation:a((e,t)=>{t&&this.processOperation(t)},"onOperation"),onError:a(e=>{this.operationsStreamer.unsubscribe(this.operationsStreamListener),this.stateMachine.failStep(e)},"onError")};processOperation(e){if(e.state==="failure"){this.stateMachine.failStep(new Error("Withdrawal operation failed"));return}e.state==="done"&&(this.operationsStreamer.unsubscribe(this.operationsStreamListener),this.operationsStreamer.stopStream(),this.stateMachine.completeStep({stepType:"streamOperations"}))}getWithdrawAddressAndRole(){return{withdrawAddress:this.withdrawAddress,withdrawAddressRole:this.withdrawAddressRole}}};var gt=class{static{a(this,"HyperunitFundingTaskFactory")}analytics;constructor(e){this.analytics=e}async createTask(e,t,s,r,n,c,l,h){switch(h.type){case"deposit":return this.createDepositTask(e,t,h.depositTokenCaip19,l,n,c,h.depositId);case"withdraw":return this.createWithdrawTask(e,h.withdrawNetworkId,t)}}async createDepositTask(e,t,s,r,n,c,l){let{fundingCaip19Address:h,spotAssetId:u,eta:S,minimumAmount:A,spotTokenId:T,fee:I}=await e.client.postFunding({type:"deposit",taker:P(r),originChain:s.chainId}),D=this.checkCaip19Address(h);return ht.create({minimumUiAmount:new f(A),estimatedTime:S,fee:new f(I),perps:e,assetId:u,spotTokenId:T,depositTokenCaip19:s,account:t,depositAddress:D,storage:n,signer:c,analytics:this.analytics,depositId:l})}async createWithdrawTask(e,t,s){let r=s.addresses.find(D=>D.networkID===t);if(!r)throw new Error("Couldn't find destination account address for network: "+t);let{fundingCaip19Address:n,spotAssetId:c,eta:l,minimumAmount:h,spotTokenName:u,spotTokenId:S,fee:A}=await e.client.postFunding({type:"withdraw",taker:P({resourceType:L.address,chainId:r.networkID,address:r.address}),originChain:t}),T=this.checkCaip19Address(n),I=await e.client.getUserRole(T);return new ut(T,I.role,c,u,S,e,new f(h),l,new f(A),this.analytics)}checkCaip19Address(e){let t=qt(e);if(t.resourceType!==L.address)throw new Error("Funding CAIP19 is not an address");return t.address}};d();p();var Rt=class extends V{static{a(this,"MockFundingTask")}shouldFail;constructor(e,t=!1){super(e,new f(.01),"1m",new f(8471530)),this.shouldFail=t}execute(e,t,s){this.amount=s,this.amountUsd=t,this.state={type:"executing",task:this},this.notify({type:"fundingStarted"},this.state),setTimeout(()=>{if(this.notify({type:"fundingBridgingStarted",estimateTime:this.estimatedTime},this.state),this.shouldFail){setTimeout(()=>{this.state={type:"failed",error:new Error("Mock funding task failed")},this.notify({type:"fundingFailed",error:new Error("Mock funding task failed")},this.state)},3e3);return}setTimeout(()=>{this.state={type:"completed"},this.notify({type:"fundingCompleted"},this.state)},3e3)},3e3)}pause(){}resume(){}},Te=class{static{a(this,"MockFundingTaskFactory")}createTask(e,t,s,r,n,c,l,h){return Promise.resolve(new Rt(h.type,!1))}};d();p();d();p();d();p();d();p();var Ae=class{static{a(this,"RelayBridge")}account;authRepository;cashAccount;signer;solanaConnection;storage;constructor(e){this.account=e.account,this.authRepository=e.authRepository,this.cashAccount=e.cashAccount,this.signer=e.signer,this.solanaConnection=e.solanaConnection,this.storage=e.storage}getSolanaAddress(){let e=this.account.addresses.find(t=>t.addressType===re.Solana);if(!e)throw new Error("No Solana address found for account");return e.address}isCash(e){return e?.resourceType!==L.address||!this.cashAccount?!1:this.cashAccount.addressDetails.address===e.address}getTakerAddress(e){return e?.resourceType===L.address&&this.isCash(e)?e.address:this.getSolanaAddress()}getEvmAddress(){let e=this.account.addresses.find(t=>t.addressType===re.EVM);if(!e)throw new Error("No EVM address found for account");return e.address}async fetchQuotes(e){let t=this.getTakerAddress(e.fromTokenOwner),s=Ht("kill-cash-perps-quote-chain-addresses"),r=this.getEvmAddress(),n=this.isCash(e.fromTokenOwner),c=this.account.addresses.reduce((h,u)=>({...h,[u.networkID]:u.address}),{}),l={sellToken:e.fromToken,buyToken:e.toToken,taker:{chainId:e.fromChain,address:t,resourceType:L.address},takerDestination:{chainId:e.toChain,address:r.toLowerCase(),resourceType:L.address},sellAmount:e.amount.toString(),slippageTolerance:(e.slippageBps??100)/100,phantomCashAccount:n,chainAddresses:s?void 0:c};m.addBreadcrumb(y.Perps,"Fetching Relay quotes",w.Info,{sellAmount:l.sellAmount,sellToken:P(l.sellToken),buyToken:P(l.buyToken),fromChain:l.sellToken.chainId,toChain:l.buyToken.chainId});try{let h=await C.api().retry(1,F(1e3,1e3)).post("/swap/v2/quotes",l);if(h.status!==200)throw new Error(`Failed to fetch quotes: ${h.status}`);let u=h.data;return m.addBreadcrumb(y.Perps,"Relay quotes fetched",w.Info,{quotesCount:u.quotes.length,firstQuoteBuyAmount:u.quotes[0]?.buyAmount}),u.quotes}catch(h){throw m.addBreadcrumb(y.Perps,"Failed to fetch Relay quotes",w.Error,{error:h instanceof Error?h.message:"Unknown error"}),h}}async executeSwap(e,t,s=pe.Mainnet){let r=this.getTakerAddress(t),n=this.isCash(t),c=await Ui(r,e,this.solanaConnection);try{m.addBreadcrumb(y.Perps,"Executing Relay swap",w.Info,{buyAmount:e.buyAmount,sellAmount:e.sellAmount});let l=de(),h=await this.authRepository?.getUser();if(!h)throw new Error("User not found for swap");let{accessToken:u,userID:S}=h,A;return n?A=await Yt({unsignedTransaction:Mt(c),vaultProxy:this.signer,accountIdentifier:this.account.identifier,signerAddress:r,idempotencyKey:l,isCash:!0,accessToken:u,userID:S,skipActivityRecording:!1,swapInfo:void 0,perpsInfo:{type:"funding"},waitForActivityState:Qt.Completed}):(A=await xe({accountIdentifier:this.account.identifier,accountSigner:this.signer,transaction:c,feePayer:new G.PublicKey(r),connection:this.solanaConnection,storage:this.storage,pendingTransactionInput:{ownerAddress:r,networkID:s,data:{signature:""},type:Ie.DappInteraction,display:{summary:{topLeft:{text:"Deposit"}}}}}),await Ee({connection:this.solanaConnection,signature:A})),m.addBreadcrumb(y.Perps,"Relay swap transaction sent",w.Info,{signature:A}),A}catch(l){throw m.addBreadcrumb(y.Perps,"Failed to send Relay swap transaction",w.Error,{error:l instanceof Error?l.message:"Unknown error"}),l}}};async function Ui(i,e,t){let s=vt(e.steps[0]?.transactionData,"bs58");s=await be(s,{connection:t});let r=new G.PublicKey(i);return await Ot(s,t),Bt(s,r),s}a(Ui,"transactionFromQuote");d();p();var Ni=o.object({status:o.enum(["waiting","success","failure","refund","delayed","pending"]),requestId:o.string().optional()}),ce=class{static{a(this,"RelayBridgeStatusPoller")}pollInterval=null;listeners=new Set;POLL_INTERVAL_MS=1e3;MAX_POLL_ATTEMPTS=45;pollAttempts=0;subscribe(e){this.listeners.add(e)}unsubscribe(e){this.listeners.delete(e)}startPolling(e){this.pollAttempts=0,this.poll(e)}stopPolling(){this.pollInterval&&(clearTimeout(this.pollInterval),this.pollInterval=null)}async poll(e){this.pollAttempts++;try{let t=await this.fetchBridgeStatus(e);if(this.listeners.forEach(s=>s.onStatusUpdate(t)),t.status==="success"){m.addBreadcrumb(y.Perps,`Relay bridge completed for request: ${e}`,w.Info,{requestId:e}),this.listeners.forEach(s=>s.onCompleted(t)),this.stopPolling();return}if(t.status==="failure"||t.status==="refund"){let s=new Error(`Relay bridge failed with status: ${t.status} for request: ${e}`);m.addBreadcrumb(y.Perps,"Relay bridge failed",w.Error,{requestId:e,status:t.status}),this.listeners.forEach(r=>r.onError(s)),this.stopPolling();return}if(t.status!=="waiting"&&t.status!=="pending"&&t.status!=="delayed"){let s=new Error(`Unexpected Relay bridge status: ${t.status} for request: ${e}`);m.addBreadcrumb(y.Perps,"Relay bridge unexpected status",w.Error,{requestId:e,status:t.status}),this.listeners.forEach(r=>r.onError(s)),this.stopPolling();return}if(this.pollAttempts>=this.MAX_POLL_ATTEMPTS){let s=new Error(`Relay bridge status polling timed out with status: ${t.status} for request: ${e}`);m.addBreadcrumb(y.Perps,"Relay bridge polling timeout",w.Error,{requestId:e,finalStatus:t.status,attempts:this.pollAttempts}),this.listeners.forEach(r=>r.onError(s)),this.stopPolling();return}this.pollInterval=setTimeout(()=>{this.poll(e)},this.POLL_INTERVAL_MS)}catch(t){m.addBreadcrumb(y.Perps,`Error polling Relay bridge status for request: ${e}`,w.Error,{error:t instanceof Error?t.message:"Unknown error",requestId:e,attempts:this.pollAttempts}),this.listeners.forEach(s=>s.onError(t)),this.stopPolling()}}async fetchBridgeStatus(e){let t=await C.api().retry(1,F(1e3,1e3)).get("/swap/v2/spot/get-intents-status",{params:{requestId:e}});if(!v(t))throw new Error("Failed to get bridge status: response is not okay");let s=t.data,r=Ni.safeParse(s);if(!r.success)throw new Error("Failed to get bridge status: schema validation failed");return r.data}};var zs=250,_i=.05,mt=class i extends V{static{a(this,"RelayBridgeTask")}perps;account;authRepository;cashAccount;signer;storage;fromToken;fromTokenOwner;fromTokenDecimals;toToken;toTokenDecimals;fromChain;toChain;relayBridge;connection;bridgeListeners=new Set;quote;isFetchingQuote=!1;statusPoller;analytics;depositId;constructor(e,t,s,r,n,c,l,h,u,S,A,T,I,D,b,H,_){super("deposit",e,"",t),this.perps=s,this.account=r,this.authRepository=n,this.cashAccount=c,this.signer=l,this.storage=h,this.fromToken=u,this.fromTokenOwner=S,this.fromTokenDecimals=A,this.toToken=T,this.toTokenDecimals=I,this.fromChain=D,this.toChain=b,this.analytics=H,this.depositId=_||de(),this.connection=Pe(pe.Mainnet),this.relayBridge=new Ae({account:r,authRepository:n,cashAccount:c,signer:l,solanaConnection:this.connection,storage:h}),this.statusPoller=new ce,this.reportAnalytics(E.FUNDING_INITIALIZED,{})}reportAnalytics(e,t){let s={fundingType:"deposit",fundingRoute:X.Relay,amount:this.amount,amountUsd:this.amountUsd,fee:this.fee.toString(),estimatedTime:this.estimatedTime,fromToken:P(this.fromToken),toToken:P(this.toToken),fromChain:this.fromChain,toChain:this.toChain,depositId:this.depositId};this.analytics.reportDeposit(e,{...s,...t})}addBridgeListener(e){this.bridgeListeners.add(e)}removeBridgeListener(e){this.bridgeListeners.delete(e)}notifyBridgeListeners(e,...t){this.bridgeListeners.forEach(s=>{let r=s[e];typeof r=="function"&&r.call(s,...t)})}async fetchQuote(e,t){this.isFetchingQuote=!0;try{let s=e.shiftedBy(this.fromTokenDecimals),r=await this.relayBridge.fetchQuotes({amount:s.toNumber(),fromToken:this.fromToken,fromTokenOwner:this.fromTokenOwner,toToken:this.toToken,fromChain:this.fromChain,toChain:this.toChain,slippageBps:zs});return r.length===0?(this.isFetchingQuote=!1,null):(this.quote=r[0],this.fee=new f(this.quote.steps[0]?.feeCosts?.[0]?.value??_i),m.addBreadcrumb(y.Perps,"Relay quote fetched",w.Info,{inputAmount:e.toString(),tokenPrice:t.toString(),inputUsd:e.toString(),outputUsd:e.toString(),feeUsd:this.fee.toString(),buyAmount:this.quote.buyAmount,sellAmount:this.quote.sellAmount,fromTokenDecimals:this.fromTokenDecimals,toTokenDecimals:this.toTokenDecimals}),this.notifyBridgeListeners("onQuoteFetched",this.quote),this.quote)}catch(s){return m.addBreadcrumb(y.Perps,"Failed to fetch Relay quote",w.Info,{error:s instanceof Error?s.message:"Unknown error"}),this.isFetchingQuote=!1,null}finally{this.isFetchingQuote=!1}}async execute(e,t,s){this.startedAt=Date.now(),this.amount=s,this.amountUsd=t,this.state={type:"executing",task:this},this.notify({type:"fundingStarted"},this.state),this.reportAnalytics(E.FUNDING_INITIATED,{});try{m.addBreadcrumb(y.Perps,"Fetching Relay bridge quotes",w.Info,{amount:s,fromChain:this.fromChain,toChain:this.toChain});let r=new f(s).shiftedBy(this.fromTokenDecimals),n=await this.relayBridge.fetchQuotes({amount:r.toNumber(),fromToken:this.fromToken,fromTokenOwner:this.fromTokenOwner,toToken:this.toToken,fromChain:this.fromChain,toChain:this.toChain,slippageBps:zs});if(n.length===0)throw new Error("No quotes available for bridge");this.quote=n[0],this.notifyBridgeListeners("onQuoteFetched",this.quote),this.notify({type:"fundingBridgingStarted"},this.state),this.notifyBridgeListeners("onBridgeStarted"),m.addBreadcrumb(y.Perps,"Executing Relay bridge swap",w.Info,{buyAmount:this.quote.buyAmount,sellAmount:this.quote.sellAmount});let c=await this.relayBridge.executeSwap(this.quote,this.fromTokenOwner);m.addBreadcrumb(y.Perps,"Relay bridge transaction submitted",w.Info,{txHash:c}),this.notifyBridgeListeners("onBridgeCompleted",c);let l=this.quote.steps[0].id;if(!l)throw new Error("No request ID found in Relay quote");this.startPollingForCompletion(l)}catch(r){let n=r;this.state={type:"failed",error:n},this.notify({type:"fundingFailed",error:n},this.state),this.notifyBridgeListeners("onBridgeFailed",n),m.addBreadcrumb(y.Perps,"Relay bridge failed",w.Error,{error:n.message}),this.reportAnalytics(E.FUNDING_FAILED,{error:JSON.stringify(n)})}}pause(){this.statusPoller.stopPolling(),m.addBreadcrumb(y.Perps,"Relay bridge pause requested - stopped polling",w.Info),this.reportAnalytics(E.FUNDING_PAUSED,{})}resume(){m.addBreadcrumb(y.Perps,"Relay bridge resume requested (no-op)",w.Info),this.reportAnalytics(E.FUNDING_RESUMED,{})}getFee(){return this.fee}startPollingForCompletion(e){let t={onStatusUpdate:a(s=>{m.addBreadcrumb(y.Perps,"Relay bridge status update",w.Info,{requestId:e,status:s.status})},"onStatusUpdate"),onCompleted:a(s=>{this.state={type:"completed"},this.notify({type:"fundingCompleted"},this.state),m.addBreadcrumb(y.Perps,"Relay bridge funds received",w.Info,{requestId:e}),this.reportAnalytics(E.FUNDING_COMPLETED,{}),this.perps.syncAccountBalance(),this.perps.syncFundingHistory(),this.statusPoller.unsubscribe(t)},"onCompleted"),onError:a(s=>{m.addBreadcrumb(y.Perps,"Relay bridge polling error",w.Error,{error:s.message,requestId:e}),this.statusPoller.unsubscribe(t),this.reportAnalytics(E.FUNDING_FAILED,{error:JSON.stringify(s)})},"onError")};this.statusPoller.subscribe(t),this.statusPoller.startPolling(e)}static create({minimumUiAmount:e,fee:t,perps:s,account:r,authRepository:n,cashAccount:c,signer:l,storage:h,fromToken:u,fromTokenOwner:S,fromTokenDecimals:A,toToken:T,toTokenDecimals:I,fromChain:D,toChain:b,analytics:H,depositId:_}){return new i(e,t,s,r,n,c,l,h,u,S,A,T,I,D,b,H,_)}};d();p();var ft=class extends V{static{a(this,"RelayWithdrawTask")}withdrawNetworkId;toTokenDecimals;perps;analytics;statusPoller;requestId;toTokenCaip19;fundingCaip19Address;constructor(e,t,s,r,n,c,l,h,u,S){super("withdraw",r,n,c,h,"user"),this.withdrawNetworkId=e,this.toTokenDecimals=t,this.perps=s,this.analytics=l,this.toTokenCaip19=u,this.fundingCaip19Address=S.fundingCaip19Address,this.statusPoller=new ce,this.reportAnalytics(x.FUNDING_INITIALIZED,{provider:X.Relay})}reportAnalytics(e,t){let s={fundingType:"withdraw",fundingRoute:X.Relay,amount:this.amount,amountUsd:this.amountUsd,withdrawAddress:this.withdrawAddress??"",withdrawNetworkId:this.withdrawNetworkId,minimumUiAmount:this.minimumUiAmount.toString(),estimatedTime:this.estimatedTime,fee:this.fee.toString()};this.analytics.reportWithdraw(e,{...s,...t})}pause(){this.statusPoller.stopPolling(),m.addBreadcrumb(y.Perps,"Relay withdrawal pause requested - stopped polling",w.Info),this.reportAnalytics(x.FUNDING_PAUSED,{})}resume(){m.addBreadcrumb(y.Perps,"Relay withdrawal resume requested (no-op)",w.Info),this.reportAnalytics(x.FUNDING_RESUMED,{})}async execute(e,t,s,r){this.amount=s,this.amountUsd=t,this.state={type:"executing",task:this},this.notify({type:"fundingStarted"},this.state);try{if(m.addBreadcrumb(y.Perps,"Starting relay withdrawal",w.Info,{amount:s,amountUsd:t,withdrawAddress:this.withdrawAddress??""}),this.reportAnalytics(x.FUNDING_INITIALIZED,{}),!this.perps.user)throw new Error("No perps user available");let n=P(this.toTokenCaip19),c=e.shiftedBy(this.toTokenDecimals??8).toFixed(0),l=P({chainId:this.withdrawNetworkId,resourceType:L.address,address:this.withdrawAddress??""});m.addBreadcrumb(y.Perps,"Initializing relay bridge for withdrawal",w.Info,{sellAmount:c,buyToken:n,takerDestination:l});let h=await this.perps.client.getSpotBridgeInitialize({buyToken:n,sellAmount:c,takerDestination:l,bridgeProvider:X.Relay});this.requestId=h.requestId;let u=h.depositAddress.address;m.addBreadcrumb(y.Perps,"Relay bridge initialized",w.Info,{requestId:this.requestId,depositAddress:u}),this.notify({type:"fundingBridgingStarted",estimateTime:this.estimatedTime},this.state),m.addBreadcrumb(y.Perps,"Sending USDC from perps to relay deposit address",w.Info,{depositAddress:u,amount:e.toString()}),this.reportAnalytics(x.SEND_TO_WITHDRAW_ADDRESS_STARTED,{depositAddress:u,requestId:this.requestId}),await this.perps.usdSendPerps({destination:u,amount:e}),this.perps.syncAccountBalance(),this.perps.syncFundingHistory(),m.addBreadcrumb(y.Perps,"Sent USDC from perps to relay deposit address",w.Info,{depositAddress:u,amount:e.toString()}),this.reportAnalytics(x.SEND_TO_WITHDRAW_ADDRESS_COMPLETED,{depositAddress:u}),this.startPollingForCompletion(this.requestId)}catch(n){let c=n instanceof Error?n:new Error("Unknown error");m.addBreadcrumb(y.Perps,"Relay withdrawal failed",w.Error,{error:c.message}),this.state={type:"failed",error:c},this.notify({type:"fundingFailed",error:c},this.state),this.reportAnalytics(x.FUNDING_FAILED,{error:c.message})}}startPollingForCompletion(e){let t={onStatusUpdate:a(s=>{m.addBreadcrumb(y.Perps,"Relay withdrawal status update",w.Info,{requestId:e,status:s.status})},"onStatusUpdate"),onCompleted:a(s=>{this.state={type:"completed"},this.notify({type:"fundingCompleted"},this.state),m.addBreadcrumb(y.Perps,"Relay withdrawal completed",w.Info,{requestId:e}),this.reportAnalytics(x.FUNDING_COMPLETED,{requestId:e}),this.perps.syncAccountBalance(),this.perps.syncFundingHistory(),this.statusPoller.unsubscribe(t)},"onCompleted"),onError:a(s=>{m.addBreadcrumb(y.Perps,"Relay withdrawal polling error",w.Error,{error:s.message,requestId:e}),this.statusPoller.unsubscribe(t),this.reportAnalytics(x.FUNDING_FAILED,{error:JSON.stringify(s)})},"onError")};this.statusPoller.subscribe(t),this.statusPoller.startPolling(e)}};var qi=5,Hi={chainId:ye.Mainnet,address:"0x00000000000000000000000000000000",resourceType:L.address},zi=8,yt=class{static{a(this,"RelayBridgeFundingTaskFactory")}analytics;constructor(e){this.analytics=e}async createWithdrawTask(e,t,s){let r=t.addresses.find(u=>u.networkID===s);if(!r)throw new Error("Couldn't find destination account address for network: "+s);let n=r.address,c={chainId:s,resourceType:L.nativeToken,slip44:ne.getSlip44(s)},l={chainId:s,resourceType:L.address,address:n},h=await e.client.postFunding({type:"withdraw",taker:P(l),originChain:s});return new ft(s,zi,e,new f(h.minimumAmount),"5 seconds",new f(h.fee),this.analytics,n,c,{fundingCaip19Address:h.fundingCaip19Address})}async fetchTokenInfo(e,t,s,r,n){let c=e.addresses.find(T=>T.networkID===s);if(!c)throw new Error("Couldn't find result address for network: "+s);let l=new Jt,h={type:"swap",network:s,sellCaip19:P(r),buyCaip19:"solana:101/nativeToken:501",takerCaip19:n?P(n):void 0,takerDestinationCaip19:void 0},u=Xt(t),S=await l.initialize(h,[c],u);if(!S.sellTokenPrice?.usd)throw new Error("No price available for token");let A=S.sellToken;return{priceUsd:new f(S.sellTokenPrice.usd),decimals:A.data.decimals}}async createTask(e,t,s,r,n,c,l,h){if(h.type==="withdraw")return this.createWithdrawTask(e,t,h.withdrawNetworkId);let{depositTokenCaip19:u,depositTokenWalletCaip19:S}=h,{priceUsd:A,decimals:T}=await this.fetchTokenInfo(t,r,u.chainId,u,S),I=new f(qi).dividedBy(A);return mt.create({minimumUiAmount:I,estimatedTime:"5 seconds",fee:new f(0),perps:e,account:t,authRepository:s,cashAccount:r,signer:c,storage:n,fromToken:u,fromTokenOwner:S,fromTokenDecimals:T,toToken:Hi,toTokenDecimals:18,fromChain:pe.Mainnet,toChain:ye.Mainnet,analytics:this.analytics,depositId:h.depositId})}};var $s=(0,Q.createContext)(null),Ws=!1;function jl({fundingPoolFactory:i,children:e}){let t=Ns(),s=zt(),r=Vt(),n=$t(),c=(0,Q.useMemo)(()=>{let u;if(i)u=i.create();else{let T=new nt(s);u=new ot(T)}u.addListener(new rt),u.addListener(new it);let S=Ws?new Te:new yt(t),A=Ws?new Te:new gt(t);return new st({client:new De,isTestnet:r,fundingPool:u,relayFundingTaskFactory:S,hyperunitFundingTaskFactory:A,authRepository:n})},[i,t,s,r,n]),{data:l}=Gt();(0,Q.useEffect)(()=>{l&&c.setAccount(l)},[l,c]);let h=Wt();return(0,Q.useEffect)(()=>{c.setSigner(h)},[h,c]),Q.default.createElement($s.Provider,{value:c},e)}a(jl,"PerpsProvider");function js(){let i=(0,Q.useContext)($s);if(!i)throw new Error("usePerps must be used within a PerpsProvider");return i}a(js,"usePerpsContext");d();p();var k=te(Tt());var Ql=a(()=>{let i=js(),e=(0,k.useCallback)(()=>{i.syncAccountBalance()},[i]),[t,s]=(0,k.useState)(i.getAccountBalanceState());(0,k.useEffect)(()=>i.subscribeAccountBalanceState({onAccountBalanceStateChange:a(B=>{s(B)},"onAccountBalanceStateChange")}),[i]);let r=(0,k.useCallback)(()=>{i.syncPositions()},[i]),[n,c]=(0,k.useState)(i.getPositionsState());(0,k.useEffect)(()=>i.subscribePositions({onPositionStateChange:a(B=>{c(B)},"onPositionStateChange")}),[i]);let l=(0,k.useCallback)(()=>{i.syncPositionFees()},[i]),[h,u]=(0,k.useState)(i.getPositionFeesState());(0,k.useEffect)(()=>i.subscribePositionFees({onPositionFeesStateChange:a(B=>{u(B)},"onPositionFeesStateChange")}),[i]);let S=(0,k.useCallback)(()=>{i.syncFundingHistory()},[i]),[A,T]=(0,k.useState)(i.getFundingHistoryState());(0,k.useEffect)(()=>i.subscribeFundingHistory({onFundingHistoryStateChange:a(B=>{T(B)},"onFundingHistoryStateChange")}),[i]);let I=(0,k.useCallback)(N=>{i.syncHistoricalOrders(N)},[i]),[D,b]=(0,k.useState)(i.getHistoricalOrdersState());(0,k.useEffect)(()=>i.subscribeHistoricalOrders({onHistoricalOrdersStateChange:a(B=>{b(B)},"onHistoricalOrdersStateChange")}),[i]);let H=(0,k.useCallback)((N,B,wt,q)=>{i.syncPricing(N,B,wt,q)},[i]),_=(0,k.useCallback)(N=>{i.startSequentialPricingSync(N)},[i]),[K,M]=(0,k.useState)(i.getPricingState());(0,k.useEffect)(()=>i.subscribePricing({onPricingStateChange:a(B=>{M(B)},"onPricingStateChange")}),[i]);let Y=(0,k.useCallback)(()=>i.getAccountBalanceState(),[i]);return{isReady:i.getUser()!==void 0,accountBalanceState:t,syncAccountBalance:e,getAccountBalanceState:Y,positionsState:n,syncPositions:r,positionFeesState:h,syncPositionFees:l,fundingHistoryState:A,syncFundingHistory:S,historicalOrdersState:D,syncHistoricalOrders:I,pricingState:K,syncPricing:H,startSequentialPricingSync:_}},"usePerps");export{is as a,Fe as b,as as c,jl as d,Ql as e};
//# sourceMappingURL=chunk-HMWUXQIU.js.map
