import{a as se}from"./chunk-5SS664LD.js";import{gc as oe,ic as q,tc as ne}from"./chunk-44NW6BSR.js";import{a as I,b as H}from"./chunk-3JCRVFH6.js";import{a as te,b as w}from"./chunk-CM4ZFCT2.js";import{a as k}from"./chunk-MN377ENM.js";import{K as G,L as J,ba as X,ia as Y,ja as Q,ka as Z,oa as ee}from"./chunk-COS4XKZ5.js";import{Hc as re}from"./chunk-IJLITZAC.js";import{Ac as d,Hc as z,Ic as B,Lc as C,Uc as j,Wc as y,tc as W,uc as _,wc as $,xc as N}from"./chunk-GSVPXWLR.js";import{a as L}from"./chunk-P5BPG5MC.js";import{x as f}from"./chunk-PPQ6BNOX.js";import{a as s,g as E,i,j as m,n as c}from"./chunk-NSVULBS3.js";i();c();i();c();var R=E(k());i();c();var ge=s(e=>typeof e=="object"&&e!==null&&"localVersion"in e&&"remoteVersion"in e&&"remoteState"in e&&"eventVersions"in e,"isNamespaceState"),A=s(e=>ge(e)?e:{localVersion:0,remoteVersion:0,remoteState:null,eventVersions:{change:0,idle:0}},"parseNamespaceState");var T=s(e=>typeof e=="object"&&e!==null?e:{},"parseNamespaceItems");var U="mmkv:state:",D="mmkv:items:",M=s(e=>`${U}${e}`,"namespaceStateKey"),F=s(e=>`${D}${e}`,"namespaceItemsKey"),ue=s(e=>e.startsWith(U),"isNamespaceStateKey"),he=s(e=>e.startsWith(D),"isNamespaceItemsKey"),v=class{static{s(this,"ExtensionBackingStore")}stateCache={};itemsCache={};callbacks={};async init(t){let r=await R.default.storage.local.get([...t.map(o=>M(o.key)),...t.map(o=>F(o.key))]);for(let o of t){let n=o.key,a=M(n),l=F(n);this.stateCache[n]=A(r[a]),this.itemsCache[n]=T(r[l])}R.default.storage.local.onChanged.addListener(o=>{let n=[];for(let[a,l]of Object.entries(o))if(ue(a)){let p=a.slice(U.length);this.stateCache[p]=A(l.newValue),n.push(p)}else if(he(a)){let p=a.slice(D.length);this.itemsCache[p]=T(l.newValue)}for(let a of n)this.callbacks[a]?.forEach(p=>p(this.stateCache[a]))})}onNamespaceChange(t,r){let o=r,n=this.callbacks[t]??(this.callbacks[t]=[]);return n.push(o),()=>{n.splice(n.indexOf(o),1)}}getNamespace(t){return this.stateCache[t]??null}async setNamespace(t,r){this.stateCache[t]=r,await R.default.storage.local.set({[M(t)]:r})}getItem(t,r,o){let n=`${r}:${o}`;return(this.itemsCache[t]??{})[n]??null}async setItem(t,r,o,n){let a=`${r}:${o}`,l=this.itemsCache[t];l[a]=n,await R.default.storage.local.set({[F(t)]:l})}};i();c();var fe={enabled:!0,clientToken:m.DATADOG_CLIENT_TOKEN,applicationId:"3f3bc3b0-8d80-4b31-b4b9-9909de4d243a",service:"browser-ext-frontend",traceSampleRate:1,sessionSampleRate:1},ye={enabled:!0,dsn:"https://pub5df2cf131c51c4215f2ca3aa32d4e4b7@sentry-intake.datadoghq.com/1",sampleRate:.1,tracesSampleRate:0,initialScope:{tags:{service:"browser-ext-background",version:f}}};async function P(e,t){await d.init({appVersion:f,sentry:e==="frontend"?{enabled:!1}:ye,datadog:e==="frontend"?fe:{enabled:!1}}),t&&await d.setUser({id:t})}s(P,"initTelemetry");i();c();var V=class{static{s(this,"NetworkLogger")}requests=[];maxRequests=0;allowedDomains=["phantom.app","phantom.com"];ignoredHosts=new Set;ignoredUrls=new Set;ignoredPatterns;init(t={maxRequests:20,ignoredUrls:[],ignoredHosts:[]}){this.maxRequests=t.maxRequests,this.ignoredUrls=new Set(t.ignoredUrls),this.ignoredHosts=new Set(t.ignoredHosts);let r=self.fetch;self.fetch=async(...o)=>{let[n,a]=o,l=a?.method||"GET",p={};if(a?.headers instanceof Headers?a.headers.forEach((u,h)=>{p[h]=u}):Array.isArray(a?.headers)?a.headers.forEach(([u,h])=>{p[u]=h}):p=a?.headers||{},this.shouldIgnoreRequest(n.toString()))return r(...o);let g={id:`${Date.now()}-${Math.random()}`,method:l,url:n.toString(),requestHeaders:p,startTime:Date.now()};this.requests.length>=this.maxRequests&&this.requests.pop(),this.requests.unshift(g);let b=await r(...o),de=await b.clone().text();return g.status=b.status,g.responseHeaders={},b.headers.forEach((u,h)=>{g.responseHeaders[h]=u}),g.endTime=Date.now(),g.response=de,b}}shouldIgnoreRequest(t){try{let r=new URL(t).hostname;return this.ignoredHosts&&this.ignoredHosts.has(r)||this.ignoredUrls&&this.ignoredUrls.has(t)||!this.allowedDomains.some(o=>r.includes(o))?!0:!!(this.ignoredPatterns&&this.ignoredPatterns.some(o=>o.test(t)))}catch{return!0}}getRequests(){return this.requests}clearRequests(){this.requests=[]}setIgnoredHosts(t){this.ignoredHosts=new Set(t)}setIgnoredUrls(t){this.ignoredUrls=new Set(t)}setIgnoredPatterns(t){this.ignoredPatterns=t}clearIgnoredHosts(){this.ignoredHosts=new Set}clearIgnoredUrls(){this.ignoredUrls=new Set}clearIgnoredPatterns(){this.ignoredPatterns=void 0}},we=new V,ae=we;var S,st=s(e=>{S?.sendEvent(e)},"sendMMKVUpdateEvent"),x=s(()=>S?.getNamespace(C),"getFlagNamespace"),ie=re(e=>{x()?.updateRemoteState(t=>({overrides:t?.overrides??{},eppoConfig:t?.eppoConfig??{},userId:e})),x()?.invalidate()}),ot=s(()=>{x()?.updateRemoteState(e=>({overrides:e?.overrides??{},eppoConfig:e?.eppoConfig??{},userId:void 0})),x()?.invalidate()},"clearFlagNamespaceUserId"),Re=s(async(e,t,r)=>{if(S)return;let o={apiKey:j,deviceId:t,subjectAttributes:{appVersion:f,platform:"browser-ext",deviceId:t},pollingEnabled:e==="background",analytics:w,logTelemetry:s(n=>{d.addBreadcrumb(N.FeatureFlags,n,$.Info,{skipFileLogger:!0})},"logTelemetry"),telemetry:d};S=await W({backingStore:new v,namespaces:[C.withDeps(o),_.withDeps({legacyStorage:se}),B.withDeps({authRepository:r})],initDeadline:e==="frontend"?0:5e3}),e==="background"&&S.sendEvent("idle")},"initializeMMKV"),nt=s(async(e,t)=>{try{let r=await w.getDeviceId();await P(e,r),await Re(e,r,t),await Se(),L(r)}catch(r){await P(e),d.captureError(r,N.StartUp)}},"telemetryInitializeFeatureFlags"),Se=s(()=>{let e=y.getMultivariateAssignment("network-logger-config-json");if(e)try{let t=JSON.parse(e),r=z.parse(t);ae.init({ignoredHosts:r.ignoredHosts,maxRequests:r.maxRequests,ignoredUrls:r.ignoredUrls})}catch(t){console.error("Error initializing network logger",t)}},"initializeNetworkLogging");i();c();var me=E(k(),1);i();c();var K=E(k(),1);var be=s(async()=>{let e=q("serviceWorkerMutexAcquire",void 0),t=H(await K.default.runtime.sendMessage(I(e)));if("error"in t)throw new Error(t.error.message);return()=>{let r=q("serviceWorkerMutexRelease",void 0);K.default.runtime.sendMessage(I(r))}},"acquire"),ce=s(async e=>{let t=await be();try{return await e()}finally{t()}},"runExclusiveWithServiceWorker");i();c();var pe=E(k(),1);var le=s(async(e,t,r)=>{let o=await pe.default.identity.launchWebAuthFlow({interactive:r,url:t});if(!Z(e,o))return Q(e,o);throw new Error("Error fetching auth code")},"fetchExtensionAuthCode");var O=ne(),Ee={getClientID:ee,redirectURL:me.default.identity.getRedirectURL(),fetchAuthorizationCode:s((e,t,r)=>le(e,t,r),"fetchAuthorizationCode")},ke={storage:new te,signer:{sign:s((e,t)=>G(O,e,t),"sign"),getAuthenticationPublicKey:s(e=>O.getAuthenticationPublicKey(e),"getAuthenticationPublicKey"),getAllSecretIdentifiers:s(()=>J(O),"getAllSecretIdentifiers")},authConfig:Ee,queryClient:oe,runExclusive:ce,isLocalTokenValidityCheckEnabled:s(()=>!y.isFeatureEnabled("kill-frontend-local-check"),"isLocalTokenValidityCheckEnabled"),isServerTimeEnabled:s(()=>!y.isFeatureEnabled("kill-frontend-server-time"),"isServerTimeEnabled")},ve=Y(ke);ve.subscribe(X.UserID,e=>{w.addUserProperties({authUserId:e}),ie(e)});export{ae as a,st as b,ot as c,nt as d,Ee as e,ve as f};
//# sourceMappingURL=chunk-HQZCOMEL.js.map
