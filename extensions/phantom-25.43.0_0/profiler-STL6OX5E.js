import{Ha as F,Ia as U,R as P,ba as A,d as j,m as D,p as T,q as x,r as B}from"./chunk-Z26KXQRL.js";import{a as e,i as d,n as m}from"./chunk-NSVULBS3.js";d();m();d();m();function G(t){let r=0;for(let a of t)a.stackId!==void 0&&r++;return r}e(G,"getNumberOfSamples");d();m();var h=new Map,b=!1;function V(){b=performance.now()}e(V,"enableLongTaskRegistry");function J(){b=!1,h.clear()}e(J,"disableLongTaskRegistry");function z(t,r){h.set(r,t)}e(z,"setLongTaskId");function y(t){if(!(b===!1||t.startTime<b))return h.get(t.startTime)}e(y,"getLongTaskId");function C(t){if(!(b===!1||t<b))for(let r of h.keys())r<t&&h.delete(r)}e(C,"deleteLongTaskIdsBefore");d();m();function H({rawRumEvent:t,startTime:r}){if(t.type!=="long_task")return;let a=t.long_task.id;z(a,r)}e(H,"mayStoreLongTaskIdForProfilerCorrelation");d();m();var ie=e((t,r,a,o)=>{let p=ae(t,r,a,o),u=ce(t,p),c=r.build("fetch",u);return A("Sending profile to public profiling intake",{profilingIntakeURL:c,applicationId:a,sessionId:o}),fetch(c,{body:u.data,method:"POST"})},"sendProfile");function ae(t,r,a,o){let p=r.tags,u=ue(t,a,o),c=le(p),i=new Date(t.timeOrigin+t.startTime),w=new Date(t.timeOrigin+t.endTime);return{...u,attachments:["wall-time.json"],start:i.toISOString(),end:w.toISOString(),family:"chrome",runtime:"chrome",format:"json",version:4,tags_profiler:c.join(",")}}e(ae,"buildProfileEvent");function le(t){return t.concat(["language:javascript","runtime:chrome","family:chrome","host:browser"])}e(le,"buildProfileEventTags");function ce(t,r){let a=new Blob([JSON.stringify(t)],{type:"application/json"}),o=new FormData;return o.append("event",new Blob([JSON.stringify(r)],{type:"application/json"}),"event.json"),o.append("wall-time.json",a,"wall-time.json"),{data:o,bytesCount:0}}e(ce,"buildProfilingPayload");function ue(t,r,a){let o={application:{id:r}};a&&(o.session={id:a});let p=Array.from(new Set(t.views.map(c=>c.viewId)));p.length&&(o.view={id:p});let u=t.longTasks.map(c=>y(c)).filter(c=>c!==void 0);return u.length&&(o.long_task={id:u}),o}e(ue,"buildProfileEventAttributes");var q={sendProfile:ie};var fe={sampleIntervalMs:10,collectIntervalMs:6e4,minProfileDurationMs:5e3,minNumberOfSamples:50};function Ae(t,r,a,o=fe){let p=U(F.LONG_ANIMATION_FRAME),u,c=[],i={state:"stopped"};function w(n){i.state!=="running"&&(u=n?{startTime:n.startClocks.relative,viewId:n.id,viewName:n.name}:void 0,c.push(P(t,self,"visibilitychange",X).stop,P(t,self,"beforeunload",Y).stop),v())}e(w,"start");async function L(){await E("stopped"),J(),c.forEach(n=>n())}e(L,"stop");function K(n){if(n.state==="running")return{cleanupTasks:n.cleanupTasks,observer:n.observer};let s=[],l;if(t.trackLongTasks){l=new PerformanceObserver(W),l.observe({entryTypes:[Z()]});let f=r.subscribe(12,I=>{H(I)});V(),s.push(()=>l?.disconnect()),s.push(f.unsubscribe)}let g=r.subscribe(2,f=>{O({viewId:f.id,viewName:f.name,startTime:f.startClocks.relative})});return s.push(g.unsubscribe),{cleanupTasks:s,observer:l}}e(K,"addEventListeners");function v(){let n=D().Profiler;if(!n)throw new Error("RUM Profiler is not supported in this browser.");S(i).catch(T);let{cleanupTasks:s,observer:l}=K(i),g;try{g=new n({sampleInterval:o.sampleIntervalMs,maxBufferSize:Math.round(o.collectIntervalMs*1.5/o.sampleIntervalMs)})}catch(f){j.warn("[DD_RUM] Profiler startup failed. Ensure your server includes the `Document-Policy: js-profiling` response header when serving HTML pages.",f);return}i={state:"running",startTime:performance.now(),profiler:g,timeoutId:x(v,o.collectIntervalMs),longTasks:[],views:[],cleanupTasks:s,observer:l},O(u),g.addEventListener("samplebufferfull",M)}e(v,"startNextProfilerInstance");async function S(n){var s,l;if(n.state!=="running")return;R((l=(s=n.observer)===null||s===void 0?void 0:s.takeRecords())!==null&&l!==void 0?l:[]),B(n.timeoutId),n.profiler.removeEventListener("samplebufferfull",M);let{startTime:g,longTasks:f,views:I}=n,ne=performance.now();await n.profiler.stop().then(N=>{let _=performance.now(),re=f.length>0,oe=_-g<o.minProfileDurationMs,se=G(N.samples)<o.minNumberOfSamples;!re&&(oe||se)||(Q(Object.assign(N,{startTime:g,endTime:_,timeOrigin:performance.timeOrigin,longTasks:f,views:I,sampleInterval:o.sampleIntervalMs})),C(ne))}).catch(T)}e(S,"collectProfilerInstance");async function E(n){i.state==="running"&&(i.cleanupTasks.forEach(s=>s()),await S(i),i={state:n})}e(E,"stopProfilerInstance");function O(n){i.state!=="running"||!n||i.views.push(n)}e(O,"collectViewEntry");function Q(n){var s;let l=(s=a.findTrackedSession())===null||s===void 0?void 0:s.id;q.sendProfile(n,t.profilingEndpointBuilder,t.applicationId,l).catch(T)}e(Q,"handleProfilerTrace");function M(){v()}e(M,"handleSampleBufferFull");function W(n){R(n.getEntries())}e(W,"handlePerformance");function R(n){if(i.state==="running")for(let s of n)s.duration<o.sampleIntervalMs||i.longTasks.push({id:y(s),duration:s.duration,entryType:s.entryType,startTime:s.startTime})}e(R,"handleLongTaskEntries");function X(){document.visibilityState==="hidden"&&i.state==="running"?E("paused").catch(T):document.visibilityState==="visible"&&i.state==="paused"&&v()}e(X,"handleVisibilityChange");function Y(){v()}e(Y,"handleBeforeUnload");function Z(){return p?"long-animation-frame":"longtask"}e(Z,"getLongTaskEntryType");function $(){return i.state==="stopped"}e($,"isStopped");function ee(){return i.state==="running"}e(ee,"isRunning");function te(){return i.state==="paused"}return e(te,"isPaused"),{start:w,stop:L,isStopped:$,isRunning:ee,isPaused:te}}e(Ae,"createRumProfiler");export{fe as DEFAULT_RUM_PROFILER_CONFIGURATION,Ae as createRumProfiler};
//# sourceMappingURL=profiler-STL6OX5E.js.map
